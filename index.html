<!DOCTYPE html>
<html lang="bg" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>CondoManager Pro</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Inter"', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a' },
                        sidebar: '#1e293b'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f3f4f6; color: #1f2937; }
        
        /* Sidebar & Layout */
        .sidebar-desktop { width: 260px; height: 100vh; position: fixed; left: 0; top: 0; background: #1e293b; color: white; display: none; flex-direction: column; z-index: 50; }
        .main-content { margin-left: 0; padding-bottom: 80px; min-height: 100vh; transition: margin 0.3s; }
        
        @media (min-width: 1024px) {
            .sidebar-desktop { display: flex; }
            .main-content { margin-left: 260px; padding-bottom: 20px; }
            .bottom-nav { display: none !important; }
        }

        /* Cards */
        .admin-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .admin-header { border-bottom: 1px solid #f3f4f6; padding: 12px 16px; background: #f9fafb; border-radius: 8px 8px 0 0; }
        .admin-body { padding: 16px; }

        /* Inputs - Official Form Style */
        .form-input { 
            background-color: #fff; 
            border: 1px solid #d1d5db; 
            border-radius: 6px; 
            padding: 6px 10px; 
            font-size: 0.875rem; 
            width: 100%; 
            transition: all 0.2s;
            color: #111827;
        }
        .form-input:focus { border-color: #0d9488; outline: none; ring: 1px solid #0d9488; box-shadow: 0 0 0 1px #0d9488; }
        
        /* Table Styles */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th { background: #f9fafb; color: #4b5563; font-weight: 600; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
        .data-table td { padding: 10px; border-bottom: 1px solid #f3f4f6; font-size: 13px; vertical-align: middle; }
        .data-table tr:hover td { background-color: #f9fafb; }
        .data-table tr:last-child td { border-bottom: none; }

        /* Sticky Columns */
        .sticky-check { position: sticky; left: 0; background: white; z-index: 10; border-right: 1px solid #e5e7eb; }
        .sticky-apt { position: sticky; left: 40px; background: white; z-index: 10; border-right: 2px solid #e5e7eb; }
        tr:hover .sticky-check, tr:hover .sticky-apt { background-color: #f9fafb; }
        thead .sticky-check, thead .sticky-apt { background: #f9fafb; z-index: 20; }

        /* Badges */
        .status-badge { display: inline-flex; align-items: center; px: 2.5; py: 0.5; border-radius: 9999px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .status-paid { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        .status-unpaid { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

        /* Buttons */
        .btn-primary { background-color: #0f766e; color: white; border-radius: 6px; padding: 8px 16px; font-size: 13px; font-weight: 600; transition: bg 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-primary:hover { background-color: #115e59; }
        .btn-secondary { background-color: white; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 16px; font-size: 13px; font-weight: 600; transition: bg 0.2s; }
        .btn-secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }
        
        .btn-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s; }
        .btn-icon-unpaid { color: #9ca3af; border: 1px solid #e5e7eb; }
        .btn-icon-unpaid:hover { color: #4b5563; border-color: #9ca3af; }
        .btn-icon-paid { background: #ecfdf5; color: #059669; border: 1px solid #6ee7b7; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out; }

        /* Mobile Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 8px; display: flex; justify-content: space-around; z-index: 50; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; color: #6b7280; font-size: 10px; font-weight: 600; padding: 4px 12px; border-radius: 8px; }
        .nav-item.active { color: #0f766e; background: #f0fdfa; }
        .nav-item i { font-size: 20px; margin-bottom: 2px; }

        @media print {
            .sidebar-desktop, .bottom-nav, .no-print { display: none !important; }
            .main-content { margin: 0; padding: 0; }
            body { background: white; font-size: 11px; }
            .admin-card { box-shadow: none; border: 1px solid #ccc; }
            input { border: none !important; text-align: right; font-weight: bold; padding: 0; }
            .grid-cols-1, .grid-cols-2, .grid-cols-3, .grid-cols-4, .grid-cols-5 { display: block; }
            .fund-print-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
            .expenses-print-container { display: flex; gap: 20px; }
        }
    </style>
</head>
<body class="antialiased" id="bodyRoot">

    <aside class="sidebar-desktop no-print">
        <div class="p-6 border-b border-slate-700 flex items-center gap-3">
            <div class="w-8 h-8 bg-brand-500 rounded flex items-center justify-center text-white font-bold text-lg">7</div>
            <div>
                <h1 class="font-bold text-lg leading-tight">–ë–ª–æ–∫ 7–î</h1>
                <p class="text-xs text-slate-400">Management Pro</p>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-1">
            <a href="#" class="flex items-center gap-3 px-4 py-3 bg-slate-800 text-white rounded-lg font-medium"><i class="ri-dashboard-3-line"></i> –¢–∞–±–ª–æ</a>
            <div class="pt-4 pb-2 px-4 text-xs font-bold text-slate-500 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</div>
            <button onclick="calculate()" class="w-full flex items-center gap-3 px-4 py-2.5 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition"><i class="ri-calculator-line"></i> –ò–∑—á–∏—Å–ª–∏</button>
            <button onclick="saveData()" class="w-full flex items-center gap-3 px-4 py-2.5 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition"><i class="ri-save-3-line"></i> –ó–∞–ø–∞–∑–∏</button>
            <button onclick="generateFullReport()" class="w-full flex items-center gap-3 px-4 py-2.5 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition"><i class="ri-file-list-3-line"></i> –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –û—Ç—á–µ—Ç</button>
            
            <div class="pt-4 pb-2 px-4 text-xs font-bold text-slate-500 uppercase tracking-wider">–ö–æ–º—É–Ω–∏–∫–∞—Ü–∏—è</div>
            <button onclick="generateViberMessage()" class="w-full flex items-center gap-3 px-4 py-2.5 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition"><i class="ri-chat-3-line"></i> Viber (–û–±—â)</button>
            <button onclick="generateRepairViberReport()" class="w-full flex items-center gap-3 px-4 py-2.5 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition"><i class="ri-hammer-line"></i> Viber (–†–µ–º–æ–Ω—Ç–∏)</button>

            <div class="mt-8 px-4">
                 <button onclick="openSettings()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2"><i class="ri-settings-4-line"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-700">
            <div class="flex justify-between items-center text-xs text-slate-400">
                <span>Cloud Sync</span>
                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
            </div>
            <div class="flex gap-2 mt-2">
                <button onclick="pullFromGitHub()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-1 rounded text-xs">Pull</button>
                <button onclick="pushToGitHub()" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white py-1 rounded text-xs">Push</button>
            </div>
        </div>
    </aside>

    <div class="lg:hidden bg-white border-b border-gray-200 p-4 sticky top-0 z-40 flex justify-between items-center no-print">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white"><i class="ri-building-4-fill"></i></div>
            <span class="font-bold text-slate-800">–ë–ª–æ–∫ 7–î</span>
        </div>
        <div class="flex gap-2">
            <button onclick="pullFromGitHub()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600"><i class="ri-download-cloud-line"></i></button>
            <button onclick="pushToGitHub()" class="w-8 h-8 rounded-full bg-brand-50 flex items-center justify-center text-brand-600"><i class="ri-upload-cloud-line"></i></button>
            <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600"><i class="ri-settings-4-line"></i></button>
        </div>
    </div>

    <div class="main-content p-4 lg:p-8 animate-in">
        
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 no-print">
            <div class="admin-card px-4 py-2 flex items-center gap-4">
                <button onclick="changeYear(-1)" class="text-slate-400 hover:text-brand-600 transition"><i class="ri-arrow-left-s-line text-xl"></i></button>
                <div class="text-center cursor-pointer" onclick="document.getElementById('reportDate').showPicker()">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block">–û—Ç—á–µ—Ç–µ–Ω –ø–µ—Ä–∏–æ–¥</span>
                    <h2 class="text-xl font-bold text-slate-800" id="displayYear">2026</h2>
                    <input type="month" id="reportDate" class="hidden">
                </div>
                <button onclick="changeYear(1)" class="text-slate-400 hover:text-brand-600 transition"><i class="ri-arrow-right-s-line text-xl"></i></button>
            </div>
            
            <div class="flex gap-2">
                <span class="bg-blue-50 text-blue-700 border border-blue-200 px-3 py-1.5 rounded-md text-xs font-bold flex items-center gap-1"><i class="ri-money-euro-circle-line"></i> –û—Å–Ω–æ–≤–Ω–∞ –≤–∞–ª—É—Ç–∞: EUR</span>
                <button onclick="window.print()" class="btn-secondary hidden sm:flex items-center gap-2"><i class="ri-printer-line"></i> –ü—Ä–∏–Ω—Ç</button>
            </div>
        </div>

        <div class="hidden print-only text-center mb-6 border-b-2 border-slate-800 pb-4">
            <h1 class="text-3xl font-bold uppercase tracking-tight">–§–∏–Ω–∞–Ω—Å–æ–≤ –û—Ç—á–µ—Ç - –ë–ª–æ–∫ 7–î</h1>
            <p id="printDateLabel" class="text-lg text-slate-600 mt-2 font-medium"></p>
        </div>

        <div class="grid grid-cols-3 sm:grid-cols-6 lg:grid-cols-12 gap-2 mb-6 no-print" id="monthsGrid"></div>

        <div class="fund-print-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="admin-card p-4 border-l-4 border-rose-500">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-bold text-slate-500 uppercase">–†–µ–º–æ–Ω—Ç</span>
                    <i class="ri-tools-fill text-rose-500 bg-rose-50 p-1 rounded"></i>
                </div>
                <div class="text-2xl font-bold text-slate-800 mb-2" id="bal_repair_end">0.00 ‚Ç¨</div>
                <div class="flex items-center justify-between text-xs pt-2 border-t border-gray-100">
                   <div class="flex items-center gap-1 text-slate-400">–ù–∞—á: <input type="number" id="bal_repair_start" value="0" class="w-12 bg-transparent text-slate-600 font-bold border-b border-dotted border-slate-300 text-center focus:border-rose-500" onchange="calculate()"></div>
                   <div class="flex gap-1"><span class="text-emerald-600 bg-emerald-50 px-1 rounded">+<span id="disp_repair_col">0</span></span> <span class="text-rose-600 bg-rose-50 px-1 rounded">-<span id="disp_repair_spent">0</span></span></div>
                </div>
            </div>

            <div class="admin-card p-4 border-l-4 border-emerald-500">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-bold text-slate-500 uppercase">–ö–æ—Å–µ–Ω–µ</span>
                    <i class="ri-plant-fill text-emerald-500 bg-emerald-50 p-1 rounded"></i>
                </div>
                <div class="text-2xl font-bold text-slate-800 mb-2" id="bal_mowing_end">0.00 ‚Ç¨</div>
                <div class="flex items-center justify-between text-xs pt-2 border-t border-gray-100">
                   <div class="flex items-center gap-1 text-slate-400">–ù–∞—á: <input type="number" id="bal_mowing_start" value="0" class="w-12 bg-transparent text-slate-600 font-bold border-b border-dotted border-slate-300 text-center focus:border-emerald-500" onchange="calculate()"></div>
                   <div class="flex gap-1"><span class="text-emerald-600 bg-emerald-50 px-1 rounded">+<span id="disp_mowing_col">0</span></span> <span class="text-rose-600 bg-rose-50 px-1 rounded">-<span id="disp_mowing_spent">0</span></span></div>
                </div>
            </div>

            <div class="admin-card p-4 border-l-4 border-violet-500">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-bold text-slate-500 uppercase">–Ø–º–∞</span>
                    <i class="ri-drop-fill text-violet-500 bg-violet-50 p-1 rounded"></i>
                </div>
                <div class="text-2xl font-bold text-slate-800 mb-2" id="bal_septic_end">0.00 ‚Ç¨</div>
                <div class="flex items-center justify-between text-xs pt-2 border-t border-gray-100">
                   <div class="flex items-center gap-1 text-slate-400">–ù–∞—á: <input type="number" id="bal_septic_start" value="0" class="w-12 bg-transparent text-slate-600 font-bold border-b border-dotted border-slate-300 text-center focus:border-violet-500" onchange="calculate()"></div>
                   <div class="flex gap-1"><span class="text-emerald-600 bg-emerald-50 px-1 rounded">+<span id="disp_septic_col">0</span></span> <span class="text-rose-600 bg-rose-50 px-1 rounded">-<span id="disp_septic_spent">0</span></span></div>
                </div>
            </div>

            <div class="admin-card p-4 border-l-4 border-amber-500">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-bold text-slate-500 uppercase">–ö–æ–º–ø–ª–µ–∫—Å</span>
                    <i class="ri-community-fill text-amber-500 bg-amber-50 p-1 rounded"></i>
                </div>
                <div class="text-2xl font-bold text-slate-800 mb-2" id="bal_complex_end">0.00 ‚Ç¨</div>
                <div class="flex items-center justify-between text-xs pt-2 border-t border-gray-100">
                   <div class="flex items-center gap-1 text-slate-400">–ù–∞—á: <input type="number" id="bal_complex_start" value="0" class="w-12 bg-transparent text-slate-600 font-bold border-b border-dotted border-slate-300 text-center focus:border-amber-500" onchange="calculate()"></div>
                   <div class="flex gap-1"><span class="text-emerald-600 bg-emerald-50 px-1 rounded">+<span id="disp_complex_col">0</span></span> <span class="text-rose-600 bg-rose-50 px-1 rounded">-<span id="disp_complex_spent">0</span></span></div>
                </div>
            </div>

            <div class="admin-card bg-slate-800 text-white border-none p-4 flex flex-col justify-between relative overflow-hidden">
                <div class="absolute right-0 top-0 w-20 h-20 bg-white/5 rounded-full -mr-6 -mt-6"></div>
                <div>
                    <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wide">–ù–ê–õ–ò–ß–ù–û–°–¢ –ö–ê–°–ê</span>
                    <div class="text-3xl font-bold mt-1" id="total_cash_in_hand">0.00 ‚Ç¨</div>
                </div>
                <div class="text-[10px] text-slate-400 mt-2">–°–±–æ—Ä –Ω–∞ –≤—Å–∏—á–∫–∏ —Ñ–æ–Ω–¥–æ–≤–µ (–±–µ–∑ —Ä–∞–∑—Ö–æ–¥–∏)</div>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-6 relative no-print">
            <div class="absolute -top-3 right-0 bg-brand-50 text-brand-700 px-2 py-0.5 rounded text-[10px] font-bold border border-brand-200" id="inputHint">–í—Ö–æ–¥ (EUR)</div>
            
            <div class="admin-card">
                <div class="admin-header text-xs font-bold text-brand-700 uppercase">‚ö° –û–±—â–∏ –†–∞–∑—Ö–æ–¥–∏</div>
                <div class="admin-body space-y-3">
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–¢–æ–∫ –í—Ö–æ–¥</label><div class="flex gap-1"><input id="c_tok_vhod" type="number" value="19.21" class="form-input text-right"><button id="btn_paid_c_tok_vhod" onclick="toggleBillStatus('c_tok_vhod')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–¢–æ–∫ –ê—Å–∞–Ω—Å—å–æ—Ä</label><div class="flex gap-1"><input id="c_tok_lift" type="number" value="56.89" class="form-input text-right"><button id="btn_paid_c_tok_lift" onclick="toggleBillStatus('c_tok_lift')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–¢–æ–∫ –ê–±–æ–Ω–∞—Ç–Ω–∞</label><div class="flex gap-1"><input id="c_tok_abonatna" type="number" value="101.56" class="form-input text-right"><button id="btn_paid_c_tok_abonatna" onclick="toggleBillStatus('c_tok_abonatna')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–ú.—Ç–∞–∫—Å–∞ –ê—Å.</label><div class="flex gap-1"><input id="c_lift_month" type="number" value="75.00" class="form-input text-right"><button id="btn_paid_c_lift_month" onclick="toggleBillStatus('c_lift_month')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–ü–æ—á. –í—Ö–æ–¥</label><div class="flex gap-1"><input id="c_clean_vhod" type="number" value="140.00" class="form-input text-right"><button id="btn_paid_c_clean_vhod" onclick="toggleBillStatus('c_clean_vhod')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-header text-xs font-bold text-blue-600 uppercase">üîß –ì–æ–¥–∏—à–Ω–∏</div>
                <div class="admin-body space-y-3">
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–°–≤—ä—Ä–∑–∞–Ω–æ—Å—Ç –ê—Å.</label><div class="flex gap-1"><input id="c_lift_conn" type="number" value="72.00" class="form-input text-right" onchange="calculate()"><button id="btn_paid_c_lift_conn" onclick="toggleBillStatus('c_lift_conn')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="text-right text-[10px] text-brand-600 -mt-2 pr-10" id="hint_conn"></div>
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–¢–µ—Ö–Ω. –ø—Ä–µ–≥–ª–µ–¥</label><div class="flex gap-1"><input id="c_lift_tech" type="number" value="90.00" class="form-input text-right" onchange="calculate()"><button id="btn_paid_c_lift_tech" onclick="toggleBillStatus('c_lift_tech')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="text-right text-[10px] text-brand-600 -mt-2 pr-10" id="hint_tech"></div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-header text-xs font-bold text-amber-600 uppercase">üöó –ì–∞—Ä–∞–∂</div>
                <div class="admin-body space-y-3">
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–¢–æ–∫ –ì–∞—Ä–∞–∂</label><div class="flex gap-1"><input id="c_tok_garaj" type="number" value="60.00" class="form-input text-right"><button id="btn_paid_c_tok_garaj" onclick="toggleBillStatus('c_tok_garaj')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ</label><div class="flex gap-1"><input id="c_clean_garaj" type="number" value="175.00" class="form-input text-right"><button id="btn_paid_c_clean_garaj" onclick="toggleBillStatus('c_clean_garaj')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-header text-xs font-bold text-emerald-600 uppercase">üå± –î—Ä—É–≥–∏</div>
                <div class="admin-body space-y-3">
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–ö–æ—Å–µ–Ω–µ</label><div class="flex gap-1"><input id="c_mowing" type="number" value="100.00" class="form-input text-right"><button id="btn_paid_c_mowing" onclick="toggleBillStatus('c_mowing')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–°–µ–ø—Ç–∏—á–Ω–∞ —è–º–∞</label><div class="flex gap-1"><input id="c_septic" type="number" value="100.00" class="form-input text-right"><button id="btn_paid_c_septic" onclick="toggleBillStatus('c_septic')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–ü–æ—á. –∫–æ–º–ø–ª–µ–∫—Å</label><div class="flex gap-1"><input id="c_clean_complex" type="number" value="80.00" class="form-input text-right"><button id="btn_paid_c_clean_complex" onclick="toggleBillStatus('c_clean_complex')" class="btn-icon btn-icon-unpaid"><i class="ri-check-line"></i></button></div></div>
                    <div class="grid grid-cols-2 items-center"><label class="text-xs font-medium text-gray-500">–¢–∞–∫—Å–∞ —Ä–µ–º–æ–Ω—Ç</label><div class="flex gap-1"><input id="c_repair" type="number" value="200.00" class="form-input text-right"></div></div>
                </div>
            </div>
        </div>

        <div class="admin-card overflow-hidden">
            <div class="admin-header flex justify-between items-center">
                <h3 class="text-sm font-bold text-slate-700">üóìÔ∏è –ú–ï–°–ï–ß–ï–ù –û–¢–ß–ï–¢</h3>
                <div id="bulkActionBar" class="hidden flex items-center gap-3 animate-in">
                    <span class="text-xs font-bold text-brand-600 bg-brand-50 px-2 py-1 rounded"><span id="selectedCount">0</span> –∏–∑–±—Ä–∞–Ω–∏</span>
                    <button onclick="openBulkPayModal()" class="text-xs bg-brand-600 text-white px-3 py-1.5 rounded hover:bg-brand-700 font-medium">–ú–∞—Ä–∫–∏—Ä–∞–π –ø–ª–∞—Ç–µ–Ω–∏</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="data-table" id="mainTable">
                    <thead>
                        <tr>
                            <th class="sticky-check w-10 text-center"><input type="checkbox" id="selectAllCheckbox" class="custom-checkbox" onchange="toggleSelectAll()"></th>
                            <th class="sticky-apt w-16">–ê–ø.</th>
                            <th>–ò–º–µ</th>
                            <th class="text-center">–•–æ—Ä–∞</th>
                            <th class="text-center">–ì–∞—Ä–∞–∂</th>
                            <th class="text-center">EV</th>
                            <th class="text-right">–°–º–µ—Ç–∫–∞</th>
                            <th class="text-right text-rose-500">–°—Ç–∞—Ä–∏</th>
                            <th class="text-right">–û–ë–©–û</th>
                            <th class="text-center no-print">–°—Ç–∞—Ç—É—Å</th>
                            <th class="no-print">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100"></tbody>
                    <tfoot class="bg-gray-50 font-bold text-slate-800">
                        <tr>
                            <td class="no-print"></td>
                            <td colspan="7" class="text-right text-xs uppercase tracking-wide p-3">–¢–û–¢–ê–õ <span class="currency-symbol">‚Ç¨</span>:</td>
                            <td class="text-right text-lg text-brand-700 p-3" id="sum-grand">0.00 ‚Ç¨</td>
                            <td colspan="2" class="no-print"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="admin-card overflow-hidden">
             <div class="admin-header text-sm font-bold text-slate-700">üìä –°–™–ë–ò–†–ê–ï–ú–û–°–¢</div>
             <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th class="px-4 py-3 text-right">–î—ä–ª–∂–∏–º–∞ —Å—É–º–∞ (‚Ç¨)</th>
                            <th class="px-4 py-3 text-right">–†–µ–∞–ª–Ω–æ –°—ä–±—Ä–∞–Ω–∏ (‚Ç¨)</th>
                            <th class="px-4 py-3 text-right">–î–µ—Ñ–∏—Ü–∏—Ç / –ò–∑–ª–∏—à—ä–∫ (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 font-medium text-gray-700" id="collectionReportBody"></tbody>
                </table>
            </div>
        </div>

        <div class="expenses-print-container grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 admin-card">
                <div class="admin-header text-sm font-bold text-slate-700">üìâ –¢–ï–ö–£–©–ò –†–ê–ó–•–û–î–ò</div>
                <div class="admin-body">
                    <div class="flex gap-2 mb-4 no-print bg-gray-50 p-3 rounded border border-gray-200">
                        <input type="text" id="newExpTitle" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="form-input flex-grow">
                        <input type="number" id="newExpCost" placeholder="–°—É–º–∞" class="form-input w-24">
                        <select id="newExpType" class="form-input w-32">
                            <option value="repair">–†–µ–º–æ–Ω—Ç</option>
                            <option value="mowing">–ö–æ—Å–µ–Ω–µ</option>
                            <option value="septic">–Ø–º–∞</option>
                            <option value="complex">–ö–æ–º–ø–ª–µ–∫—Å</option>
                            <option value="other">–î—Ä—É–≥–∏</option>
                        </select>
                        <button onclick="addExpense()" class="btn-primary">OK</button>
                    </div>
                    <table class="w-full text-sm" id="expensesTable">
                        <tbody class="divide-y divide-gray-100 text-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <div class="lg:col-span-1 admin-card print-only">
                <div class="admin-header text-sm font-bold text-slate-700">üìí –ö–ê–°–û–í–ê –ö–ù–ò–ì–ê</div>
                <div class="admin-body">
                    <textarea id="persistentInfo" placeholder="–ë–µ–ª–µ–∂–∫–∏..." class="form-input h-48 resize-none"></textarea>
                </div>
            </div>
        </div>

        <div class="admin-card overflow-hidden">
            <div class="admin-header text-sm font-bold text-rose-600">üõ†Ô∏è –°–ü–†–ê–í–ö–ê: –†–ï–ú–û–ù–¢–ò</div>
            <div class="overflow-x-auto">
                <table class="data-table" id="repairsBreakdownTable">
                    <thead>
                        <tr>
                            <th class="w-16">–ê–ø.</th>
                            <th>–ò–º–µ</th>
                            <th class="text-center">% –ò–¥.–ß.</th>
                            <th class="text-right">–î—è–ª <span class="currency-symbol text-[10px]">‚Ç¨</span></th>
                            <th class="text-right bg-rose-50/50">–ü–ª–∞—Ç–∏–ª (‚Ç¨)</th>
                            <th class="text-right">–ë–∞–ª–∞–Ω—Å <span class="currency-symbol text-[10px]">‚Ç¨</span></th>
                            <th class="text-center no-print">–°—Ç–∞—Ç—É—Å</th>
                            <th class="text-left no-print">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100"></tbody>
                    <tfoot class="bg-gray-50 font-bold text-slate-800 border-t border-gray-200">
                        <tr>
                           <td colspan="3" class="px-3 py-4 text-right uppercase text-xs text-gray-500">–û–ë–©–û:</td>
                           <td class="px-3 py-4 text-right" id="rep_sum_due"></td>
                           <td class="px-3 py-4 text-right" id="rep_sum_paid"></td>
                           <td class="px-3 py-4 text-right" id="rep_sum_diff"></td>
                           <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

    </main>

    <nav class="bottom-nav lg:hidden no-print">
        <a href="#" onclick="window.scrollTo({top:0, behavior:'smooth'})" class="nav-item active"><i class="ri-dashboard-line"></i>–¢–∞–±–ª–æ</a>
        <a href="#" onclick="calculate()" class="nav-item"><i class="ri-calculator-line"></i>–°–º–µ—Ç–Ω–∏</a>
        <a href="#" onclick="saveData()" class="nav-item"><i class="ri-save-3-line"></i>–ó–∞–ø–∏—à–∏</a>
        <a href="#" onclick="generateViberMessage()" class="nav-item"><i class="ri-chat-3-line"></i>Viber</a>
    </nav>

    <div id="settingsModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in">
        <div class="admin-card w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="admin-header flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6 bg-white">
                <div class="bg-gray-50 p-4 rounded border border-gray-200">
                    <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">GitHub Sync</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <input id="gh-token" type="password" class="form-input" placeholder="Token">
                        <input id="gh-gist" type="text" class="form-input" placeholder="Gist ID">
                    </div>
                    <button onclick="saveGHCreds()" class="mt-3 btn-secondary">Save Keys</button>
                </div>
                <div>
                    <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∏</h4>
                    <div class="overflow-x-auto border border-gray-200 rounded">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-50 uppercase font-bold text-gray-500"><tr><th class="p-3">–ê–ø.</th><th class="p-3">–ò–º–µ</th><th class="p-3">–•–æ—Ä–∞</th><th class="p-3">–ì–∞—Ä–∞–∂</th><th class="p-3">% –ò–¥.–ß.</th></tr></thead>
                            <tbody id="settingsResidentsTable" class="divide-y divide-gray-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 text-right">
                <button onclick="saveSettingsAndReload()" class="btn-primary">–ó–∞–ø–∞–∑–∏ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ</button>
            </div>
        </div>
    </div>

    <div id="bulkPayModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="admin-card w-full max-w-md p-6">
            <h3 class="font-bold text-lg mb-2 text-slate-800">–ú–∞—Å–æ–≤–æ –ü–ª–∞—â–∞–Ω–µ</h3>
            <p class="text-sm text-gray-500 mb-4">–©–µ –º–∞—Ä–∫–∏—Ä–∞—Ç–µ <span id="bulkCountDisplay" class="font-bold text-slate-900">0</span> —Å–º–µ—Ç–∫–∏ –∫–∞—Ç–æ –ü–õ–ê–¢–ï–ù–ò.</p>
            <input type="text" id="bulkPayComment" class="form-input mb-4" placeholder="–ë–µ–ª–µ–∂–∫–∞ (–Ω–∞–ø—Ä. '–ë–∞–Ω–∫–æ–≤ –ø—Ä–µ–≤–æ–¥')...">
            <div class="flex gap-2">
                <button onclick="document.getElementById('bulkPayModal').classList.add('hidden')" class="btn-secondary flex-1">–û—Ç–∫–∞–∑</button>
                <button onclick="executeBulkPay()" class="btn-primary flex-1">–ü–æ—Ç–≤—ä—Ä–¥–∏</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="admin-card w-full max-w-5xl h-[85vh] flex flex-col">
            <div class="admin-header flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">–î–µ—Ç–∞–π–ª–µ–Ω –û—Ç—á–µ—Ç</h3>
                <button onclick="document.getElementById('reportModal').classList.add('hidden')" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <textarea id="reportText" class="w-full h-full p-6 bg-gray-50 text-sm font-mono resize-none focus:outline-none text-slate-700" readonly></textarea>
            <div class="p-4 border-t border-gray-200 bg-white">
                <button onclick="copyReportText()" class="w-full btn-primary py-3">–ö–æ–ø–∏—Ä–∞–π –¢–µ–∫—Å—Ç–∞</button>
            </div>
        </div>
    </div>

    <script>
        // Default Data
        const defaultApartments = [
            { name: "1.1", names: "–°—Ç–µ—Ñ–∞–Ω –î–µ—á–∫–æ–≤", parts: 5.406, people: 2, garage: 1 },
            { name: "1.2", names: "–í–∞–Ω—è –∏ –ò–≤–∞–Ω", parts: 5.248, people: 2, garage: 1 },
            { name: "1.3", names: "", parts: 4.720, people: 0, garage: 1 },
            { name: "1.4", names: "–ì–∞–±—Ä–∏–µ–ª–∞ –∏ –ù–∏–∫–æ–ª–∞", parts: 4.803, people: 2, garage: 1 },
            { name: "2.5", names: "–ê—Ç–∞–Ω–∞—Å –∏ –õ–æ—Ä–∞", parts: 7.228, people: 2, garage: 1 },
            { name: "2.6", names: "", parts: 6.662, people: 1, garage: 1 },
            { name: "2.7", names: "–ò–≤–∞–π–ª–æ –ê–Ω–≥–µ–ª–æ–≤", parts: 6.457, people: 1, garage: 1 },
            { name: "2.8", names: "–Ø–Ω–∞ –∏ –î–µ–π–≤–∏–¥", parts: 6.562, people: 2, garage: 1 },
            { name: "3.9", names: "–õ—é–±–∞ –∏ –ú–∏—Ä–æ—Å–ª–∞–≤–∞", parts: 7.228, people: 2, garage: 0 },
            { name: "3.10", names: "–ê–Ω—Ç–æ–Ω–∏—è –∏ –ú–∞—Ä—Ç–∏–Ω", parts: 6.662, people: 2, garage: 2 },
            { name: "3.11", names: "–¶–≤–µ—Ç–µ–ª–∏–Ω–∞ –°—Ç–æ—è–Ω–æ–≤–∞", parts: 6.457, people: 1, garage: 1 },
            { name: "3.12", names: "–ï–º–∏–ª–∏—è–Ω", parts: 6.562, people: 2, garage: 2 },
            { name: "4.13", names: "–ñ–æ—Ä–æ –î–µ—Å–ø–æ—Ç–æ–≤", parts: 7.510, people: 2, garage: 1 },
            { name: "4.14", names: "–ö—Ä–∏—Å–∏—è–Ω", parts: 4.907, people: 2, garage: 1 },
            { name: "4.15", names: "Yosif Danchev", parts: 10.929, people: 1, garage: 2 },
            { name: "5.16", names: "–ò–≤–∞–π–ª–æ", parts: 2.660, people: 1, garage: 0 }
        ];

        // App State
        let appConfig = { apartments: JSON.parse(JSON.stringify(defaultApartments)) };
        let expenses = [];
        let billStatus = {}; 
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        const EUR_RATE = 1.95583; 
        const GH_KEY = 'Condo_GH_Creds';
        const CONFIG_KEY = 'Condo_Config_V1';
        const currencyInputs = ['c_tok_vhod', 'c_tok_lift', 'c_tok_abonatna', 'c_lift_month', 'c_lift_conn', 'c_lift_tech', 'c_clean_vhod', 'c_tok_garaj', 'c_clean_garaj', 'c_mowing', 'c_septic', 'c_clean_complex', 'c_repair', 'bal_repair_start', 'bal_mowing_start', 'bal_septic_start', 'bal_complex_start', 'newExpCost'];
        
        let selectedApts = new Set();

        window.onload = function() {
            const savedConfig = localStorage.getItem(CONFIG_KEY);
            if(savedConfig) appConfig = JSON.parse(savedConfig);

            updateHiddenInput(); renderDatePicker();
            const c = JSON.parse(localStorage.getItem(GH_KEY) || '{}');
            document.getElementById('gh-token').value = c.token || ''; document.getElementById('gh-gist').value = c.gist || '';
            loadData(); updateMonthlyHints();
        };

        // --- CORE FUNCTIONS ---
        function toggleBillStatus(id) {
            billStatus[id] = !billStatus[id];
            renderBillStatus();
            saveData(true);
        }

        function renderBillStatus() {
            const billIds = [
                'c_tok_vhod', 'c_tok_lift', 'c_tok_abonatna', 'c_lift_month', 'c_clean_vhod',
                'c_lift_conn', 'c_lift_tech', 'c_tok_garaj', 'c_clean_garaj',
                'c_mowing', 'c_septic', 'c_clean_complex'
            ];
            
            billIds.forEach(id => {
                const btn = document.getElementById('btn_paid_' + id);
                if (btn) {
                    if (billStatus[id]) {
                        btn.className = "btn-icon btn-icon-paid";
                        btn.innerHTML = '<i class="ri-check-double-line"></i>';
                    } else {
                        btn.className = "btn-icon btn-icon-unpaid";
                        btn.innerHTML = '<i class="ri-check-line"></i>';
                    }
                }
            });
        }

        function startNewMonth() {
            if (!confirm('–ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –æ—Ç–≤–æ—Ä–∏—Ç–µ –ù–û–í –ú–ï–°–ï–¶?\n\n1. –ù–µ–ø–ª–∞—Ç–µ–Ω–∏—Ç–µ —Å—É–º–∏ —â–µ —Å—Ç–∞–Ω–∞—Ç "–°—Ç–∞—Ä–∏ –∑–∞–¥—ä–ª–∂–µ–Ω–∏—è".\n2. –ö—Ä–∞–π–Ω–∏—Ç–µ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç–∏ –Ω–∞ —Ñ–æ–Ω–¥–æ–≤–µ—Ç–µ —â–µ —Å—Ç–∞–Ω–∞—Ç –Ω–∞—á–∞–ª–Ω–∏.\n3. –°–º–µ—Ç–∫–∏—Ç–µ –∑–∞ —Ç–æ–∫ –∏ —Ä–∞–∑—Ö–æ–¥–∏—Ç–µ —â–µ —Å–µ –Ω—É–ª–∏—Ä–∞—Ç.')) return;
            calculate(); 
            const nextRows = [];
            document.querySelectorAll('#mainTable tbody tr').forEach(row => {
                const aptName = row.querySelector('.apt-fixed').value;
                const names = row.querySelector('.inp-names').value;
                const people = row.querySelector('.inp-people').value;
                const garage = row.querySelector('.inp-garage').value;
                const comment = row.querySelector('.inp-comment').value;
                // Grab total in EUR
                const totalDue = parseFloat(row.querySelector('.res-grand-total-val').value) || 0;
                const isPaid = row.querySelector('.status-select').value === 'paid';
                const newOldDebt = isPaid ? 0 : totalDue;
                nextRows.push({ name: aptName, names: names, people: people, garageCells: garage, evCost: 0, oldDebt: newOldDebt, status: 'unpaid', comment: comment, repairPaid: 0, repairStatus: 'unpaid', repairNote: '', repairName: names });
            });
            const nextInputs = {};
            currencyInputs.forEach(id => { if(document.getElementById(id)) nextInputs[id] = val(id); });
            nextInputs['bal_repair_start'] = parseFloat(document.getElementById('bal_repair_end_val').value) || 0;
            nextInputs['bal_mowing_start'] = parseFloat(document.getElementById('bal_mowing_end_val').value) || 0;
            nextInputs['bal_septic_start'] = parseFloat(document.getElementById('bal_septic_end_val').value) || 0;
            nextInputs['bal_complex_start'] = parseFloat(document.getElementById('bal_complex_end_val').value) || 0;
            if (currentMonth === 12) { currentMonth = 1; currentYear++; } else { currentMonth++; }
            const newDateKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            document.getElementById('reportDate').value = newDateKey;
            
            // New Month -> Reset bill statuses
            const newData = { rows: nextRows, inputs: nextInputs, expenses: [], info: document.getElementById('persistentInfo').value, billStatus: {} };
            localStorage.setItem(`condo_${newDateKey}`, JSON.stringify(newData));
            renderDatePicker(); loadData();
            alert(`–£—Å–ø–µ—à–Ω–æ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –º–µ—Å–µ—Ü ${newDateKey}!`);
        }

        function exportToCSV() {
            calculate(); const dateStr = document.getElementById('reportDate').value; const sym = '‚Ç¨'; 
            let csv = `\uFEFF–û–¢–ß–ï–¢ –ó–ê –ú–ï–°–ï–¶: ${dateStr},,,,,,,,\n–í–ê–õ–£–¢–ê: EUR,,,,,,,,\n\n--- –°–™–°–¢–û–Ø–ù–ò–ï –ù–ê –§–û–ù–î–û–í–ï–¢–ï ---,,,,,,,,\n–ò–º–µ,–ù–∞—á–∞–ª–æ,–°—ä–±—Ä–∞–Ω–æ,–ü–æ—Ö–∞—Ä—á–µ–Ω–æ,–ö—Ä–∞–π,,,,\n`;
            ['repair', 'mowing', 'septic', 'complex'].forEach(type => { const name = type === 'repair' ? '–†–µ–º–æ–Ω—Ç' : type === 'mowing' ? '–ö–æ—Å–µ–Ω–µ' : type === 'septic' ? '–Ø–º–∞' : '–ö–æ–º–ø–ª–µ–∫—Å'; const start = document.getElementById(`bal_${type}_start`).value; const col = document.getElementById(`disp_${type}_col_val`).value; const spent = document.getElementById(`disp_${type}_spent_val`).value; const end = document.getElementById(`bal_${type}_end_val`).value; csv += `${name},${start},${col},${spent},${end},,,,\n`; });
            csv += `\n--- –°–ü–ò–°–™–ö –° –†–ê–ó–•–û–î–ò ---,,,,,,,,\n–û–ø–∏—Å–∞–Ω–∏–µ,–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–°—É–º–∞,,,,,\n`; expenses.forEach(e => { csv += `"${e.title}",${e.type},${(e.cost).toFixed(2)},,,,,\n`; });
            csv += `\n--- –ì–õ–ê–í–ù–ê –¢–ê–ë–õ–ò–¶–ê (–°–ú–ï–¢–ö–ò) ---,,,,,,,,\n–ê–ø.,–ò–º–µ,–ñ–∏–≤—É—â–∏,–ì–∞—Ä–∞–∂,EV,–¢–µ–∫—É—â–∞ –°–º–µ—Ç–∫–∞,–°—Ç–∞—Ä –î—ä–ª–≥,–û–ë–©–û –ó–ê –ü–õ–ê–©–ê–ù–ï,–°—Ç–∞—Ç—É—Å\n`;
            document.querySelectorAll('#mainTable tbody tr').forEach(row => { const apt = row.querySelector('.apt-fixed').value; const name = row.querySelector('.inp-names').value; const people = row.querySelector('.inp-people').value; const garage = row.querySelector('.inp-garage').value; const ev = row.querySelector('.inp-ev').value; const current = row.querySelector('.res-current-val').value; const old = row.querySelector('.inp-old-debt').value; const total = row.querySelector('.res-grand-total-val').value; const statusText = row.querySelector('.status-select').options[row.querySelector('.status-select').selectedIndex].text; csv += `${apt},"${name}",${people},${garage},${ev},${current},${old},${total},${statusText}\n`; });
            csv += `\n--- –°–ü–†–ê–í–ö–ê: –†–ï–ú–û–ù–¢–ò (–ü–æ % –ò–¥. –ß–∞—Å—Ç–∏) ---,,,,,,,,\n`; csv += `–ê–ø.,–ò–º–µ,% –ò–¥.–ß.,–î—è–ª (${sym}),–ü–ª–∞—Ç–∏–ª (${sym}),–ë–∞–ª–∞–Ω—Å (${sym}),–°—Ç–∞—Ç—É—Å,–ö–æ–º–µ–Ω—Ç–∞—Ä\n`;
            document.querySelectorAll('#repairsBreakdownTable tbody tr').forEach(row => { const apt = row.cells[0].innerText.trim(); const rName = row.querySelector('.inp-repair-name').value; const pct = row.cells[2].innerText.trim(); const share = row.cells[3].innerText.trim(); const paid = row.querySelector('.inp-repair-paid').value; const bal = row.cells[5].innerText.trim(); const select = row.querySelector('select'); const status = select.options[select.selectedIndex].text; const note = row.querySelector('.inp-repair-note').value.replace(/"/g, '""'); csv += `${apt},"${rName}","${pct}","${share}","${paid}","${bal}","${status}","${note}"\n`; });
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csv); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `Full_Report_Block7D_${dateStr}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function generateFullReport() {
            calculate();
            const currencySym = '‚Ç¨'; const format = (v) => v.toFixed(2) + ' ' + currencySym + ` (${(v*EUR_RATE).toFixed(2)} –ª–≤.)`; const dateStr = document.getElementById('reportDate').value;
            const liftConnMonthly = val('c_lift_conn') / 12; const liftTechMonthly = val('c_lift_tech') / 12; const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod'); const costGarage = val('c_tok_garaj') + val('c_clean_garaj'); const costMaintenance = val('c_clean_complex') + val('c_mowing') + val('c_septic'); const costRepairs = val('c_repair'); const totalMonthlyCosts = costCommon + costGarage + costMaintenance + costRepairs;
            let totalPeople = 0, totalGarageCells = 0, totalParts = 0; document.querySelectorAll('#mainTable tbody tr').forEach(r => { totalPeople += parseFloat(r.querySelector('.inp-people').value)||0; totalGarageCells += parseFloat(r.querySelector('.inp-garage').value)||0; totalParts += parseFloat(r.querySelector('.inp-parts').value)||0; });
            const priceCommon = totalPeople > 0 ? costCommon / totalPeople : 0; const priceMaint = totalPeople > 0 ? costMaintenance / totalPeople : 0; const priceRepair = totalParts > 0 ? costRepairs / totalParts : 0; const priceGarage = totalGarageCells > 0 ? costGarage / totalGarageCells : 0;
            let collectedRepair = 0, collectedMowing = 0, collectedSeptic = 0, collectedComplex = 0;
            document.querySelectorAll('#mainTable tbody tr').forEach(r => { if(r.querySelector('.status-select').value === 'paid') { const people = parseFloat(r.querySelector('.inp-people').value)||0; const parts = parseFloat(r.querySelector('.inp-parts').value)||0; collectedRepair += parts * priceRepair; if(totalPeople > 0) { collectedMowing += people * (val('c_mowing')/totalPeople); collectedSeptic += people * (val('c_septic')/totalPeople); collectedComplex += people * (val('c_clean_complex')/totalPeople); } } });
            const getFundStatus = (type, startVal, collectedVal) => { const start = startVal; const spent = expenses.filter(e => e.type === type).reduce((sum, e) => sum + e.cost, 0); const end = start + collectedVal - spent; return `   –ù–∞—á–∞–ª–æ: ${format(start)} | +${format(collectedVal)} | -${format(spent)} | –ö—Ä–∞–π: ${format(end)}`; };
            let txt = `üè¢ –ü–™–õ–ù–ê –†–ê–ó–ë–ò–í–ö–ê –ù–ê –†–ê–ó–•–û–î–ò–¢–ï - –ë–õ–û–ö 7–î\nüóìÔ∏è –ú–µ—Å–µ—Ü: ${dateStr}\n========================================\n`;
            txt += `üìâ –û–¢–ß–ï–¢ –ù–ê –†–ê–ó–•–û–î–ò–¢–ï (–°–ú–ï–¢–ö–ò):\n1. –¢–æ–∫ –í—Ö–æ–¥: ${format(val('c_tok_vhod'))}\n2. –¢–æ–∫ –ê—Å–∞–Ω—Å—å–æ—Ä: ${format(val('c_tok_lift'))}\n3. –¢–æ–∫ –¢–æ–∫ –Ω–∞ –ê–±–æ–Ω–∞—Ç–Ω–∞: ${format(val('c_tok_abonatna'))}\n4. –ê—Å–∞–Ω—Å—å–æ—Ä (–¢–∞–∫—Å–∞): ${format(val('c_lift_month'))}\n5. –ê—Å–∞–Ω—Å—å–æ—Ä –°–≤—ä—Ä–∑–≤–∞–Ω–µ: ${format(val('c_lift_conn'))} (–ì–æ–¥.) -> ${format(liftConnMonthly)} /–º–µ—Å.\n6. –ê—Å–∞–Ω—Å—å–æ—Ä –ü—Ä–µ–≥–ª–µ–¥: ${format(val('c_lift_tech'))} (–ì–æ–¥.) -> ${format(liftTechMonthly)} /–º–µ—Å.\n7. –ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ –í—Ö–æ–¥: ${format(val('c_clean_vhod'))}\n8. –ì–∞—Ä–∞–∂ (–¢–æ–∫+–ü–æ—á): ${format(costGarage)}\n9. –ü–æ–¥–¥—Ä—ä–∂–∫–∞ (–ö–æ—Å–µ–Ω–µ/–Ø–º–∞/–ö–æ–º–ø–ª): ${format(costMaintenance)}\n----------------------------------------\n–û–ë–©–û –†–ê–ó–•–û–î–ò –ó–ê –ú–ï–°–ï–¶–ê: ${format(totalMonthlyCosts)}\n========================================\n\n`;
            txt += `üí∞ –°–™–°–¢–û–Ø–ù–ò–ï –ù–ê –§–û–ù–î–û–í–ï–¢–ï:\nüõ†Ô∏è –§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç:\n${getFundStatus('repair', val('bal_repair_start'), collectedRepair)}\nüå± –§–æ–Ω–¥ –ö–æ—Å–µ–Ω–µ:\n${getFundStatus('mowing', val('bal_mowing_start'), collectedMowing)}\nüíß –°–µ–ø—Ç–∏—á–Ω–∞ —è–º–∞:\n${getFundStatus('septic', val('bal_septic_start'), collectedSeptic)}\nüßπ –ü–æ—á. –ö–æ–º–ø–ª–µ–∫—Å:\n${getFundStatus('complex', val('bal_complex_start'), collectedComplex)}\n========================================\n\n`;
            txt += `‚ÑπÔ∏è –¢–ê–†–ò–§–ò –ó–ê –ú–ï–°–ï–¶–ê:\nüîπ –û–±—â–∏ (–¢–æ–∫/–í–æ–¥–∞/–ê—Å): ${format(priceCommon)} / —á–æ–≤–µ–∫\nüîπ –ü–æ–¥–¥—Ä—ä–∂–∫–∞ (–ö–æ—Å–µ–Ω–µ/–Ø–º–∞): ${format(priceMaint)} / —á–æ–≤–µ–∫\nüîπ –§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç: –°–ø–æ—Ä–µ–¥ % –∏–¥. —á–∞—Å—Ç–∏\nüöó –ì–∞—Ä–∞–∂: ${format(priceGarage)} / –∫–ª–µ—Ç–∫–∞\n========================================\n\n`;
            let grandTotalSum = 0; document.querySelectorAll('#mainTable tbody tr').forEach(row => { const apt = row.querySelector('.apt-fixed').value; const name = row.querySelector('.inp-names').value; const people = parseFloat(row.querySelector('.inp-people').value)||0; const garage = parseFloat(row.querySelector('.inp-garage').value)||0; const parts = parseFloat(row.querySelector('.inp-parts').value)||0; const oldDebt = valEl(row.querySelector('.inp-old-debt')); const evCost = valEl(row.querySelector('.inp-ev')); const isPaid = row.querySelector('.status-select').value === 'paid'; let aptCommon = 0, aptMaint = 0, aptRepair = 0; if(apt !== '1.3') { aptCommon = people * priceCommon; aptMaint = people * priceMaint; aptRepair = parts * priceRepair; } const aptGarage = garage * priceGarage; const totalDue = aptCommon + aptMaint + aptRepair + aptGarage + evCost + oldDebt; grandTotalSum += totalDue; txt += `üè† –ê–ü–ê–†–¢–ê–ú–ï–ù–¢ ${apt} (${name})\n   -------------------------------------\n`; if(apt === '1.3' || people === 0) { txt += `   üö´ –ù–µ–æ–±–∏—Ç–∞–µ–º (0.00 –ª–≤. –æ–±—â–∏)\n`; } else { txt += `   üë§ –û–±—â–∏ (${people} ${people === 1 ? '–∂–∏–≤—É—â' : '–∂–∏–≤—É—â–∏'}): ${format(aptCommon)}\n   üå± –ü–æ–¥–¥—Ä—ä–∂–∫–∞: ${format(aptMaint)}\n   üõ†Ô∏è –†–µ–º–æ–Ω—Ç (${parts}%): ${format(aptRepair)}\n`; } if(garage > 0) txt += `   üöó –ì–∞—Ä–∞–∂ (${garage} –±—Ä.): ${format(aptGarage)}\n`; if(evCost > 0) txt += `   üîå EV –ó–∞—Ä–µ–∂–¥–∞–Ω–µ: ${format(evCost)}\n`; if(oldDebt > 0) txt += `   ‚ö†Ô∏è –°—Ç–∞—Ä–∏ –∑–∞–¥—ä–ª–∂–µ–Ω–∏—è: ${format(oldDebt)}\n`; txt += `   üí∞ –¢–û–¢–ê–õ –î–™–õ–ñ–ò–ú–û: ${format(totalDue)}\n   üìù –°—Ç–∞—Ç—É—Å: ${isPaid ? '‚úÖ –ü–õ–ê–¢–ï–ù–û' : '‚ùå –ù–ï–ü–õ–ê–¢–ï–ù–û'}\n\n`; });
            txt += `========================================\n–ö—Ä–∞–π–Ω–∞ —Å—É–º–∞ –Ω–∞ –æ—Ç—á–µ—Ç–∞: ${format(grandTotalSum)}`;
            document.getElementById('reportText').value = txt; document.getElementById('reportModal').classList.remove('hidden');
        }

        function saveGHCreds() { localStorage.setItem(GH_KEY, JSON.stringify({token: document.getElementById('gh-token').value, gist: document.getElementById('gh-gist').value})); alert('–ö–ª—é—á–æ–≤–µ—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!'); document.getElementById('settingsModal').classList.add('hidden'); }
        async function pullFromGitHub() { const c = JSON.parse(localStorage.getItem(GH_KEY) || '{}'); if(!c.token || !c.gist) return alert("–õ–∏–ø—Å–≤–∞—Ç –∫–ª—é—á–æ–≤–µ!"); const btn = document.getElementById('btn-pull'); btn.innerHTML = `<div class="loader"></div>`; try { const req = await fetch(`https://api.github.com/gists/${c.gist}`, { headers: { 'Authorization': `token ${c.token}` } }); if(!req.ok) throw new Error("GitHub Error"); const json = await req.json(); const content = json.files['block7d.json'].content; localStorage.setItem(`condo_${document.getElementById('reportDate').value}`, JSON.stringify(JSON.parse(content))); loadData(); alert('–ò–∑—Ç–µ–≥–ª–µ–Ω–æ!'); } catch(e) { alert("–ì—Ä–µ—à–∫–∞: " + e.message); } finally { btn.innerHTML = `<i class="ri-download-cloud-2-fill"></i> –ò–ó–¢–ï–ì–õ–ò`; } }
        async function pushToGitHub() { const c = JSON.parse(localStorage.getItem(GH_KEY) || '{}'); if(!c.token || !c.gist) return alert("–õ–∏–ø—Å–≤–∞—Ç –∫–ª—é—á–æ–≤–µ!"); saveData(true); const btn = document.getElementById('btn-push'); btn.innerHTML = `<div class="loader"></div>`; try { const dataToPush = localStorage.getItem(`condo_${document.getElementById('reportDate').value}`); const req = await fetch(`https://api.github.com/gists/${c.gist}`, { method: 'PATCH', headers: { 'Authorization': `token ${c.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ files: { "block7d.json": { content: dataToPush } } }) }); if(!req.ok) throw new Error("GitHub Error"); alert('–ö–∞—á–µ–Ω–æ!'); } catch(e) { alert("–ì—Ä–µ—à–∫–∞: " + e.message); } finally { btn.innerHTML = `<i class="ri-upload-cloud-2-fill"></i> –ö–ê–ß–ò`; } }

        function val(id) { return parseFloat(document.getElementById(id).value)||0; }
        function valEl(el) { return parseFloat(el.value)||0; }
        function updateMonthlyHints() { document.getElementById('hint_conn').innerText = `(${ (val('c_lift_conn')/12).toFixed(2) }/–º)`; document.getElementById('hint_tech').innerText = `(${ (val('c_lift_tech')/12).toFixed(2) }/–º)`; }
        function renderDatePicker() { document.getElementById('displayYear').innerText = currentYear; document.getElementById('printDateLabel').innerText = `–ü–µ—Ä–∏–æ–¥: ${currentYear}-${currentMonth}`; const grid = document.getElementById('monthsGrid'); grid.innerHTML = ''; ["–Ø–Ω—É", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–Æ–Ω–∏", "–Æ–ª–∏", "–ê–≤–≥", "–°–µ–ø", "–û–∫—Ç", "–ù–æ–µ", "–î–µ–∫"].forEach((name, index) => { const btn = document.createElement('button'); btn.className = `p-2 rounded-lg text-sm font-bold transition ${index + 1 === currentMonth ? 'bg-brand-600 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}`; btn.innerText = name; btn.onclick = () => { currentMonth = index + 1; updateHiddenInput(); renderDatePicker(); loadData(); }; grid.appendChild(btn); }); }
        function changeYear(d) { currentYear += d; updateHiddenInput(); renderDatePicker(); loadData(); }
        function updateHiddenInput() { document.getElementById('reportDate').value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`; }
        
        function renderTable(savedData) {
            const tbody = document.querySelector('#mainTable tbody'); tbody.innerHTML = ''; 
            
            appConfig.apartments.forEach((fixedApt) => {
                let savedApt = savedData ? savedData.find(s => s.name === fixedApt.name) : null; const ownerNames = savedApt ? (savedApt.names || fixedApt.names) : fixedApt.names; const people = savedApt ? savedApt.people : fixedApt.people; const garageCells = savedApt ? savedApt.garageCells : fixedApt.garage; const oldDebt = (savedApt ? savedApt.oldDebt : 0); const evCost = (savedApt ? (savedApt.evCost || 0) : 0); const status = savedApt ? savedApt.status : 'unpaid'; const comment = savedApt ? savedApt.comment : '';
                const tr = document.createElement('tr'); 
                if(status === 'paid') tr.classList.add('bg-brand-50/30');
                if(selectedApts.has(fixedApt.name)) tr.classList.add('row-selected');

                tr.innerHTML = `
                    <td class="sticky-check w-10 text-center no-print">
                        <input type="checkbox" class="custom-checkbox row-checkbox" value="${fixedApt.name}" ${selectedApts.has(fixedApt.name)?'checked':''} onchange="toggleRow('${fixedApt.name}')">
                    </td>
                    <td class="sticky-apt px-3 py-2 text-center font-bold text-slate-700 w-16">
                        <button onclick="generateReport('${fixedApt.name}')" class="hover:text-brand-600 transition">${fixedApt.name}</button>
                        <input type="hidden" class="apt-fixed" value="${fixedApt.name}">
                    </td>
                    <td><input type="text" class="form-input inp-names w-full" value="${ownerNames}"></td>
                    <td class="text-center"><input type="number" class="form-input apt-fixed-input inp-people w-12 text-center" value="${people}"></td>
                    <td class="text-center"><input type="number" class="form-input apt-fixed-input inp-garage w-12 text-center" value="${garageCells}"></td>
                    <td class="text-center"><input type="number" class="form-input inp-ev w-16 text-center" value="${evCost.toFixed(2)}"></td>
                    <input type="hidden" class="inp-parts" value="${fixedApt.parts}">
                    <td class="text-right font-medium text-slate-500 res-current">0</td>
                    <input type="hidden" class="res-current-val" value="0">
                    <td class="text-right"><input type="number" class="form-input inp-old-debt w-20 text-right text-rose-600 font-bold" value="${oldDebt.toFixed(2)}"></td>
                    <td class="text-right font-black text-slate-800 res-grand-total">0</td>
                    <input type="hidden" class="res-grand-total-val" value="0">
                    <td class="text-center no-print"><select class="form-input text-xs font-bold text-center uppercase cursor-pointer ${status==='paid'?'text-emerald-700 bg-emerald-50 border-emerald-200':'text-rose-700 bg-rose-50 border-rose-200'} status-select" onchange="changeStatus(this)"><option value="unpaid" ${status==='unpaid'?'selected':''}>–ù–ï–ü–õ–ê–¢–ï–ù–û</option><option value="paid" ${status==='paid'?'selected':''}>–ü–õ–ê–¢–ï–ù–û</option></select></td>
                    <td class="no-print"><input type="text" class="form-input inp-comment w-full text-xs text-gray-500 italic" value="${comment}" placeholder="..."></td>`;
                tbody.appendChild(tr);
            });
            calculate();
        }

        function changeStatus(sel) { const row = sel.closest('tr'); if(sel.value === 'paid') { row.classList.add('bg-brand-50/30'); sel.className = "form-input text-xs font-bold text-center uppercase cursor-pointer text-emerald-700 bg-emerald-50 border-emerald-200 status-select"; } else { row.classList.remove('bg-brand-50/30'); sel.className = "form-input text-xs font-bold text-center uppercase cursor-pointer text-rose-700 bg-rose-50 border-rose-200 status-select"; } }
        
        function formatMoney(eur) {
            const bgn = eur * EUR_RATE;
            return `${eur.toFixed(2)} ‚Ç¨ <span class="text-[10px] text-gray-400 font-normal">(${bgn.toFixed(2)} –ª–≤.)</span>`;
        }

        function formatMoneyWhite(eur) {
            const bgn = eur * EUR_RATE;
            return `${eur.toFixed(2)} ‚Ç¨ <span class="text-[10px] text-slate-300 font-normal">(${bgn.toFixed(2)} –ª–≤.)</span>`;
        }

        function calculate() {
            const symbol = '‚Ç¨'; document.querySelectorAll('.currency-symbol').forEach(el => el.innerText = symbol);
            const liftConnMonthly = val('c_lift_conn')/12; const liftTechMonthly = val('c_lift_tech')/12; const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod'); const costGarage = val('c_tok_garaj') + val('c_clean_garaj'); const costMaintenance = val('c_clean_complex') + val('c_mowing') + val('c_septic'); const costRepairs = val('c_repair');
            let totalPeople = 0, totalGarageCells = 0, totalParts = 0; document.querySelectorAll('#mainTable tbody tr').forEach(row => { totalPeople += parseFloat(row.querySelector('.inp-people').value)||0; totalGarageCells += parseFloat(row.querySelector('.inp-garage').value)||0; totalParts += parseFloat(row.querySelector('.inp-parts').value)||0; });
            const priceGarageCell = totalGarageCells>0?costGarage/totalGarageCells:0; const pricePerPersonCommon = totalPeople>0?costCommon/totalPeople:0; const pricePerPersonMaint = totalPeople>0?costMaintenance/totalPeople:0; const priceRepairPart = totalParts>0?costRepairs/totalParts:0;
            let G_Grand = 0; 
            
            let sumRepair = 0;
            let sumMowing = 0;
            let sumSeptic = 0;
            let sumComplex = 0;

            document.querySelectorAll('#mainTable tbody tr').forEach(row => { const aptName = row.querySelector('.apt-fixed').value; const people = parseFloat(row.querySelector('.inp-people').value)||0; const garage = parseFloat(row.querySelector('.inp-garage').value)||0; const parts = parseFloat(row.querySelector('.inp-parts').value)||0; const debt = valEl(row.querySelector('.inp-old-debt')); const evCost = valEl(row.querySelector('.inp-ev')); const isPaid = row.querySelector('.status-select').value === 'paid'; let oweBase = 0; if(aptName !== '1.3') oweBase = (people * pricePerPersonCommon) + (people * pricePerPersonMaint) + (parts * priceRepairPart); const oweGarage = garage * priceGarageCell; const currentTotal = oweBase + oweGarage + evCost; const grandTotal = currentTotal + debt; 
            
            row.querySelector('.res-current').innerHTML = formatMoney(currentTotal); 
            row.querySelector('.res-current-val').value = currentTotal;
            row.querySelector('.res-grand-total').innerHTML = formatMoney(grandTotal); 
            row.querySelector('.res-grand-total-val').value = grandTotal;

            G_Grand += grandTotal; 
            
            if (isPaid) { 
                sumRepair += (parts * priceRepairPart);
                if(totalPeople > 0) {
                    sumMowing += (people * (val('c_mowing')/totalPeople));
                    sumSeptic += (people * (val('c_septic')/totalPeople));
                    sumComplex += (people * (val('c_clean_complex')/totalPeople));
                }
            } 
            });
            
            document.getElementById('sum-grand').innerHTML = formatMoney(G_Grand);
            updateCollectionReport();
            
            updateFundBalance('repair', sumRepair);
            updateFundBalance('mowing', sumMowing);
            updateFundBalance('septic', sumSeptic);
            updateFundBalance('complex', sumComplex);

            const totalCash = (val('bal_repair_start') + val('disp_repair_col_val')) + 
                              (val('bal_mowing_start') + val('disp_mowing_col_val')) + 
                              (val('bal_septic_start') + val('disp_septic_col_val')) + 
                              (val('bal_complex_start') + val('disp_complex_col_val'));
                              
            document.getElementById('total_cash_in_hand').innerHTML = formatMoneyWhite(totalCash);
        }

        function updateCollectionReport() {
            const sym = '‚Ç¨';
            const liftConnMonthly = val('c_lift_conn')/12; const liftTechMonthly = val('c_lift_tech')/12; const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod'); const costGarage = val('c_tok_garaj') + val('c_clean_garaj'); 
            let totalPeople = 0, totalGarageCells = 0, totalParts = 0; document.querySelectorAll('#mainTable tbody tr').forEach(row => { totalPeople += parseFloat(row.querySelector('.inp-people').value)||0; totalGarageCells += parseFloat(row.querySelector('.inp-garage').value)||0; totalParts += parseFloat(row.querySelector('.inp-parts').value)||0; });
            const priceGarageCell = totalGarageCells>0?costGarage/totalGarageCells:0; const priceCommon = totalPeople>0?costCommon/totalPeople:0; const priceMowing = totalPeople>0?val('c_mowing')/totalPeople:0; const priceSeptic = totalPeople>0?val('c_septic')/totalPeople:0; const priceComplex = totalPeople>0?val('c_clean_complex')/totalPeople:0; const priceRepair = totalParts>0?val('c_repair')/totalParts:0;
            let dueCommon=0, paidCommon=0; let dueGarage=0, paidGarage=0; let dueEV=0, paidEV=0; let dueRepair=0, paidRepair=0; let dueMowing=0, paidMowing=0; let dueSeptic=0, paidSeptic=0; let dueComplex=0, paidComplex=0;
            document.querySelectorAll('#mainTable tbody tr').forEach(row => { const aptName = row.querySelector('.apt-fixed').value; const people = parseFloat(row.querySelector('.inp-people').value)||0; const garage = parseFloat(row.querySelector('.inp-garage').value)||0; const parts = parseFloat(row.querySelector('.inp-parts').value)||0; const ev = valEl(row.querySelector('.inp-ev')); const isPaid = row.querySelector('.status-select').value === 'paid'; if(aptName !== '1.3') { dueCommon += people * priceCommon; dueRepair += parts * priceRepair; dueMowing += people * priceMowing; dueSeptic += people * priceSeptic; dueComplex += people * priceComplex; } dueGarage += garage * priceGarageCell; dueEV += ev; if(isPaid) { if(aptName !== '1.3') { paidCommon += people * priceCommon; paidRepair += parts * priceRepair; paidMowing += people * priceMowing; paidSeptic += people * priceSeptic; paidComplex += people * priceComplex; } paidGarage += garage * priceGarageCell; paidEV += ev; } });
            const rows = [ { label: '–û–±—â–∏ (–¢–æ–∫/–ê—Å/–ß–∏—Å—Ç)', due: dueCommon, paid: paidCommon }, { label: '–ì–∞—Ä–∞–∂ (–¢–æ–∫/–ü–æ—á)', due: dueGarage, paid: paidGarage }, { label: '–ï–ª. –ö–æ–ª–∏ (–ò–∑–≤—ä–Ω—Ä–µ–¥–Ω–æ)', due: dueEV, paid: paidEV }, { label: '–§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç', due: dueRepair, paid: paidRepair }, { label: '–§–æ–Ω–¥ –ö–æ—Å–µ–Ω–µ', due: dueMowing, paid: paidMowing }, { label: '–°–µ–ø—Ç–∏—á–Ω–∞ —è–º–∞', due: dueSeptic, paid: paidSeptic }, { label: '–ü–æ—á. –ö–æ–º–ø–ª–µ–∫—Å', due: dueComplex, paid: paidComplex }, ];
            const tbody = document.getElementById('collectionReportBody'); tbody.innerHTML = '';
            rows.forEach(r => { const diff = r.paid - r.due; const diffClass = diff < -0.01 ? 'text-rose-600 font-bold' : 'text-emerald-600 font-bold'; const sign = diff > 0 ? '+' : ''; tbody.innerHTML += `<tr class="hover:bg-gray-50"><td class="px-4 py-3 text-slate-700 font-medium">${r.label}</td><td class="px-4 py-3 text-right text-slate-500">${(r.due).toFixed(2)} ${sym}</td><td class="px-4 py-3 text-right text-slate-800 font-bold">${(r.paid).toFixed(2)} ${sym}</td><td class="px-4 py-3 text-right ${diffClass}">${sign}${(diff).toFixed(2)} ${sym}</td></tr>`; });
        }

        function updateFundBalance(type, collectedReal) { 
            const start = val(`bal_${type}_start`); const spent = expenses.filter(e => e.type === type).reduce((sum, e) => sum + e.cost, 0); const end = start + collectedReal - spent; 
            if(document.getElementById(`disp_${type}_col`)) {
                document.getElementById(`disp_${type}_col`).innerText = collectedReal.toFixed(0) + '‚Ç¨';
                document.getElementById(`disp_${type}_col_val`).value = collectedReal;
            }
            if(document.getElementById(`disp_${type}_spent`)) {
                document.getElementById(`disp_${type}_spent`).innerText = spent.toFixed(0) + '‚Ç¨';
                document.getElementById(`disp_${type}_spent_val`).value = spent;
            }
            if(document.getElementById(`bal_${type}_end`)) {
                document.getElementById(`bal_${type}_end`).innerText = end.toFixed(2) + ' ‚Ç¨';
                document.getElementById(`bal_${type}_end_val`).value = end;
            }
        }
        
        // Helper hidden inputs for calculations storage
        document.write(`
            <input type="hidden" id="disp_repair_col_val"><input type="hidden" id="disp_repair_spent_val"><input type="hidden" id="bal_repair_end_val">
            <input type="hidden" id="disp_mowing_col_val"><input type="hidden" id="disp_mowing_spent_val"><input type="hidden" id="bal_mowing_end_val">
            <input type="hidden" id="disp_septic_col_val"><input type="hidden" id="disp_septic_spent_val"><input type="hidden" id="bal_septic_end_val">
            <input type="hidden" id="disp_complex_col_val"><input type="hidden" id="disp_complex_spent_val"><input type="hidden" id="bal_complex_end_val">
        `);

        function addExpense() { const title = document.getElementById('newExpTitle').value; const cost = val('newExpCost'); const type = document.getElementById('newExpType').value; if(!title || isNaN(cost)) return; expenses.push({title, cost, type}); document.getElementById('newExpTitle').value = ''; document.getElementById('newExpCost').value = ''; renderExpenses(); calculate(); refreshRepairsTable(); }
        function removeExpense(idx) { expenses.splice(idx,1); renderExpenses(); calculate(); refreshRepairsTable(); }
        function renderExpenses() { const tb = document.querySelector('#expensesTable tbody'); tb.innerHTML = ''; expenses.forEach((e,i) => { tb.innerHTML += `<tr class="hover:bg-gray-50"><td class="py-2 text-slate-700">${e.title}</td><td class="text-xs text-slate-400">${e.type}</td><td class="text-right font-bold text-slate-800">${(e.cost).toFixed(2)} ‚Ç¨</td><td class="text-right no-print"><button onclick="removeExpense(${i})" class="text-rose-400 hover:text-rose-600">&times;</button></td></tr>`; }); }
        function refreshRepairsTable() { const totalRepairExpenses = expenses.filter(e => e.type === 'repair').reduce((sum, e) => sum + e.cost, 0); const savedString = localStorage.getItem(`condo_${document.getElementById('reportDate').value}`); let savedData = savedString ? JSON.parse(savedString).rows : null; renderRepairsBreakdown(totalRepairExpenses, savedData); }
        
        function renderRepairsBreakdown(totalRepairExpenses, savedData) { 
            const tbody = document.querySelector('#repairsBreakdownTable tbody'); tbody.innerHTML = ''; let totalParts = 0; appConfig.apartments.forEach(a => totalParts += a.parts); 
            let sumShare = 0; let sumPaid = 0;

            appConfig.apartments.forEach((apt) => { 
                const share = (totalRepairExpenses * apt.parts) / totalParts; 
                let paidSoFar = 0; let savedRepairStatus = 'unpaid'; let savedNote = ''; let savedName = apt.names;
                if(savedData) { 
                    const savedRow = savedData.find(r => r.name === apt.name); 
                    if(savedRow) {
                        if(savedRow.repairPaid) paidSoFar = parseFloat(savedRow.repairPaid); 
                        if(savedRow.repairStatus) savedRepairStatus = savedRow.repairStatus; 
                        if(savedRow.repairNote) savedNote = savedRow.repairNote;
                        if(savedRow.repairName) savedName = savedRow.repairName;
                    }
                } 
                const diff = share - paidSoFar; let colorClass = diff > 0.01 ? 'text-rose-500' : 'text-emerald-500'; 
                sumShare += share; sumPaid += paidSoFar;

                tbody.innerHTML += `<tr>
                    <td class="font-bold text-slate-700">${apt.name}</td>
                    <td><input type="text" class="form-input text-xs w-full" value="${savedName}" onchange="saveData(true)"></td>
                    <td class="text-center text-slate-500 text-xs">${apt.parts}%</td>
                    <td class="text-right text-xs">${(share).toFixed(2)} ‚Ç¨</td>
                    <td class="text-right"><input type="number" class="form-input w-20 text-right text-xs font-bold" value="${(paidSoFar).toFixed(2)}" onchange="saveData(true); refreshRepairsTable()"></td>
                    <td class="text-right font-bold text-xs ${colorClass}">${(diff).toFixed(2)} ‚Ç¨</td>
                    <td class="text-center no-print">
                        <select class="form-input text-[10px] font-bold uppercase cursor-pointer ${savedRepairStatus==='paid'?'text-emerald-700 bg-emerald-50 border-emerald-200':(savedRepairStatus==='partial'?'text-amber-700 bg-amber-50 border-amber-200':'text-rose-700 bg-rose-50 border-rose-200')}" onchange="updateRepairStatus(this)">
                            <option value="unpaid" ${savedRepairStatus==='unpaid'?'selected':''}>–ù–ï–ü–õ–ê–¢–ï–ù–û</option>
                            <option value="partial" ${savedRepairStatus==='partial'?'selected':''}>–ß–ê–°–¢–ò–ß–ù–û</option>
                            <option value="paid" ${savedRepairStatus==='paid'?'selected':''}>–ü–õ–ê–¢–ï–ù–û</option>
                        </select>
                    </td>
                    <td class="no-print"><input type="text" class="form-input w-full text-xs text-gray-500 italic" value="${savedNote}" placeholder="..." onchange="saveData(true)"></td>
                </tr>`; 
            }); 

            const sumDiff = sumShare - sumPaid;
            let diffColor = sumDiff > 0.01 ? 'text-rose-600' : 'text-emerald-600';
            document.getElementById('rep_sum_due').innerHTML = formatMoney(sumShare);
            document.getElementById('rep_sum_paid').innerHTML = formatMoney(sumPaid);
            document.getElementById('rep_sum_diff').innerHTML = formatMoney(sumDiff);
            document.getElementById('rep_sum_diff').className = `px-3 py-4 text-right font-black ${diffColor}`;
        }

        function updateRepairStatus(sel) { saveData(true); refreshRepairsTable(); }

        function saveData(silent = false) { 
            const rows = []; 
            document.querySelectorAll('#mainTable tbody tr').forEach(r => { 
                const aptName = r.querySelector('.apt-fixed').value; 
                let repairPaidVal = 0; let repairStatusVal = 'unpaid'; let repairNoteVal = ''; let repairNameVal = '';
                const breakdownRows = document.querySelectorAll('#repairsBreakdownTable tbody tr'); 
                for(let br of breakdownRows) { 
                    if(br.cells[0].innerText.includes(aptName)) { 
                        repairPaidVal = valEl(br.querySelector('.inp-repair-paid')); 
                        repairStatusVal = br.querySelector('select').value; 
                        repairNoteVal = br.querySelector('.inp-repair-note').value;
                        repairNameVal = br.querySelector('.inp-repair-name').value;
                        break; 
                    } 
                } 
                rows.push({ name: aptName, names: r.querySelector('.inp-names').value, people: r.querySelector('.inp-people').value, garageCells: r.querySelector('.inp-garage').value, evCost: valEl(r.querySelector('.inp-ev')), oldDebt: valEl(r.querySelector('.inp-old-debt')), status: r.querySelector('.status-select').value, comment: r.querySelector('.inp-comment').value, repairPaid: repairPaidVal, repairStatus: repairStatusVal, repairNote: repairNoteVal, repairName: repairNameVal }); 
            }); 
            const inputs = {}; currencyInputs.forEach(id => { if(document.getElementById(id)) inputs[id] = val(id); }); 
            const data = { rows, inputs, expenses, info: document.getElementById('persistentInfo').value, billStatus: billStatus }; 
            localStorage.setItem(`condo_${document.getElementById('reportDate').value}`, JSON.stringify(data)); 
            if(!silent) alert('–ó–∞–ø–∞–∑–µ–Ω–æ –ª–æ–∫–∞–ª–Ω–æ!'); 
        }

        function loadData() { 
            const key = `condo_${document.getElementById('reportDate').value}`; const stored = localStorage.getItem(key); if(stored) { const data = JSON.parse(stored); expenses = data.expenses || []; billStatus = data.billStatus || {}; renderTable(data.rows); if(data.inputs) for(let k in data.inputs) if(document.getElementById(k)) document.getElementById(k).value = data.inputs[k]; if(data.info) document.getElementById('persistentInfo').value = data.info; renderExpenses(); const totalRepairExpenses = expenses.filter(e => e.type === 'repair').reduce((sum, e) => sum + e.cost, 0); renderRepairsBreakdown(totalRepairExpenses, data.rows); renderBillStatus(); } else { expenses = []; billStatus = {}; renderTable(null); renderExpenses(); renderRepairsBreakdown(0, null); renderBillStatus(); } calculate(); 
        }

        function generateViberMessage() { calculate(); const dateStr = document.getElementById('reportDate').value; let text = `üè¢ *–ë–ª–æ–∫ 7–î | –û—Ç—á–µ—Ç ${dateStr}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`; let totalUnpaid = 0; document.querySelectorAll('#mainTable tbody tr').forEach(row => { const apt = row.querySelector('.apt-fixed').value; const name = row.querySelector('.inp-names').value.split(' ')[0]; const total = row.querySelector('.res-grand-total-val').value; const isPaid = row.querySelector('.status-select').value === 'paid'; if(!isPaid) totalUnpaid += parseFloat(total); text += `${isPaid ? '‚úÖ' : 'üî¥'} –ê–ø.${apt} (${name}): ${parseFloat(total).toFixed(2)} ‚Ç¨\n`; }); text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ –ó–∞ —Å—ä–±–∏—Ä–∞–Ω–µ: ${totalUnpaid.toFixed(2)} ‚Ç¨\n`; document.getElementById('reportText').value = text; document.getElementById('reportModal').classList.remove('hidden'); }
        
        function generateRepairViberReport() {
            calculate(); 
            const totalRepairCost = expenses.filter(e => e.type === 'repair').reduce((a, b) => a + b.cost, 0);
            let totalParts = 0;
            appConfig.apartments.forEach(a => totalParts += a.parts);

            let txt = `üõ†Ô∏è *–°–ü–†–ê–í–ö–ê –§–û–ù–î –†–ï–ú–û–ù–¢* üõ†Ô∏è\n`;
            txt += `üè¢ –ë–ª–æ–∫ 7–î | ${document.getElementById('reportDate').value}\n`;
            txt += `üìâ –û–±—â —Ä–∞–∑—Ö–æ–¥ –∑–∞ –ø–æ–∫—Ä–∏–≤–∞–Ω–µ: ${totalRepairCost.toFixed(2)} ‚Ç¨\n`;
            txt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

            let sumDue = 0, sumPaid = 0;
            const savedData = JSON.parse(localStorage.getItem(`condo_${document.getElementById('reportDate').value}`) || '{}').rows || [];

            appConfig.apartments.forEach(apt => {
                const share = (totalRepairCost * apt.parts) / totalParts;
                let paid = 0;
                let status = 'unpaid';
                let note = '';
                let name = apt.names;

                const saved = savedData.find(r => r.name === apt.name);
                if(saved) {
                    paid = parseFloat(saved.repairPaid) || 0;
                    status = saved.repairStatus;
                    note = saved.repairNote || '';
                    if(saved.repairName) name = saved.repairName;
                }

                const bal = share - paid;
                sumDue += share;
                sumPaid += paid;

                let icon = 'üî¥';
                if(status === 'paid') icon = '‚úÖ';
                if(status === 'partial') icon = '‚ö†Ô∏è';

                txt += `${icon} *–ê–ø. ${apt.name}* (${name})\n`;
                txt += `   üîπ –î—è–ª: ${share.toFixed(2)} ‚Ç¨\n`;
                txt += `   üíµ –ü–ª–∞—Ç–∏–ª: ${paid.toFixed(2)} ‚Ç¨\n`;
                if(Math.abs(bal) > 0.01) {
                     if(bal > 0) txt += `   ‚ùó –î—ä–ª–∂–∏: ${bal.toFixed(2)} ‚Ç¨\n`;
                     else txt += `   ‚Ü©Ô∏è –ù–∞–¥–≤–Ω–µ—Å—ä–ª: ${Math.abs(bal).toFixed(2)} ‚Ç¨\n`;
                }
                if(note) txt += `   üìù –ë–µ–ª: ${note}\n`;
                txt += `------------------\n`;
            });

            txt += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            txt += `üí∞ *–û–ë–©–û –ó–ê –í–•–û–î–ê*\n`;
            txt += `üì• –¢—Ä—è–±–≤–∞ –¥–∞ —Å–µ —Å—ä–±–µ—Ä–∞—Ç: ${sumDue.toFixed(2)} ‚Ç¨\n`;
            txt += `üì§ –†–µ–∞–ª–Ω–æ —Å—ä–±—Ä–∞–Ω–∏: ${sumPaid.toFixed(2)} ‚Ç¨\n`;
            const diff = sumPaid - sumDue;
            txt += `${diff >= 0 ? 'üü¢' : 'üî¥'} –ë–∞–ª–∞–Ω—Å: ${diff.toFixed(2)} ‚Ç¨\n`;

            document.getElementById('reportText').value = txt;
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function copyReportText() { const el = document.getElementById('reportText'); el.select(); navigator.clipboard.writeText(el.value).then(() => alert('–ö–æ–ø–∏—Ä–∞–Ω–æ!')); }
        function generateReport(aptName) { calculate(); const row = Array.from(document.querySelectorAll('#mainTable tbody tr')).find(r => r.querySelector('.apt-fixed').value === aptName); if(!row) return; const name = row.querySelector('.inp-names').value; const people = parseFloat(row.querySelector('.inp-people').value)||0; const garage = parseFloat(row.querySelector('.inp-garage').value)||0; const parts = parseFloat(row.querySelector('.inp-parts').value)||0; const evCost = parseFloat(row.querySelector('.inp-ev').value)||0; const isPaid = row.querySelector('.status-select').value === 'paid'; const dateStr = document.getElementById('reportDate').value; let totalPeople = 0, totalGarageCells = 0, totalParts = 0; document.querySelectorAll('#mainTable tbody tr').forEach(r => { totalPeople += parseFloat(r.querySelector('.inp-people').value)||0; totalGarageCells += parseFloat(r.querySelector('.inp-garage').value)||0; totalParts += parseFloat(r.querySelector('.inp-parts').value)||0; }); const liftConnMonthly = val('c_lift_conn')/12; const liftTechMonthly = val('c_lift_tech')/12; const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod'); const costGarageTotal = val('c_tok_garaj') + val('c_clean_garaj'); const costMaintenance = val('c_clean_complex') + val('c_mowing') + val('c_septic'); const costRepairs = val('c_repair'); const priceGarage = totalGarageCells>0?costGarageTotal/totalGarageCells:0; const priceCommon = totalPeople>0?costCommon/totalPeople:0; const priceMaint = totalPeople>0?costMaintenance/totalPeople:0; const priceRepair = totalParts>0?costRepairs/totalParts:0; const aptCommon = people * priceCommon; const aptMaint = people * priceMaint; const aptRepair = parts * priceRepair; const aptGarage = garage * priceGarage; const debt = parseFloat(row.querySelector('.inp-old-debt').value)||0; const aptTotal = aptCommon + aptMaint + aptRepair + aptGarage + evCost + debt; const fmt = (val) => `${val.toFixed(2)} ‚Ç¨ (${(val*EUR_RATE).toFixed(2)} –ª–≤.)`; let txt = `üè¢ –ö–ê–°–û–í–ê –ë–ï–õ–ï–ñ–ö–ê - –ë–õ–û–ö 7–î\nüóìÔ∏è –ü–µ—Ä–∏–æ–¥: ${dateStr}\nüë§ –ê–ø. ${aptName} (${name})\n----------------------------------------\n`; const pLabel = people === 1 ? '–∂–∏–≤—É—â' : '–∂–∏–≤—É—â–∏'; if(aptName !== '1.3' && people > 0) { txt += `‚ö° –û–±—â–∏ (–¢–æ–∫/–ê—Å/–ß–∏—Å—Ç): ${people} ${pLabel} x ${priceCommon.toFixed(2)} ‚Ç¨ = ${fmt(aptCommon)}\n`; txt += `üå± –ü–æ–¥–¥—Ä—ä–∂–∫–∞ (–ö–æ—Å–µ–Ω–µ/–Ø–º–∞): ${people} ${pLabel} x ${priceMaint.toFixed(2)} ‚Ç¨ = ${fmt(aptMaint)}\n`; txt += `üõ†Ô∏è –§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç (${parts}%): ${fmt(aptRepair)}\n`; } else if(aptName === '1.3') txt += `‚ÑπÔ∏è –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç 1.3 –µ –æ—Å–≤–æ–±–æ–¥–µ–Ω –æ—Ç —Ç–∞–∫—Å–∏.\n`; if(garage > 0) txt += `üöó –ì–∞—Ä–∞–∂ (–¢–æ–∫/–ü–æ—á): ${garage} –±—Ä. x ${priceGarage.toFixed(2)} ‚Ç¨ = ${fmt(aptGarage)}\n`; if(evCost > 0) txt += `üîå EV: ${fmt(evCost)}\n`; if(debt > 0) txt += `‚ö†Ô∏è –°—Ç–∞—Ä–∏ –∑–∞–¥—ä–ª–∂–µ–Ω–∏—è: ${fmt(debt)}\n`; txt += `----------------------------------------\nüí∞ –û–ë–©–û –ó–ê –ü–õ–ê–©–ê–ù–ï: ${fmt(aptTotal)}\nüìù –°–¢–ê–¢–£–°: ${isPaid ? '‚úÖ –ü–õ–ê–¢–ï–ù–û' : '‚ùå –ù–ï–ü–õ–ê–¢–ï–ù–û'}`; document.getElementById('reportText').value = txt; document.getElementById('reportModal').classList.remove('hidden'); }

        // --- NEW FEATURES: BULK & SETTINGS ---
        function toggleSelectAll() { const all = document.getElementById('selectAllCheckbox').checked; selectedApts.clear(); if(all) appConfig.apartments.forEach(a => selectedApts.add(a.name)); updateBulkUI(); }
        function toggleRow(name) { 
            const cb = document.querySelector(`.row-checkbox[value="${name}"]`);
            if(selectedApts.has(name)) {
                selectedApts.delete(name);
                cb.closest('tr').classList.remove('row-selected');
            } else {
                selectedApts.add(name);
                cb.closest('tr').classList.add('row-selected');
            }
            updateBulkUI(); 
        }
        function updateBulkUI() { 
            const b = document.getElementById('bulkActionBar'); 
            document.getElementById('selectedCount').innerText = selectedApts.size; 
            document.querySelectorAll('.row-checkbox').forEach(c => {
                c.checked = selectedApts.has(c.value);
                const tr = c.closest('tr');
                if(c.checked) tr.classList.add('row-selected');
                else tr.classList.remove('row-selected');
            });
            if(selectedApts.size > 0) { b.classList.remove('hidden'); b.classList.add('flex'); } else { b.classList.add('hidden'); b.classList.remove('flex'); document.getElementById('selectAllCheckbox').checked = false; } 
        }
        function openBulkPayModal() { document.getElementById('bulkCountDisplay').innerText = selectedApts.size; document.getElementById('bulkPayComment').value = ""; document.getElementById('bulkPayModal').classList.remove('hidden'); }
        function executeBulkPay() {
            const comment = document.getElementById('bulkPayComment').value;
            document.querySelectorAll('#mainTable tbody tr').forEach(row => {
                const name = row.querySelector('.apt-fixed').value;
                if(selectedApts.has(name)) {
                    const select = row.querySelector('.status-select');
                    select.value = 'paid';
                    changeStatus(select);
                    if(comment) row.querySelector('.inp-comment').value = comment;
                }
            });
            saveData(true);
            selectedApts.clear(); document.getElementById('bulkPayModal').classList.add('hidden'); updateBulkUI();
            alert('–£—Å–ø–µ—à–Ω–æ –º–∞—Ä–∫–∏—Ä–∞–Ω–∏!');
        }

        // Settings Modal & Editing
        function openSettings() {
            const tb = document.getElementById('settingsResidentsTable'); tb.innerHTML = '';
            appConfig.apartments.forEach((a, i) => {
                tb.innerHTML += `<tr><td class="p-2 font-bold">${a.name}</td><td class="p-2"><input type="text" value="${a.names}" class="form-input text-xs w-full" onchange="editApt(${i},'names',this.value)"></td><td class="p-2"><input type="number" value="${a.people}" class="form-input w-12 text-center text-xs" onchange="editApt(${i},'people',this.value)"></td><td class="p-2"><input type="number" value="${a.garage}" class="form-input w-12 text-center text-xs" onchange="editApt(${i},'garage',this.value)"></td><td class="p-2"><input type="number" value="${a.parts}" class="form-input w-16 text-center text-xs" onchange="editApt(${i},'parts',this.value)"></td></tr>`;
            });
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        function editApt(i, f, v) { if(f === 'names') appConfig.apartments[i].names = v; else appConfig.apartments[i][f] = parseFloat(v) || 0; }
        function saveSettingsAndReload() {
            localStorage.setItem(CONFIG_KEY, JSON.stringify(appConfig));
            document.getElementById('settingsModal').classList.add('hidden');
            loadData(); // Reload table with new config
            alert("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞!");
        }
    </script>
</body>
</html>

