<!DOCTYPE html>
<html lang="bg" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>7D Finance (Modern)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' } }
                }
            }
        }
    </script>

    <style>
        /* Base Styles & Transitions */
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, color 0.3s; }
        
        /* Glass Panel */
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid rgba(30, 41, 59, 0.8); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Sticky Columns with Dark Mode support */
        .sticky-col-check { position: sticky; left: 0; z-index: 20; border-right: 1px solid #e2e8f0; }
        .sticky-col-apt { position: sticky; left: 40px; z-index: 20; border-right: 2px solid #f1f5f9; box-shadow: 4px 0 6px -4px rgba(0,0,0,0.1); }
        
        .dark .sticky-col-check { border-right: 1px solid #334155; }
        .dark .sticky-col-apt { border-right: 2px solid #334155; }

        /* Table Headers (Always Dark) */
        thead .sticky-col-check, thead .sticky-col-apt { background-color: #1e293b; color: white; }
        .dark thead .sticky-col-check, .dark thead .sticky-col-apt { background-color: #0f172a; }

        /* Table Body (Adaptive) */
        tbody .sticky-col-check, tbody .sticky-col-apt { background-color: white; color: #0f172a; transition: background-color 0.3s, color 0.3s; }
        .dark tbody .sticky-col-check, .dark tbody .sticky-col-apt { background-color: #1e293b; color: #e2e8f0; }

        /* Inputs */
        input, select { -webkit-appearance: none; appearance: none; outline: none; }
        /* Modern Inputs: Gray background, darken on dark mode */
        .input-modern { background-color: #f8fafc; border: 1px solid transparent; transition: all 0.2s; }
        .input-modern:focus { background-color: #ffffff; box-shadow: 0 0 0 2px #3b82f6; }
        .dark .input-modern { background-color: #334155; color: white; }
        .dark .input-modern:focus { background-color: #1e293b; }

        /* Badges */
        .badge-paid { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; font-weight: 700; }
        .dark .badge-paid { background: #064e3b; color: #4ade80; border: 1px solid #065f46; }
        
        .badge-unpaid { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; font-weight: 700; }
        .dark .badge-unpaid { background: #450a0a; color: #f87171; border: 1px solid #7f1d1d; }

        /* Animations */
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* Print Styles */
        @media print {
            body { background: white; color: black; }
            .dark body { background: white; color: black; }
            nav, .no-print, #monthsGrid, button, #settingsModal, #reportModal, #bulkPayModal, .custom-checkbox, .sticky-col-check, .bill-status-icon, #theme-toggle { display: none !important; }
            .print-only { display: block !important; }
            input { border: none; background: transparent; padding: 0; font-weight: bold; text-align: right; color: black !important; }
            textarea { border: none; resize: none; height: auto; color: black !important; }
            .shadow-sm, .shadow-lg, .shadow-xl, .shadow-2xl { box-shadow: none !important; border: 1px solid #ccc; }
            .bg-slate-800, .bg-white, .dark\:bg-slate-800 { background: white !important; color: black !important; }
            main { margin: 0; padding: 0; max-width: 100%; }
            .sticky-col-apt { position: static; border: none; box-shadow: none; }
            .grid-cols-1, .grid-cols-2, .grid-cols-3, .grid-cols-4, .grid-cols-5 { display: block; } 
            .fund-print-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
            .expenses-print-container { display: flex; gap: 20px; }
            #mainTable th, #mainTable td { padding: 4px; border: 1px solid #eee; }
            #sum-grand { color: black !important; }
            thead { background-color: black !important; color: white !important; } /* Keep header black for contrast */
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 antialiased pb-24 lg:pb-12" id="bodyRoot">

    <nav class="sticky top-0 z-50 glass-panel no-print transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-900 dark:bg-white rounded-2xl flex items-center justify-center text-white dark:text-slate-900 shadow-xl shadow-slate-300/50 dark:shadow-none transition-all">
                    <i class="ri-building-4-fill text-2xl"></i>
                </div>
                <div>
                    <h1 class="font-extrabold text-lg leading-tight text-slate-900 dark:text-white tracking-tight">–ë–ª–æ–∫ 7–î</h1>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest">–§–∏–Ω–∞–Ω—Å–∏</p>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="toggleTheme()" id="theme-toggle" class="w-9 h-9 flex items-center justify-center rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <i id="theme-icon" class="ri-sun-line text-lg"></i>
                </button>

                <div class="bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-3 py-2 rounded-xl font-bold text-xs border border-blue-100 dark:border-blue-800 shadow-sm">
                    EUR (‚Ç¨)
                </div>
                <button onclick="openSettings()" class="w-9 h-9 bg-slate-800 dark:bg-slate-700 text-white rounded-xl shadow-lg hover:bg-slate-700 dark:hover:bg-slate-600 transition active:scale-95 flex items-center justify-center" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <i class="ri-settings-4-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 mt-6 space-y-6">

        <div class="bg-slate-800 dark:bg-slate-900 rounded-3xl p-5 shadow-xl shadow-slate-200 dark:shadow-none text-white flex justify-between items-center no-print transition-colors duration-300">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-3 h-3 rounded-full bg-emerald-400 animate-pulse"></div>
                    <div class="absolute inset-0 w-3 h-3 rounded-full bg-emerald-400 opacity-50 animate-ping"></div>
                </div>
                <span class="text-xs font-bold uppercase tracking-wider text-slate-300">GitHub Cloud</span>
            </div>
            <div class="flex gap-2">
                <button id="btn-pull" onclick="pullFromGitHub()" class="bg-slate-700 hover:bg-slate-600 border border-slate-600 text-xs px-4 py-2 rounded-xl font-bold flex items-center gap-2 transition active:scale-95"><i class="ri-download-cloud-2-fill"></i> –ò–ó–¢–ï–ì–õ–ò</button>
                <button id="btn-push" onclick="pushToGitHub()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-blue-900/20 transition active:scale-95"><i class="ri-upload-cloud-2-fill"></i> –ö–ê–ß–ò</button>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-2xl p-3 shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between no-print transition-colors">
            <button onclick="changeYear(-1)" class="w-10 h-10 flex items-center justify-center bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-xl text-slate-600 dark:text-slate-300 transition"><i class="ri-arrow-left-s-line text-xl"></i></button>
            <div class="text-center cursor-pointer hover:opacity-75 transition" onclick="document.getElementById('reportDate').showPicker()">
                <h2 class="text-2xl font-black text-slate-800 dark:text-white tracking-tight" id="displayYear">2026</h2>
                <input type="month" id="reportDate" class="hidden">
            </div>
            <button onclick="changeYear(1)" class="w-10 h-10 flex items-center justify-center bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-xl text-slate-600 dark:text-slate-300 transition"><i class="ri-arrow-right-s-line text-xl"></i></button>
        </div>

        <div class="hidden print-only text-center mb-6 border-b-2 border-slate-800 pb-4">
            <h1 class="text-3xl font-bold uppercase tracking-tight">–§–∏–Ω–∞–Ω—Å–æ–≤ –û—Ç—á–µ—Ç - –ë–ª–æ–∫ 7–î</h1>
            <p id="printDateLabel" class="text-lg text-slate-600 mt-2 font-medium"></p>
        </div>

        <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 bg-white dark:bg-slate-800 p-3 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 no-print transition-colors" id="monthsGrid"></div>

        <div class="fund-print-container grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-4">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-200 dark:border-slate-700 shadow-sm transition-all hover:shadow-md">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-extrabold text-rose-500 uppercase tracking-wide">–§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç</span>
                    <div class="w-8 h-8 rounded-lg bg-rose-50 dark:bg-rose-900/30 flex items-center justify-center text-rose-500"><i class="ri-tools-fill"></i></div>
                </div>
                <div class="text-2xl font-black text-slate-800 dark:text-white mb-4 tracking-tight" id="bal_repair_end">0.00 ‚Ç¨</div>
                <div class="pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center text-xs font-medium">
                    <div class="flex items-center gap-1 text-slate-400">–ù–∞—á: <input type="number" id="bal_repair_start" value="0" class="w-16 bg-transparent text-slate-600 dark:text-slate-300 font-bold border-b border-dashed border-slate-300 dark:border-slate-600 focus:border-rose-500 text-center" onchange="calculate()">‚Ç¨</div>
                    <div class="text-right space-y-0.5">
                        <div class="text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-1.5 py-0.5 rounded">+<span id="disp_repair_col">0</span>‚Ç¨</div>
                        <div class="text-rose-600 dark:text-rose-400 bg-rose-50 dark:bg-rose-900/30 px-1.5 py-0.5 rounded">-<span id="disp_repair_spent">0</span>‚Ç¨</div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-200 dark:border-slate-700 shadow-sm transition-all hover:shadow-md">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-extrabold text-emerald-500 uppercase tracking-wide">–ö–æ—Å–µ–Ω–µ</span>
                    <div class="w-8 h-8 rounded-lg bg-emerald-50 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-500"><i class="ri-plant-fill"></i></div>
                </div>
                <div class="text-2xl font-black text-slate-800 dark:text-white mb-4 tracking-tight" id="bal_mowing_end">0.00 ‚Ç¨</div>
                <div class="pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center text-xs font-medium">
                    <div class="flex items-center gap-1 text-slate-400">–ù–∞—á: <input type="number" id="bal_mowing_start" value="0" class="w-16 bg-transparent text-slate-600 dark:text-slate-300 font-bold border-b border-dashed border-slate-300 dark:border-slate-600 focus:border-emerald-500 text-center" onchange="calculate()">‚Ç¨</div>
                    <div class="text-right space-y-0.5">
                        <div class="text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-1.5 py-0.5 rounded">+<span id="disp_mowing_col">0</span>‚Ç¨</div>
                        <div class="text-rose-600 dark:text-rose-400 bg-rose-50 dark:bg-rose-900/30 px-1.5 py-0.5 rounded">-<span id="disp_mowing_spent">0</span>‚Ç¨</div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-200 dark:border-slate-700 shadow-sm transition-all hover:shadow-md">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-extrabold text-violet-500 uppercase tracking-wide">–Ø–º–∞</span>
                    <div class="w-8 h-8 rounded-lg bg-violet-50 dark:bg-violet-900/30 flex items-center justify-center text-violet-500"><i class="ri-drop-fill"></i></div>
                </div>
                <div class="text-2xl font-black text-slate-800 dark:text-white mb-4 tracking-tight" id="bal_septic_end">0.00 ‚Ç¨</div>
                <div class="pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center text-xs font-medium">
                    <div class="flex items-center gap-1 text-slate-400">–ù–∞—á: <input type="number" id="bal_septic_start" value="0" class="w-16 bg-transparent text-slate-600 dark:text-slate-300 font-bold border-b border-dashed border-slate-300 dark:border-slate-600 focus:border-violet-500 text-center" onchange="calculate()">‚Ç¨</div>
                    <div class="text-right space-y-0.5">
                        <div class="text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-1.5 py-0.5 rounded">+<span id="disp_septic_col">0</span>‚Ç¨</div>
                        <div class="text-rose-600 dark:text-rose-400 bg-rose-50 dark:bg-rose-900/30 px-1.5 py-0.5 rounded">-<span id="disp_septic_spent">0</span>‚Ç¨</div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-200 dark:border-slate-700 shadow-sm transition-all hover:shadow-md">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-extrabold text-amber-500 uppercase tracking-wide">–ö–æ–º–ø–ª–µ–∫—Å</span>
                    <div class="w-8 h-8 rounded-lg bg-amber-50 dark:bg-amber-900/30 flex items-center justify-center text-amber-500"><i class="ri-community-fill"></i></div>
                </div>
                <div class="text-2xl font-black text-slate-800 dark:text-white mb-4 tracking-tight" id="bal_complex_end">0.00 ‚Ç¨</div>
                <div class="pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center text-xs font-medium">
                    <div class="flex items-center gap-1 text-slate-400">–ù–∞—á: <input type="number" id="bal_complex_start" value="0" class="w-16 bg-transparent text-slate-600 dark:text-slate-300 font-bold border-b border-dashed border-slate-300 dark:border-slate-600 focus:border-amber-500 text-center" onchange="calculate()">‚Ç¨</div>
                    <div class="text-right space-y-0.5">
                        <div class="text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-1.5 py-0.5 rounded">+<span id="disp_complex_col">0</span>‚Ç¨</div>
                        <div class="text-rose-600 dark:text-rose-400 bg-rose-50 dark:bg-rose-900/30 px-1.5 py-0.5 rounded">-<span id="disp_complex_spent">0</span>‚Ç¨</div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 dark:bg-slate-950 text-white rounded-2xl p-5 border-l-4 border-blue-500 shadow-lg shadow-slate-300/20 dark:shadow-none ring-1 ring-black/5 flex flex-col justify-between relative overflow-hidden transition-colors">
                <div class="absolute right-0 top-0 w-24 h-24 bg-blue-500/10 rounded-full -mr-8 -mt-8 pointer-events-none"></div>
                <div class="flex justify-between items-center mb-3 relative z-10">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">–ù–∞–ª–∏—á–Ω–æ—Å—Ç –ö–∞—Å–∞</span>
                    <div class="w-8 h-8 rounded-lg bg-slate-700 dark:bg-slate-800 flex items-center justify-center text-blue-400"><i class="ri-safe-2-fill"></i></div>
                </div>
                <div class="text-2xl font-black text-white mb-2 tracking-tight relative z-10" id="total_cash_in_hand">0.00 ‚Ç¨</div>
                <div class="text-[10px] text-slate-400 font-medium relative z-10 border-t border-slate-700 pt-2">
                    –ù–∞—á. —Å–∞–ª–¥–∞ + –°—ä–±—Ä–∞–Ω–∏ (–±–µ–∑ —Ä–∞–∑—Ö–æ–¥–∏)
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 relative no-print">
            <div class="absolute -top-3 right-2 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border border-blue-200 dark:border-blue-800 shadow-sm z-10" id="inputHint">–í—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏ (EUR)</div>
            
            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm space-y-2 transition-colors">
                <h3 class="text-xs font-black text-blue-600 dark:text-blue-400 uppercase mb-3">‚ö° –û–±—â–∏ –†–∞–∑—Ö–æ–¥–∏</h3>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–¢–æ–∫ –í—Ö–æ–¥ (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_tok_vhod" type="number" value="19.21" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_tok_vhod" onclick="toggleBillStatus('c_tok_vhod')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–¢–æ–∫ –ê—Å–∞–Ω—Å—å–æ—Ä (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_tok_lift" type="number" value="56.89" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_tok_lift" onclick="toggleBillStatus('c_tok_lift')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–¢–æ–∫ –ê–±–æ–Ω–∞—Ç–Ω–∞ (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_tok_abonatna" type="number" value="101.56" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_tok_abonatna" onclick="toggleBillStatus('c_tok_abonatna')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–ú.—Ç–∞–∫—Å–∞ –ê—Å. (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_lift_month" type="number" value="75.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_lift_month" onclick="toggleBillStatus('c_lift_month')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–ü–æ—á. –í—Ö–æ–¥ (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_clean_vhod" type="number" value="140.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_clean_vhod" onclick="toggleBillStatus('c_clean_vhod')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm space-y-2 transition-colors">
                <h3 class="text-xs font-black text-blue-600 dark:text-blue-400 uppercase mb-3">üîß –ì–æ–¥–∏—à–Ω–∏</h3>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–°–≤—ä—Ä–∑–∞–Ω–æ—Å—Ç –ê—Å.(‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_lift_conn" type="number" value="72.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700" onchange="calculate()"><button id="btn_paid_c_lift_conn" onclick="toggleBillStatus('c_lift_conn')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="text-right text-[10px] text-blue-400 font-medium -mt-1 pr-9" id="hint_conn"></div>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–¢–µ—Ö–Ω. –ø—Ä–µ–≥–ª–µ–¥ (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_lift_tech" type="number" value="90.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700" onchange="calculate()"><button id="btn_paid_c_lift_tech" onclick="toggleBillStatus('c_lift_tech')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="text-right text-[10px] text-blue-400 font-medium -mt-1 pr-9" id="hint_tech"></div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm space-y-2 transition-colors">
                <h3 class="text-xs font-black text-amber-600 dark:text-amber-500 uppercase mb-3">üöó –ì–∞—Ä–∞–∂</h3>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–¢–æ–∫ –ì–∞—Ä–∞–∂ (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_tok_garaj" type="number" value="60.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_tok_garaj" onclick="toggleBillStatus('c_tok_garaj')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_clean_garaj" type="number" value="175.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_clean_garaj" onclick="toggleBillStatus('c_clean_garaj')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm space-y-2 transition-colors">
                <h3 class="text-xs font-black text-emerald-600 dark:text-emerald-500 uppercase mb-3">üå± –î—Ä—É–≥–∏</h3>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–ö–æ—Å–µ–Ω–µ (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_mowing" type="number" value="100.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_mowing" onclick="toggleBillStatus('c_mowing')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–°–µ–ø—Ç–∏—á–Ω–∞ —è–º–∞ (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_septic" type="number" value="100.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_septic" onclick="toggleBillStatus('c_septic')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–ü–æ—á. –∫–æ–º–ø–ª–µ–∫—Å (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_clean_complex" type="number" value="80.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"><button id="btn_paid_c_clean_complex" onclick="toggleBillStatus('c_clean_complex')" class="bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg"><i class="ri-check-line"></i></button></div></div>
                <div class="flex justify-between items-center"><span class="text-xs font-medium text-slate-500 dark:text-slate-400">–¢–∞–∫—Å–∞ —Ä–µ–º–æ–Ω—Ç (‚Ç¨)</span><div class="flex gap-1 items-center"><input id="c_repair" type="number" value="200.00" class="input-modern input-cell w-20 text-right rounded-lg font-bold text-sm text-slate-700"></div></div>
            </div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-7 gap-3 no-print">
            <button onclick="calculate()" class="col-span-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-2xl shadow-lg shadow-blue-500/30 transition active:scale-95 flex flex-col items-center justify-center gap-1"><i class="ri-calculator-fill text-xl"></i> <span class="text-[10px] uppercase">–ò–∑—á–∏—Å–ª–∏</span></button>
            <button onclick="saveData()" class="col-span-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-2xl shadow-lg shadow-emerald-500/30 transition active:scale-95 flex flex-col items-center justify-center gap-1"><i class="ri-save-3-fill text-xl"></i> <span class="text-[10px] uppercase">–ó–∞–ø–∞–∑–∏</span></button>
            <button onclick="generateViberMessage()" class="col-span-2 lg:col-span-1 bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 rounded-2xl shadow-lg shadow-violet-500/30 transition active:scale-95 flex flex-col items-center justify-center gap-1"><i class="ri-chat-3-fill text-xl"></i> <span class="text-[10px] uppercase">Viber</span></button>
            <button onclick="generateRepairViberReport()" class="col-span-1 bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-2xl shadow-lg shadow-amber-500/30 transition active:scale-95 flex flex-col items-center justify-center gap-1"><i class="ri-hammer-fill text-xl"></i> <span class="text-[10px] uppercase">Viber (–†–µ–º.)</span></button>
            <button onclick="generateFullReport()" class="col-span-1 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-2xl shadow-lg shadow-cyan-500/30 transition active:scale-95 flex flex-col items-center justify-center gap-1"><i class="ri-file-list-3-fill text-xl"></i> <span class="text-[10px] uppercase">–û—Ç—á–µ—Ç</span></button>
            <button onclick="exportToCSV()" class="col-span-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-2xl shadow-lg shadow-emerald-700/30 transition active:scale-95 flex flex-col items-center justify-center gap-1"><i class="ri-file-excel-2-fill text-xl"></i> <span class="text-[10px] uppercase">Excel</span></button>
            <button onclick="startNewMonth()" class="col-span-1 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-white font-bold py-3 rounded-2xl shadow transition active:scale-95 flex flex-col items-center justify-center gap-1"><i class="ri-calendar-event-fill text-xl"></i> <span class="text-[10px] uppercase">–ù–æ–≤ –ú–µ—Å–µ—Ü</span></button>
            <button onclick="window.print()" class="col-span-7 lg:col-span-1 bg-slate-800 dark:bg-slate-700 hover:bg-slate-900 dark:hover:bg-slate-600 text-white font-bold py-3 rounded-2xl shadow-lg shadow-slate-500/30 transition active:scale-95 flex flex-col items-center justify-center gap-1"><i class="ri-printer-fill text-xl"></i> <span class="text-[10px] uppercase">–ü—Ä–∏–Ω—Ç</span></button>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg shadow-slate-200 dark:shadow-none border border-slate-200 dark:border-slate-700 overflow-hidden ring-1 ring-black/5 transition-colors">
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="mainTable">
                    <thead class="bg-slate-850 text-white text-xs uppercase font-bold sticky top-0 z-20">
                        <tr>
                            <th class="px-2 py-4 no-print w-10 text-center sticky-col-check">
                                <input type="checkbox" id="selectAllCheckbox" class="custom-checkbox" onchange="toggleSelectAll()">
                            </th>
                            <th class="px-3 py-4 sticky-col-apt min-w-[70px] shadow-sm">–ê–ø.</th>
                            <th class="px-3 py-4 min-w-[150px] text-left">–ò–º–µ</th>
                            <th class="px-2 py-4 w-16 text-center">–•–û–†–ê</th>
                            <th class="px-2 py-4 w-16 text-center">–ì–ê–†–ê–ñ</th>
                            <th class="px-2 py-4 w-20 text-center">–ï–õ. –ö–û–õ–ê <span class="currency-symbol text-[10px] opacity-70">‚Ç¨</span></th>
                            <th class="px-3 py-4 text-right text-white">–°–º–µ—Ç–∫–∞ (‚Ç¨)</th>
                            <th class="px-3 py-4 text-rose-300 text-right">–°—Ç–∞—Ä–∏ (‚Ç¨)</th>
                            <th class="px-3 py-4 text-right">–û–ë–©–û (‚Ç¨)</th>
                            <th class="px-3 py-4 min-w-[120px] text-center no-print">–°—Ç–∞—Ç—É—Å</th>
                            <th class="px-3 py-4 min-w-[120px] no-print">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700 font-medium text-slate-800 dark:text-slate-200"></tbody>
                    <tfoot class="bg-slate-100 dark:bg-slate-900 font-bold text-slate-800 dark:text-white border-t-2 border-slate-200 dark:border-slate-700">
                        <tr>
                            <td class="no-print"></td>
                            <td colspan="7" class="px-4 py-4 text-right text-xs uppercase tracking-wide">–¢–û–¢–ê–õ <span class="currency-symbol">‚Ç¨</span>:</td>
                            <td class="px-3 py-4 text-right text-lg text-blue-700 dark:text-blue-400 font-black" id="sum-grand">0.00 ‚Ç¨</td>
                            <td colspan="2" class="no-print"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div id="bulkActionBar" class="bg-blue-50 dark:bg-blue-900/50 border-t border-blue-100 dark:border-blue-800 p-3 hidden flex justify-between items-center no-print animate-fade-in fixed bottom-0 left-0 right-0 z-50 shadow-2xl lg:static lg:shadow-none">
                <span class="text-xs font-bold text-blue-800 dark:text-blue-200 uppercase pl-2"><span id="selectedCount">0</span> –∏–∑–±—Ä–∞–Ω–∏</span>
                <button onclick="openBulkPayModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition shadow-lg">–ú–∞—Ä–∫–∏—Ä–∞–π –∫–∞—Ç–æ –ü–ª–∞—Ç–µ–Ω–∏</button>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden p-5 transition-colors">
            <h3 class="font-bold text-sm mb-4 text-slate-800 dark:text-white uppercase flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-2">
                <i class="ri-pie-chart-2-fill text-blue-500"></i> –û–¢–ß–ï–¢ –°–™–ë–ò–†–ê–ï–ú–û–°–¢ –ü–û –ü–ï–†–ê (–†–µ–∞–ª–Ω–æ –ø–ª–∞—Ç–µ–Ω–∏)
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 dark:bg-slate-900 text-slate-500 dark:text-slate-400 text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th class="px-4 py-3 text-right">–î—ä–ª–∂–∏–º–∞ —Å—É–º–∞ (‚Ç¨)</th>
                            <th class="px-4 py-3 text-right">–†–µ–∞–ª–Ω–æ –°—ä–±—Ä–∞–Ω–∏ (‚Ç¨)</th>
                            <th class="px-4 py-3 text-right">–î–µ—Ñ–∏—Ü–∏—Ç / –ò–∑–ª–∏—à—ä–∫ (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700 font-medium text-slate-700 dark:text-slate-300" id="collectionReportBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="expenses-print-container grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700 transition-colors">
                <h3 class="font-bold text-sm mb-4 text-slate-800 dark:text-white uppercase flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-2"><i class="ri-list-check-2 text-blue-500"></i> –¢–µ–∫—É—â–∏ –†–∞–∑—Ö–æ–¥–∏</h3>
                <div class="flex flex-col gap-2 no-print mb-4 bg-slate-50 dark:bg-slate-700 p-3 rounded-xl border border-slate-100 dark:border-slate-600">
                    <div class="flex gap-2">
                        <input type="text" id="newExpTitle" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="input-modern bg-white dark:bg-slate-800 dark:text-white border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 flex-grow text-sm">
                        <input type="number" id="newExpCost" placeholder="–°—É–º–∞ (EUR)" class="input-modern bg-white dark:bg-slate-800 dark:text-white border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 w-24 text-sm font-bold">
                    </div>
                    <div class="flex gap-2">
                        <select id="newExpType" class="input-modern bg-white dark:bg-slate-800 dark:text-white border-slate-200 dark:border-slate-600 rounded-lg px-3 py-2 text-sm flex-grow">
                            <option value="repair">–§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç</option>
                            <option value="mowing">–ö–æ—Å–µ–Ω–µ</option>
                            <option value="septic">–°–µ–ø—Ç–∏—á–Ω–∞ —è–º–∞</option>
                            <option value="complex">–ö–æ–º–ø–ª–µ–∫—Å</option>
                            <option value="other">–î—Ä—É–≥–∏</option>
                        </select>
                        <button onclick="addExpense()" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition">OK</button>
                    </div>
                </div>
                <table class="w-full text-sm" id="expensesTable">
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-700 dark:text-slate-300"></tbody>
                </table>
            </div>

            <div class="lg:col-span-1 bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700 print-only transition-colors">
                <h3 class="font-bold text-sm mb-4 text-slate-800 dark:text-white uppercase flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-2"><i class="ri-wallet-3-fill text-emerald-500"></i> –ö–∞—Å–æ–≤–∞ –ö–Ω–∏–≥–∞ / –ë–µ–ª–µ–∂–∫–∏</h3>
                <textarea id="persistentInfo" placeholder="–û–ø–∏—à–µ—Ç–µ –ø–ª–∞—â–∞–Ω–∏—è—Ç–∞ —Ç—É–∫ (–Ω–∞–ø—Ä. '–ü–ª–∞—Ç–µ–Ω —á–∏—Å—Ç–∞—á –Ω–∞ 15-—Ç–∏')..." class="w-full bg-slate-50 dark:bg-slate-700 dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm h-48 resize-none outline-none focus:ring-2 focus:ring-blue-500/50"></textarea>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-slate-200 dark:border-slate-700 transition-colors">
            <h3 class="font-bold text-sm mb-4 text-rose-600 uppercase flex items-center gap-2 border-b border-rose-100 dark:border-rose-900/50 pb-2">
                <i class="ri-hammer-line"></i> –°–ü–†–ê–í–ö–ê: –†–ï–ú–û–ù–¢–ò (–ü–æ % –ò–¥. –ß–∞—Å—Ç–∏)
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="repairsBreakdownTable">
                    <thead class="bg-slate-850 text-white text-xs uppercase font-bold">
                        <tr>
                            <th class="px-3 py-3 text-left">–ê–ø.</th>
                            <th class="px-3 py-3 text-left">–ò–º–µ</th>
                            <th class="px-3 py-3 text-center">% –ò–¥.–ß.</th>
                            <th class="px-3 py-3 text-right">–î—è–ª <span class="currency-symbol text-[10px]">‚Ç¨</span></th>
                            <th class="px-3 py-3 text-right bg-slate-800 rounded-t-lg">–ü–ª–∞—Ç–∏–ª (‚Ç¨)</th>
                            <th class="px-3 py-3 text-right">–ë–∞–ª–∞–Ω—Å <span class="currency-symbol text-[10px]">‚Ç¨</span></th>
                            <th class="px-3 py-3 text-center no-print">–°—Ç–∞—Ç—É—Å</th>
                            <th class="px-3 py-3 text-left no-print">–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-800 dark:text-slate-200"></tbody>
                    <tfoot class="bg-slate-100 dark:bg-slate-900 font-bold text-slate-900 dark:text-white border-t-2 border-slate-300 dark:border-slate-600">
                        <tr>
                           <td colspan="3" class="px-3 py-4 text-right uppercase text-xs">–û–ë–©–û –ó–ê –í–•–û–î–ê:</td>
                           <td class="px-3 py-4 text-right" id="rep_sum_due"></td>
                           <td class="px-3 py-4 text-right" id="rep_sum_paid"></td>
                           <td class="px-3 py-4 text-right" id="rep_sum_diff"></td>
                           <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </main>

    <div id="settingsModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-4xl max-h-[90vh] shadow-2xl p-0 flex flex-col overflow-hidden text-slate-800 dark:text-white">
            <div class="p-4 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="ri-settings-4-fill"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="text-2xl text-slate-400 hover:text-slate-600 dark:hover:text-white transition">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700">
                    <h4 class="font-bold text-xs uppercase text-slate-500 dark:text-slate-400 mb-2">GitHub Sync</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <input id="gh-token" type="password" class="w-full bg-white dark:bg-slate-900 p-3 rounded-xl text-sm border dark:border-slate-600 outline-none focus:ring-2 focus:ring-blue-500/50" placeholder="Token">
                        <input id="gh-gist" type="text" class="w-full bg-white dark:bg-slate-900 p-3 rounded-xl text-sm border dark:border-slate-600 outline-none focus:ring-2 focus:ring-blue-500/50" placeholder="Gist ID">
                    </div>
                    <button onclick="saveGHCreds()" class="mt-3 text-xs bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg font-bold transition">Save Keys</button>
                </div>
                <div>
                    <h4 class="font-bold text-xs uppercase text-slate-500 dark:text-slate-400 mb-2">–†–µ–¥–∞–∫—Ü–∏—è –Ω–∞ –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∏</h4>
                    <div class="overflow-x-auto border dark:border-slate-700 rounded-2xl">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-100 dark:bg-slate-800 uppercase font-bold text-slate-500 dark:text-slate-400"><tr><th class="p-3">–ê–ø.</th><th class="p-3">–ò–º–µ</th><th class="p-3">–•–æ—Ä–∞</th><th class="p-3">–ì–∞—Ä–∞–∂</th><th class="p-3">% –ò–¥.–ß.</th></tr></thead>
                            <tbody id="settingsResidentsTable" class="divide-y dark:divide-slate-700 bg-white dark:bg-slate-900"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-right">
                <button onclick="saveSettingsAndReload()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-xl font-bold transition shadow-lg shadow-emerald-500/20">–ó–∞–ø–∞–∑–∏ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ</button>
            </div>
        </div>
    </div>

    <div id="bulkPayModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md shadow-2xl p-6 text-slate-800 dark:text-white">
            <h3 class="font-bold text-lg mb-2">–ú–∞—Å–æ–≤–æ –ü–ª–∞—â–∞–Ω–µ</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">–©–µ –º–∞—Ä–∫–∏—Ä–∞—Ç–µ <span id="bulkCountDisplay" class="font-bold text-slate-900 dark:text-white">0</span> —Å–º–µ—Ç–∫–∏ –∫–∞—Ç–æ –ü–õ–ê–¢–ï–ù–ò.</p>
            <input type="text" id="bulkPayComment" class="w-full border dark:border-slate-600 dark:bg-slate-800 p-3 rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-500/50" placeholder="–ë–µ–ª–µ–∂–∫–∞ (–Ω–∞–ø—Ä. '–ë–∞–Ω–∫–æ–≤ –ø—Ä–µ–≤–æ–¥')...">
            <div class="flex gap-2">
                <button onclick="document.getElementById('bulkPayModal').classList.add('hidden')" class="flex-1 py-3 rounded-xl border dark:border-slate-600 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition">–û—Ç–∫–∞–∑</button>
                <button onclick="executeBulkPay()" class="flex-1 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold transition shadow-lg shadow-blue-500/30">–ü–æ—Ç–≤—ä—Ä–¥–∏</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-5xl h-[85vh] shadow-2xl flex flex-col text-slate-800 dark:text-white">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800 rounded-t-3xl">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="ri-file-text-line text-blue-500"></i> –î–µ—Ç–∞–π–ª–µ–Ω –û—Ç—á–µ—Ç</h3>
                <button onclick="document.getElementById('reportModal').classList.add('hidden')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-400 text-xl transition">&times;</button>
            </div>
            <textarea id="reportText" class="w-full h-full p-6 bg-slate-50 dark:bg-slate-950 dark:text-slate-300 text-sm font-mono resize-none focus:outline-none leading-relaxed text-slate-700" readonly></textarea>
            <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-900 rounded-b-3xl">
                <button onclick="copyReportText()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2"><i class="ri-file-copy-line"></i> –ö–æ–ø–∏—Ä–∞–π –¢–µ–∫—Å—Ç–∞</button>
            </div>
        </div>
    </div>

    <script>
        // --- Dark Mode Logic ---
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                icon.className = 'ri-sun-line text-lg';
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                icon.className = 'ri-moon-line text-lg';
            }
        }

        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
        
        window.addEventListener('load', () => {
             const icon = document.getElementById('theme-icon');
             if(document.documentElement.classList.contains('dark')) { icon.className = 'ri-moon-line text-lg'; } 
             else { icon.className = 'ri-sun-line text-lg'; }
        });

        // Default Data
        const defaultApartments = [
            { name: "1.1", names: "–°—Ç–µ—Ñ–∞–Ω –î–µ—á–∫–æ–≤", parts: 5.406, people: 2, garage: 1 },
            { name: "1.2", names: "–í–∞–Ω—è –∏ –ò–≤–∞–Ω", parts: 5.248, people: 2, garage: 1 },
            { name: "1.3", names: "", parts: 4.720, people: 0, garage: 1 },
            { name: "1.4", names: "–ì–∞–±—Ä–∏–µ–ª–∞ –∏ –ù–∏–∫–æ–ª–∞", parts: 4.803, people: 2, garage: 1 },
            { name: "2.5", names: "–ê—Ç–∞–Ω–∞—Å –∏ –õ–æ—Ä–∞", parts: 7.228, people: 2, garage: 1 },
            { name: "2.6", names: "", parts: 6.662, people: 1, garage: 1 },
            { name: "2.7", names: "–ò–≤–∞–π–ª–æ –ê–Ω–≥–µ–ª–æ–≤", parts: 6.457, people: 1, garage: 1 },
            { name: "2.8", names: "–Ø–Ω–∞ –∏ –î–µ–π–≤–∏–¥", parts: 6.562, people: 2, garage: 1 },
            { name: "3.9", names: "–õ—é–±–∞ –∏ –ú–∏—Ä–æ—Å–ª–∞–≤–∞", parts: 7.228, people: 2, garage: 0 },
            { name: "3.10", names: "–ê–Ω—Ç–æ–Ω–∏—è –∏ –ú–∞—Ä—Ç–∏–Ω", parts: 6.662, people: 2, garage: 2 },
            { name: "3.11", names: "–¶–≤–µ—Ç–µ–ª–∏–Ω–∞ –°—Ç–æ—è–Ω–æ–≤–∞", parts: 6.457, people: 1, garage: 1 },
            { name: "3.12", names: "–ï–º–∏–ª–∏—è–Ω", parts: 6.562, people: 2, garage: 2 },
            { name: "4.13", names: "–ñ–æ—Ä–æ –î–µ—Å–ø–æ—Ç–æ–≤", parts: 7.510, people: 2, garage: 1 },
            { name: "4.14", names: "–ö—Ä–∏—Å–∏—è–Ω", parts: 4.907, people: 2, garage: 1 },
            { name: "4.15", names: "Yosif Danchev", parts: 10.929, people: 1, garage: 2 },
            { name: "5.16", names: "–ò–≤–∞–π–ª–æ", parts: 2.660, people: 1, garage: 0 }
        ];

        // App State
        let appConfig = { apartments: JSON.parse(JSON.stringify(defaultApartments)) };
        let expenses = [];
        let billStatus = {}; 
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        const EUR_RATE = 1.95583; // Fixed Rate
        const GH_KEY = 'Condo_GH_Creds';
        const CONFIG_KEY = 'Condo_Config_V1';
        const currencyInputs = ['c_tok_vhod', 'c_tok_lift', 'c_tok_abonatna', 'c_lift_month', 'c_lift_conn', 'c_lift_tech', 'c_clean_vhod', 'c_tok_garaj', 'c_clean_garaj', 'c_mowing', 'c_septic', 'c_clean_complex', 'c_repair', 'bal_repair_start', 'bal_mowing_start', 'bal_septic_start', 'bal_complex_start', 'newExpCost'];
        
        let selectedApts = new Set();

        window.onload = function() {
            // Re-apply theme icon check on full load
            const icon = document.getElementById('theme-icon');
            if(document.documentElement.classList.contains('dark')) { icon.className = 'ri-moon-line text-lg'; } 
            else { icon.className = 'ri-sun-line text-lg'; }

            const savedConfig = localStorage.getItem(CONFIG_KEY);
            if(savedConfig) appConfig = JSON.parse(savedConfig);

            updateHiddenInput(); renderDatePicker();
            const c = JSON.parse(localStorage.getItem(GH_KEY) || '{}');
            document.getElementById('gh-token').value = c.token || ''; document.getElementById('gh-gist').value = c.gist || '';
            loadData(); updateMonthlyHints();
        };

        // --- CORE FUNCTIONS ---
        function toggleBillStatus(id) {
            billStatus[id] = !billStatus[id];
            renderBillStatus();
            saveData(true);
        }

        function renderBillStatus() {
            const billIds = [
                'c_tok_vhod', 'c_tok_lift', 'c_tok_abonatna', 'c_lift_month', 'c_clean_vhod',
                'c_lift_conn', 'c_lift_tech', 'c_tok_garaj', 'c_clean_garaj',
                'c_mowing', 'c_septic', 'c_clean_complex'
            ];
            
            billIds.forEach(id => {
                const btn = document.getElementById('btn_paid_' + id);
                if (btn) {
                    if (billStatus[id]) {
                        btn.className = "bill-btn bill-btn-paid w-7 h-7 flex items-center justify-center rounded-lg";
                        btn.innerHTML = '<i class="ri-check-double-line"></i>';
                    } else {
                        btn.className = "bill-btn bill-btn-unpaid w-7 h-7 flex items-center justify-center rounded-lg";
                        btn.innerHTML = '<i class="ri-check-line"></i>';
                    }
                }
            });
        }

        function startNewMonth() {
            if (!confirm('–ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –æ—Ç–≤–æ—Ä–∏—Ç–µ –ù–û–í –ú–ï–°–ï–¶?\n\n1. –ù–µ–ø–ª–∞—Ç–µ–Ω–∏—Ç–µ —Å—É–º–∏ —â–µ —Å—Ç–∞–Ω–∞—Ç "–°—Ç–∞—Ä–∏ –∑–∞–¥—ä–ª–∂–µ–Ω–∏—è".\n2. –ö—Ä–∞–π–Ω–∏—Ç–µ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç–∏ –Ω–∞ —Ñ–æ–Ω–¥–æ–≤–µ—Ç–µ —â–µ —Å—Ç–∞–Ω–∞—Ç –Ω–∞—á–∞–ª–Ω–∏.\n3. –°–º–µ—Ç–∫–∏—Ç–µ –∑–∞ —Ç–æ–∫ –∏ —Ä–∞–∑—Ö–æ–¥–∏—Ç–µ —â–µ —Å–µ –Ω—É–ª–∏—Ä–∞—Ç.')) return;
            calculate(); 
            const nextRows = [];
            document.querySelectorAll('#mainTable tbody tr').forEach(row => {
                const aptName = row.querySelector('.apt-fixed').value;
                const names = row.querySelector('.inp-names').value;
                const people = row.querySelector('.inp-people').value;
                const garage = row.querySelector('.inp-garage').value;
                const comment = row.querySelector('.inp-comment').value;
                // Grab total in EUR
                const totalDue = parseFloat(row.querySelector('.res-grand-total-val').value) || 0;
                const isPaid = row.querySelector('.status-select').value === 'paid';
                const newOldDebt = isPaid ? 0 : totalDue;
                nextRows.push({ name: aptName, names: names, people: people, garageCells: garage, evCost: 0, oldDebt: newOldDebt, status: 'unpaid', comment: comment, repairPaid: 0, repairStatus: 'unpaid', repairNote: '', repairName: names });
            });
            const nextInputs = {};
            currencyInputs.forEach(id => { if(document.getElementById(id)) nextInputs[id] = val(id); });
            nextInputs['bal_repair_start'] = parseFloat(document.getElementById('bal_repair_end_val').value) || 0;
            nextInputs['bal_mowing_start'] = parseFloat(document.getElementById('bal_mowing_end_val').value) || 0;
            nextInputs['bal_septic_start'] = parseFloat(document.getElementById('bal_septic_end_val').value) || 0;
            nextInputs['bal_complex_start'] = parseFloat(document.getElementById('bal_complex_end_val').value) || 0;
            if (currentMonth === 12) { currentMonth = 1; currentYear++; } else { currentMonth++; }
            const newDateKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            document.getElementById('reportDate').value = newDateKey;
            
            // New Month -> Reset bill statuses
            const newData = { rows: nextRows, inputs: nextInputs, expenses: [], info: document.getElementById('persistentInfo').value, billStatus: {} };
            localStorage.setItem(`condo_${newDateKey}`, JSON.stringify(newData));
            renderDatePicker(); loadData();
            alert(`–£—Å–ø–µ—à–Ω–æ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω –º–µ—Å–µ—Ü ${newDateKey}!`);
        }

        function exportToCSV() {
            calculate(); const dateStr = document.getElementById('reportDate').value; const sym = '‚Ç¨'; 
            let csv = `\uFEFF–û–¢–ß–ï–¢ –ó–ê –ú–ï–°–ï–¶: ${dateStr},,,,,,,,\n–í–ê–õ–£–¢–ê: EUR,,,,,,,,\n\n--- –°–™–°–¢–û–Ø–ù–ò–ï –ù–ê –§–û–ù–î–û–í–ï–¢–ï ---,,,,,,,,\n–ò–º–µ,–ù–∞—á–∞–ª–æ,–°—ä–±—Ä–∞–Ω–æ,–ü–æ—Ö–∞—Ä—á–µ–Ω–æ,–ö—Ä–∞–π,,,,\n`;
            ['repair', 'mowing', 'septic', 'complex'].forEach(type => { const name = type === 'repair' ? '–†–µ–º–æ–Ω—Ç' : type === 'mowing' ? '–ö–æ—Å–µ–Ω–µ' : type === 'septic' ? '–Ø–º–∞' : '–ö–æ–º–ø–ª–µ–∫—Å'; const start = document.getElementById(`bal_${type}_start`).value; const col = document.getElementById(`disp_${type}_col_val`).value; const spent = document.getElementById(`disp_${type}_spent_val`).value; const end = document.getElementById(`bal_${type}_end_val`).value; csv += `${name},${start},${col},${spent},${end},,,,\n`; });
            csv += `\n--- –°–ü–ò–°–™–ö –° –†–ê–ó–•–û–î–ò ---,,,,,,,,\n–û–ø–∏—Å–∞–Ω–∏–µ,–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–°—É–º–∞,,,,,\n`; expenses.forEach(e => { csv += `"${e.title}",${e.type},${(e.cost).toFixed(2)},,,,,\n`; });
            csv += `\n--- –ì–õ–ê–í–ù–ê –¢–ê–ë–õ–ò–¶–ê (–°–ú–ï–¢–ö–ò) ---,,,,,,,,\n–ê–ø.,–ò–º–µ,–ñ–∏–≤—É—â–∏,–ì–∞—Ä–∞–∂,EV,–¢–µ–∫—É—â–∞ –°–º–µ—Ç–∫–∞,–°—Ç–∞—Ä –î—ä–ª–≥,–û–ë–©–û –ó–ê –ü–õ–ê–©–ê–ù–ï,–°—Ç–∞—Ç—É—Å\n`;
            document.querySelectorAll('#mainTable tbody tr').forEach(row => { const apt = row.querySelector('.apt-fixed').value; const name = row.querySelector('.inp-names').value; const people = row.querySelector('.inp-people').value; const garage = row.querySelector('.inp-garage').value; const ev = row.querySelector('.inp-ev').value; const current = row.querySelector('.res-current-val').value; const old = row.querySelector('.inp-old-debt').value; const total = row.querySelector('.res-grand-total-val').value; const statusText = row.querySelector('.status-select').options[row.querySelector('.status-select').selectedIndex].text; csv += `${apt},"${name}",${people},${garage},${ev},${current},${old},${total},${statusText}\n`; });
            csv += `\n--- –°–ü–†–ê–í–ö–ê: –†–ï–ú–û–ù–¢–ò (–ü–æ % –ò–¥. –ß–∞—Å—Ç–∏) ---,,,,,,,,\n`; csv += `–ê–ø.,–ò–º–µ,% –ò–¥.–ß.,–î—è–ª (${sym}),–ü–ª–∞—Ç–∏–ª (${sym}),–ë–∞–ª–∞–Ω—Å (${sym}),–°—Ç–∞—Ç—É—Å,–ö–æ–º–µ–Ω—Ç–∞—Ä\n`;
            document.querySelectorAll('#repairsBreakdownTable tbody tr').forEach(row => { const apt = row.cells[0].innerText.trim(); const rName = row.querySelector('.inp-repair-name').value; const pct = row.cells[2].innerText.trim(); const share = row.cells[3].innerText.trim(); const paid = row.querySelector('.inp-repair-paid').value; const bal = row.cells[5].innerText.trim(); const select = row.querySelector('select'); const status = select.options[select.selectedIndex].text; const note = row.querySelector('.inp-repair-note').value.replace(/"/g, '""'); csv += `${apt},"${rName}","${pct}","${share}","${paid}","${bal}","${status}","${note}"\n`; });
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csv); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `Full_Report_Block7D_${dateStr}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function generateFullReport() {
            calculate();
            const currencySym = '‚Ç¨'; const format = (v) => v.toFixed(2) + ' ' + currencySym + ` (${(v*EUR_RATE).toFixed(2)} –ª–≤.)`; const dateStr = document.getElementById('reportDate').value;
            const liftConnMonthly = val('c_lift_conn') / 12; const liftTechMonthly = val('c_lift_tech') / 12; const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod'); const costGarage = val('c_tok_garaj') + val('c_clean_garaj'); const costMaintenance = val('c_clean_complex') + val('c_mowing') + val('c_septic'); const costRepairs = val('c_repair'); const totalMonthlyCosts = costCommon + costGarage + costMaintenance + costRepairs;
            let totalPeople = 0, totalGarageCells = 0, totalParts = 0; document.querySelectorAll('#mainTable tbody tr').forEach(r => { totalPeople += parseFloat(r.querySelector('.inp-people').value)||0; totalGarageCells += parseFloat(r.querySelector('.inp-garage').value)||0; totalParts += parseFloat(r.querySelector('.inp-parts').value)||0; });
            const priceCommon = totalPeople > 0 ? costCommon / totalPeople : 0; const priceMaint = totalPeople > 0 ? costMaintenance / totalPeople : 0; const priceRepair = totalParts > 0 ? costRepairs / totalParts : 0; const priceGarage = totalGarageCells > 0 ? costGarage / totalGarageCells : 0;
            let collectedRepair = 0, collectedMowing = 0, collectedSeptic = 0, collectedComplex = 0;
            document.querySelectorAll('#mainTable tbody tr').forEach(r => { if(r.querySelector('.status-select').value === 'paid') { const people = parseFloat(r.querySelector('.inp-people').value)||0; const parts = parseFloat(r.querySelector('.inp-parts').value)||0; collectedRepair += parts * priceRepair; if(totalPeople > 0) { collectedMowing += people * (val('c_mowing')/totalPeople); collectedSeptic += people * (val('c_septic')/totalPeople); collectedComplex += people * (val('c_clean_complex')/totalPeople); } } });
            const getFundStatus = (type, startVal, collectedVal) => { const start = startVal; const spent = expenses.filter(e => e.type === type).reduce((sum, e) => sum + e.cost, 0); const end = start + collectedVal - spent; return `   –ù–∞—á–∞–ª–æ: ${format(start)} | +${format(collectedVal)} | -${format(spent)} | –ö—Ä–∞–π: ${format(end)}`; };
            let txt = `üè¢ –ü–™–õ–ù–ê –†–ê–ó–ë–ò–í–ö–ê –ù–ê –†–ê–ó–•–û–î–ò–¢–ï - –ë–õ–û–ö 7–î\nüóìÔ∏è –ú–µ—Å–µ—Ü: ${dateStr}\n========================================\n`;
            txt += `üìâ –û–¢–ß–ï–¢ –ù–ê –†–ê–ó–•–û–î–ò–¢–ï (–°–ú–ï–¢–ö–ò):\n1. –¢–æ–∫ –í—Ö–æ–¥: ${format(val('c_tok_vhod'))}\n2. –¢–æ–∫ –ê—Å–∞–Ω—Å—å–æ—Ä: ${format(val('c_tok_lift'))}\n3. –¢–æ–∫ –¢–æ–∫ –Ω–∞ –ê–±–æ–Ω–∞—Ç–Ω–∞: ${format(val('c_tok_abonatna'))}\n4. –ê—Å–∞–Ω—Å—å–æ—Ä (–¢–∞–∫—Å–∞): ${format(val('c_lift_month'))}\n5. –ê—Å–∞–Ω—Å—å–æ—Ä –°–≤—ä—Ä–∑–≤–∞–Ω–µ: ${format(val('c_lift_conn'))} (–ì–æ–¥.) -> ${format(liftConnMonthly)} /–º–µ—Å.\n6. –ê—Å–∞–Ω—Å—å–æ—Ä –ü—Ä–µ–≥–ª–µ–¥: ${format(val('c_lift_tech'))} (–ì–æ–¥.) -> ${format(liftTechMonthly)} /–º–µ—Å.\n7. –ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ –í—Ö–æ–¥: ${format(val('c_clean_vhod'))}\n8. –ì–∞—Ä–∞–∂ (–¢–æ–∫+–ü–æ—á): ${format(costGarage)}\n9. –ü–æ–¥–¥—Ä—ä–∂–∫–∞ (–ö–æ—Å–µ–Ω–µ/–Ø–º–∞/–ö–æ–º–ø–ª): ${format(costMaintenance)}\n----------------------------------------\n–û–ë–©–û –†–ê–ó–•–û–î–ò –ó–ê –ú–ï–°–ï–¶–ê: ${format(totalMonthlyCosts)}\n========================================\n\n`;
            txt += `üí∞ –°–™–°–¢–û–Ø–ù–ò–ï –ù–ê –§–û–ù–î–û–í–ï–¢–ï:\nüõ†Ô∏è –§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç:\n${getFundStatus('repair', val('bal_repair_start'), collectedRepair)}\nüå± –§–æ–Ω–¥ –ö–æ—Å–µ–Ω–µ:\n${getFundStatus('mowing', val('bal_mowing_start'), collectedMowing)}\nüíß –°–µ–ø—Ç–∏—á–Ω–∞ —è–º–∞:\n${getFundStatus('septic', val('bal_septic_start'), collectedSeptic)}\nüßπ –ü–æ—á. –ö–æ–º–ø–ª–µ–∫—Å:\n${getFundStatus('complex', val('bal_complex_start'), collectedComplex)}\n========================================\n\n`;
            txt += `‚ÑπÔ∏è –¢–ê–†–ò–§–ò –ó–ê –ú–ï–°–ï–¶–ê:\nüîπ –û–±—â–∏ (–¢–æ–∫/–í–æ–¥–∞/–ê—Å): ${format(priceCommon)} / —á–æ–≤–µ–∫\nüîπ –ü–æ–¥–¥—Ä—ä–∂–∫–∞ (–ö–æ—Å–µ–Ω–µ/–Ø–º–∞): ${format(priceMaint)} / —á–æ–≤–µ–∫\nüîπ –§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç: –°–ø–æ—Ä–µ–¥ % –∏–¥. —á–∞—Å—Ç–∏\nüöó –ì–∞—Ä–∞–∂: ${format(priceGarage)} / –∫–ª–µ—Ç–∫–∞\n========================================\n\n`;
            let grandTotalSum = 0; document.querySelectorAll('#mainTable tbody tr').forEach(row => { const apt = row.querySelector('.apt-fixed').value; const name = row.querySelector('.inp-names').value; const people = parseFloat(row.querySelector('.inp-people').value)||0; const garage = parseFloat(row.querySelector('.inp-garage').value)||0; const parts = parseFloat(row.querySelector('.inp-parts').value)||0; const oldDebt = valEl(row.querySelector('.inp-old-debt')); const evCost = valEl(row.querySelector('.inp-ev')); const isPaid = row.querySelector('.status-select').value === 'paid'; let aptCommon = 0, aptMaint = 0, aptRepair = 0; if(apt !== '1.3') { aptCommon = people * priceCommon; aptMaint = people * priceMaint; aptRepair = parts * priceRepair; } const aptGarage = garage * priceGarage; const totalDue = aptCommon + aptMaint + aptRepair + aptGarage + evCost + oldDebt; grandTotalSum += totalDue; txt += `üè† –ê–ü–ê–†–¢–ê–ú–ï–ù–¢ ${apt} (${name})\n   -------------------------------------\n`; if(apt === '1.3' || people === 0) { txt += `   üö´ –ù–µ–æ–±–∏—Ç–∞–µ–º (0.00 –ª–≤. –æ–±—â–∏)\n`; } else { txt += `   üë§ –û–±—â–∏ (${people} ${people === 1 ? '–∂–∏–≤—É—â' : '–∂–∏–≤—É—â–∏'}): ${format(aptCommon)}\n   üå± –ü–æ–¥–¥—Ä—ä–∂–∫–∞: ${format(aptMaint)}\n   üõ†Ô∏è –†–µ–º–æ–Ω—Ç (${parts}%): ${format(aptRepair)}\n`; } if(garage > 0) txt += `   üöó –ì–∞—Ä–∞–∂ (${garage} –±—Ä.): ${format(aptGarage)}\n`; if(evCost > 0) txt += `   üîå EV –ó–∞—Ä–µ–∂–¥–∞–Ω–µ: ${format(evCost)}\n`; if(oldDebt > 0) txt += `   ‚ö†Ô∏è –°—Ç–∞—Ä–∏ –∑–∞–¥—ä–ª–∂–µ–Ω–∏—è: ${format(oldDebt)}\n`; txt += `   üí∞ –¢–û–¢–ê–õ –î–™–õ–ñ–ò–ú–û: ${format(totalDue)}\n   üìù –°—Ç–∞—Ç—É—Å: ${isPaid ? '‚úÖ –ü–õ–ê–¢–ï–ù–û' : '‚ùå –ù–ï–ü–õ–ê–¢–ï–ù–û'}\n\n`; });
            txt += `========================================\n–ö—Ä–∞–π–Ω–∞ —Å—É–º–∞ –Ω–∞ –æ—Ç—á–µ—Ç–∞: ${format(grandTotalSum)}`;
            document.getElementById('reportText').value = txt; document.getElementById('reportModal').classList.remove('hidden');
        }

        function saveGHCreds() { localStorage.setItem(GH_KEY, JSON.stringify({token: document.getElementById('gh-token').value, gist: document.getElementById('gh-gist').value})); alert('–ö–ª—é—á–æ–≤–µ—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!'); document.getElementById('settingsModal').classList.add('hidden'); }
        async function pullFromGitHub() { const c = JSON.parse(localStorage.getItem(GH_KEY) || '{}'); if(!c.token || !c.gist) return alert("–õ–∏–ø—Å–≤–∞—Ç –∫–ª—é—á–æ–≤–µ!"); const btn = document.getElementById('btn-pull'); btn.innerHTML = `<div class="loader"></div>`; try { const req = await fetch(`https://api.github.com/gists/${c.gist}`, { headers: { 'Authorization': `token ${c.token}` } }); if(!req.ok) throw new Error("GitHub Error"); const json = await req.json(); const content = json.files['block7d.json'].content; localStorage.setItem(`condo_${document.getElementById('reportDate').value}`, JSON.stringify(JSON.parse(content))); loadData(); alert('–ò–∑—Ç–µ–≥–ª–µ–Ω–æ!'); } catch(e) { alert("–ì—Ä–µ—à–∫–∞: " + e.message); } finally { btn.innerHTML = `<i class="ri-download-cloud-2-fill"></i> –ò–ó–¢–ï–ì–õ–ò`; } }
        async function pushToGitHub() { const c = JSON.parse(localStorage.getItem(GH_KEY) || '{}'); if(!c.token || !c.gist) return alert("–õ–∏–ø—Å–≤–∞—Ç –∫–ª—é—á–æ–≤–µ!"); saveData(true); const btn = document.getElementById('btn-push'); btn.innerHTML = `<div class="loader"></div>`; try { const dataToPush = localStorage.getItem(`condo_${document.getElementById('reportDate').value}`); const req = await fetch(`https://api.github.com/gists/${c.gist}`, { method: 'PATCH', headers: { 'Authorization': `token ${c.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ files: { "block7d.json": { content: dataToPush } } }) }); if(!req.ok) throw new Error("GitHub Error"); alert('–ö–∞—á–µ–Ω–æ!'); } catch(e) { alert("–ì—Ä–µ—à–∫–∞: " + e.message); } finally { btn.innerHTML = `<i class="ri-upload-cloud-2-fill"></i> –ö–ê–ß–ò`; } }

        function val(id) { return parseFloat(document.getElementById(id).value)||0; }
        function valEl(el) { return parseFloat(el.value)||0; }
        function updateMonthlyHints() { document.getElementById('hint_conn').innerText = `(${ (val('c_lift_conn')/12).toFixed(2) }/–º)`; document.getElementById('hint_tech').innerText = `(${ (val('c_lift_tech')/12).toFixed(2) }/–º)`; }
        function renderDatePicker() { document.getElementById('displayYear').innerText = currentYear; document.getElementById('printDateLabel').innerText = `–ü–µ—Ä–∏–æ–¥: ${currentYear}-${currentMonth}`; const grid = document.getElementById('monthsGrid'); grid.innerHTML = ''; ["–Ø–Ω—É", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–Æ–Ω–∏", "–Æ–ª–∏", "–ê–≤–≥", "–°–µ–ø", "–û–∫—Ç", "–ù–æ–µ", "–î–µ–∫"].forEach((name, index) => { const btn = document.createElement('button'); btn.className = `p-2 rounded-lg text-sm font-bold transition ${index + 1 === currentMonth ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-50 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-600'}`; btn.innerText = name; btn.onclick = () => { currentMonth = index + 1; updateHiddenInput(); renderDatePicker(); loadData(); }; grid.appendChild(btn); }); }
        function changeYear(d) { currentYear += d; updateHiddenInput(); renderDatePicker(); loadData(); }
        function updateHiddenInput() { document.getElementById('reportDate').value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`; }
        
        function renderTable(savedData) {
            const tbody = document.querySelector('#mainTable tbody'); tbody.innerHTML = ''; 
            
            appConfig.apartments.forEach((fixedApt) => {
                let savedApt = savedData ? savedData.find(s => s.name === fixedApt.name) : null; const ownerNames = savedApt ? (savedApt.names || fixedApt.names) : fixedApt.names; const people = savedApt ? savedApt.people : fixedApt.people; const garageCells = savedApt ? savedApt.garageCells : fixedApt.garage; const oldDebt = (savedApt ? savedApt.oldDebt : 0); const evCost = (savedApt ? (savedApt.evCost || 0) : 0); const status = savedApt ? savedApt.status : 'unpaid'; const comment = savedApt ? savedApt.comment : '';
                const tr = document.createElement('tr'); tr.className = status === 'paid' ? "bg-emerald-50/50 dark:bg-emerald-900/20" : "";
                
                if(selectedApts.has(fixedApt.name)) tr.classList.add('row-selected');

                tr.innerHTML = `
                    <td class="px-2 py-3 text-center bg-white dark:bg-slate-900 border-r border-slate-100 dark:border-slate-800 no-print sticky-col-check">
                        <input type="checkbox" class="custom-checkbox row-checkbox" value="${fixedApt.name}" ${selectedApts.has(fixedApt.name)?'checked':''} onchange="toggleRow('${fixedApt.name}')">
                    </td>
                    <td class="px-3 py-3 sticky-col-apt bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-700"><button onclick="generateReport('${fixedApt.name}')" class="font-bold text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 px-3 py-1.5 rounded-lg text-xs w-full transition no-print border border-transparent hover:border-blue-100 dark:hover:border-blue-800">${fixedApt.name}</button><span class="hidden print-only font-bold">${fixedApt.name}</span><input type="hidden" class="apt-fixed" value="${fixedApt.name}"></td>
                    <td class="px-3 py-3"><input type="text" class="inp-names w-full bg-transparent text-xs text-slate-700 dark:text-slate-200 font-medium input-modern px-1 rounded" value="${ownerNames}"></td>
                    <td class="px-2 py-3"><input type="number" class="apt-fixed-input inp-people w-10 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded text-center text-xs p-1 mx-auto block font-bold dark:text-white" value="${people}"></td>
                    <td class="px-2 py-3"><input type="number" class="apt-fixed-input inp-garage w-10 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded text-center text-xs p-1 mx-auto block font-bold dark:text-white" value="${garageCells}"></td>
                    <td class="px-2 py-3"><input type="number" class="inp-ev w-16 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-medium rounded text-center text-xs p-1 border border-blue-100 dark:border-blue-800 font-bold mx-auto block input-modern" value="${evCost.toFixed(2)}"></td>
                    <input type="hidden" class="inp-parts" value="${fixedApt.parts}">
                    <td class="px-3 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 res-current">0</td>
                    <input type="hidden" class="res-current-val" value="0">
                    <td class="px-3 py-3"><input type="number" class="inp-old-debt w-20 text-right text-rose-500 font-bold bg-transparent text-xs input-modern px-1 rounded" value="${oldDebt.toFixed(2)}"></td>
                    <td class="px-3 py-3 text-right font-black text-slate-800 dark:text-white text-sm res-grand-total">0</td>
                    <input type="hidden" class="res-grand-total-val" value="0">
                    <td class="px-3 py-3 text-center no-print"><select class="status-select text-xs w-full text-center rounded-lg px-2 py-1.5 cursor-pointer transition border-0 ring-1 ring-slate-200 dark:ring-slate-700 shadow-sm font-bold ${status==='paid'?'badge-paid':'badge-unpaid'}" onchange="changeStatus(this)"><option value="unpaid">–ù–ï–ü–õ–ê–¢–ï–ù–û</option><option value="paid" ${status==='paid'?'selected':''}>–ü–õ–ê–¢–ï–ù–û</option></select></td>
                    <td class="px-3 py-3 no-print"><input type="text" class="inp-comment w-full bg-transparent text-xs text-slate-400 italic input-modern px-1 rounded" value="${comment}" placeholder="..."></td>`;
                tbody.appendChild(tr);
            });
            calculate();
        }

        function changeStatus(sel) { const row = sel.closest('tr'); if(sel.value === 'paid') { row.classList.add('bg-emerald-50/50', 'dark:bg-emerald-900/20'); sel.className = "status-select text-xs w-full text-center rounded-lg px-2 py-1.5 cursor-pointer transition border-0 ring-1 ring-emerald-200 dark:ring-emerald-800 shadow-sm font-bold badge-paid"; } else { row.classList.remove('bg-emerald-50/50', 'dark:bg-emerald-900/20'); sel.className = "status-select text-xs w-full text-center rounded-lg px-2 py-1.5 cursor-pointer transition border-0 ring-1 ring-red-200 dark:ring-red-900 shadow-sm font-bold badge-unpaid"; } }
        
        // Helper to format Money
        function formatMoney(eur) {
            const bgn = eur * EUR_RATE;
            return `${eur.toFixed(2)} ‚Ç¨ <span class="text-[10px] text-slate-400 font-normal">(${bgn.toFixed(2)} –ª–≤.)</span>`;
        }

        function formatMoneyWhite(eur) {
            const bgn = eur * EUR_RATE;
            return `${eur.toFixed(2)} ‚Ç¨ <span class="text-[10px] text-slate-300 font-normal">(${bgn.toFixed(2)} –ª–≤.)</span>`;
        }

        function calculate() {
            const symbol = '‚Ç¨'; document.querySelectorAll('.currency-symbol').forEach(el => el.innerText = symbol);
            const liftConnMonthly = val('c_lift_conn')/12; const liftTechMonthly = val('c_lift_tech')/12; const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod'); const costGarage = val('c_tok_garaj') + val('c_clean_garaj'); const costMaintenance = val('c_clean_complex') + val('c_mowing') + val('c_septic'); const costRepairs = val('c_repair');
            let totalPeople = 0, totalGarageCells = 0, totalParts = 0; document.querySelectorAll('#mainTable tbody tr').forEach(row => { totalPeople += parseFloat(row.querySelector('.inp-people').value)||0; totalGarageCells += parseFloat(row.querySelector('.inp-garage').value)||0; totalParts += parseFloat(row.querySelector('.inp-parts').value)||0; });
            const priceGarageCell = totalGarageCells>0?costGarage/totalGarageCells:0; const pricePerPersonCommon = totalPeople>0?costCommon/totalPeople:0; const pricePerPersonMaint = totalPeople>0?costMaintenance/totalPeople:0; const priceRepairPart = totalParts>0?costRepairs/totalParts:0;
            let G_Grand = 0; 
            
            // Accumulate collected sums
            let sumRepair = 0;
            let sumMowing = 0;
            let sumSeptic = 0;
            let sumComplex = 0;

            document.querySelectorAll('#mainTable tbody tr').forEach(row => { const aptName = row.querySelector('.apt-fixed').value; const people = parseFloat(row.querySelector('.inp-people').value)||0; const garage = parseFloat(row.querySelector('.inp-garage').value)||0; const parts = parseFloat(row.querySelector('.inp-parts').value)||0; const debt = valEl(row.querySelector('.inp-old-debt')); const evCost = valEl(row.querySelector('.inp-ev')); const isPaid = row.querySelector('.status-select').value === 'paid'; let oweBase = 0; if(aptName !== '1.3') oweBase = (people * pricePerPersonCommon) + (people * pricePerPersonMaint) + (parts * priceRepairPart); const oweGarage = garage * priceGarageCell; const currentTotal = oweBase + oweGarage + evCost; const grandTotal = currentTotal + debt; 
            
            // Render HTML with small BGN
            row.querySelector('.res-current').innerHTML = formatMoney(currentTotal); 
            row.querySelector('.res-current-val').value = currentTotal;
            row.querySelector('.res-grand-total').innerHTML = formatMoney(grandTotal); 
            row.querySelector('.res-grand-total-val').value = grandTotal;

            G_Grand += grandTotal; 
            
            if (isPaid) { 
                sumRepair += (parts * priceRepairPart);
                if(totalPeople > 0) {
                    sumMowing += (people * (val('c_mowing')/totalPeople));
                    sumSeptic += (people * (val('c_septic')/totalPeople));
                    sumComplex += (people * (val('c_clean_complex')/totalPeople));
                }
            } 
            });
            
            document.getElementById('sum-grand').innerHTML = formatMoney(G_Grand);
            updateCollectionReport();
            
            // Update Funds ONCE at the end with the correct sums
            updateFundBalance('repair', sumRepair);
            updateFundBalance('mowing', sumMowing);
            updateFundBalance('septic', sumSeptic);
            updateFundBalance('complex', sumComplex);

            // Update Total Cash (Sum of Start + Collected, IGNORING EXPENSES)
            const totalCash = (val('bal_repair_start') + val('disp_repair_col_val')) + 
                              (val('bal_mowing_start') + val('disp_mowing_col_val')) + 
                              (val('bal_septic_start') + val('disp_septic_col_val')) + 
                              (val('bal_complex_start') + val('disp_complex_col_val'));
                              
            document.getElementById('total_cash_in_hand').innerHTML = formatMoneyWhite(totalCash);
        }

        function updateCollectionReport() {
            const sym = '‚Ç¨';
            const liftConnMonthly = val('c_lift_conn')/12; const liftTechMonthly = val('c_lift_tech')/12; const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod'); const costGarage = val('c_tok_garaj') + val('c_clean_garaj'); 
            let totalPeople = 0, totalGarageCells = 0, totalParts = 0; document.querySelectorAll('#mainTable tbody tr').forEach(row => { totalPeople += parseFloat(row.querySelector('.inp-people').value)||0; totalGarageCells += parseFloat(row.querySelector('.inp-garage').value)||0; totalParts += parseFloat(row.querySelector('.inp-parts').value)||0; });
            const priceGarageCell = totalGarageCells>0?costGarage/totalGarageCells:0; const priceCommon = totalPeople>0?costCommon/totalPeople:0; const priceMowing = totalPeople>0?val('c_mowing')/totalPeople:0; const priceSeptic = totalPeople>0?val('c_septic')/totalPeople:0; const priceComplex = totalPeople>0?val('c_clean_complex')/totalPeople:0; const priceRepair = totalParts>0?val('c_repair')/totalParts:0;
            let dueCommon=0, paidCommon=0; let dueGarage=0, paidGarage=0; let dueEV=0, paidEV=0; let dueRepair=0, paidRepair=0; let dueMowing=0, paidMowing=0; let dueSeptic=0, paidSeptic=0; let dueComplex=0, paidComplex=0;
            document.querySelectorAll('#mainTable tbody tr').forEach(row => { const aptName = row.querySelector('.apt-fixed').value; const people = parseFloat(row.querySelector('.inp-people').value)||0; const garage = parseFloat(row.querySelector('.inp-garage').value)||0; const parts = parseFloat(row.querySelector('.inp-parts').value)||0; const ev = valEl(row.querySelector('.inp-ev')); const isPaid = row.querySelector('.status-select').value === 'paid'; if(aptName !== '1.3') { dueCommon += people * priceCommon; dueRepair += parts * priceRepair; dueMowing += people * priceMowing; dueSeptic += people * priceSeptic; dueComplex += people * priceComplex; } dueGarage += garage * priceGarageCell; dueEV += ev; if(isPaid) { if(aptName !== '1.3') { paidCommon += people * priceCommon; paidRepair += parts * priceRepair; paidMowing += people * priceMowing; paidSeptic += people * priceSeptic; paidComplex += people * priceComplex; } paidGarage += garage * priceGarageCell; paidEV += ev; } });
            const rows = [ { label: '–û–±—â–∏ (–¢–æ–∫/–ê—Å/–ß–∏—Å—Ç)', due: dueCommon, paid: paidCommon }, { label: '–ì–∞—Ä–∞–∂ (–¢–æ–∫/–ü–æ—á)', due: dueGarage, paid: paidGarage }, { label: '–ï–ª. –ö–æ–ª–∏ (–ò–∑–≤—ä–Ω—Ä–µ–¥–Ω–æ)', due: dueEV, paid: paidEV }, { label: '–§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç', due: dueRepair, paid: paidRepair }, { label: '–§–æ–Ω–¥ –ö–æ—Å–µ–Ω–µ', due: dueMowing, paid: paidMowing }, { label: '–°–µ–ø—Ç–∏—á–Ω–∞ —è–º–∞', due: dueSeptic, paid: paidSeptic }, { label: '–ü–æ—á. –ö–æ–º–ø–ª–µ–∫—Å', due: dueComplex, paid: paidComplex }, ];
            const tbody = document.getElementById('collectionReportBody'); tbody.innerHTML = '';
            rows.forEach(r => { const diff = r.paid - r.due; const diffClass = diff < -0.01 ? 'text-rose-600 dark:text-rose-400 font-bold' : 'text-emerald-600 dark:text-emerald-400 font-bold'; const sign = diff > 0 ? '+' : ''; tbody.innerHTML += `<tr class="border-b border-slate-50 dark:border-slate-800 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-800"><td class="px-4 py-3 text-slate-700 dark:text-slate-300 font-medium">${r.label}</td><td class="px-4 py-3 text-right text-slate-500 dark:text-slate-400">${(r.due).toFixed(2)} ${sym}</td><td class="px-4 py-3 text-right text-slate-800 dark:text-white font-bold">${(r.paid).toFixed(2)} ${sym}</td><td class="px-4 py-3 text-right ${diffClass}">${sign}${(diff).toFixed(2)} ${sym}</td></tr>`; });
        }

        function updateFundBalance(type, collectedReal) { 
            const start = val(`bal_${type}_start`); const spent = expenses.filter(e => e.type === type).reduce((sum, e) => sum + e.cost, 0); const end = start + collectedReal - spent; 
            if(document.getElementById(`disp_${type}_col`)) {
                document.getElementById(`disp_${type}_col`).innerText = collectedReal.toFixed(0) + '‚Ç¨';
                document.getElementById(`disp_${type}_col_val`).value = collectedReal;
            }
            if(document.getElementById(`disp_${type}_spent`)) {
                document.getElementById(`disp_${type}_spent`).innerText = spent.toFixed(0) + '‚Ç¨';
                document.getElementById(`disp_${type}_spent_val`).value = spent;
            }
            if(document.getElementById(`bal_${type}_end`)) {
                document.getElementById(`bal_${type}_end`).innerText = end.toFixed(2) + ' ‚Ç¨';
                document.getElementById(`bal_${type}_end_val`).value = end;
            }
        }
        
        // Helper hidden inputs for calculations storage
        document.write(`
            <input type="hidden" id="disp_repair_col_val"><input type="hidden" id="disp_repair_spent_val"><input type="hidden" id="bal_repair_end_val">
            <input type="hidden" id="disp_mowing_col_val"><input type="hidden" id="disp_mowing_spent_val"><input type="hidden" id="bal_mowing_end_val">
            <input type="hidden" id="disp_septic_col_val"><input type="hidden" id="disp_septic_spent_val"><input type="hidden" id="bal_septic_end_val">
            <input type="hidden" id="disp_complex_col_val"><input type="hidden" id="disp_complex_spent_val"><input type="hidden" id="bal_complex_end_val">
        `);

        function addExpense() { const title = document.getElementById('newExpTitle').value; const cost = val('newExpCost'); const type = document.getElementById('newExpType').value; if(!title || isNaN(cost)) return; expenses.push({title, cost, type}); document.getElementById('newExpTitle').value = ''; document.getElementById('newExpCost').value = ''; renderExpenses(); calculate(); refreshRepairsTable(); }
        function removeExpense(idx) { expenses.splice(idx,1); renderExpenses(); calculate(); refreshRepairsTable(); }
        function renderExpenses() { const tb = document.querySelector('#expensesTable tbody'); tb.innerHTML = ''; expenses.forEach((e,i) => { tb.innerHTML += `<tr class="border-b border-slate-50 dark:border-slate-800"><td class="py-2 text-slate-700 dark:text-slate-300">${e.title}</td><td class="text-xs text-slate-400">${e.type}</td><td class="text-right font-bold text-slate-800 dark:text-white">${(e.cost).toFixed(2)} ‚Ç¨</td><td class="text-right no-print"><button onclick="removeExpense(${i})" class="text-rose-400 hover:text-rose-500">&times;</button></td></tr>`; }); }
        function refreshRepairsTable() { const totalRepairExpenses = expenses.filter(e => e.type === 'repair').reduce((sum, e) => sum + e.cost, 0); const savedString = localStorage.getItem(`condo_${document.getElementById('reportDate').value}`); let savedData = savedString ? JSON.parse(savedString).rows : null; renderRepairsBreakdown(totalRepairExpenses, savedData); }
        
        // --- MODIFIED REPAIRS RENDER ---
        function renderRepairsBreakdown(totalRepairExpenses, savedData) { 
            const tbody = document.querySelector('#repairsBreakdownTable tbody'); tbody.innerHTML = ''; let totalParts = 0; appConfig.apartments.forEach(a => totalParts += a.parts); 
            
            // Vars for footer totals
            let sumShare = 0;
            let sumPaid = 0;

            appConfig.apartments.forEach((apt) => { 
                const share = (totalRepairExpenses * apt.parts) / totalParts; 
                let paidSoFar = 0; let savedRepairStatus = 'unpaid'; let savedNote = ''; let savedName = apt.names;
                if(savedData) { 
                    const savedRow = savedData.find(r => r.name === apt.name); 
                    if(savedRow) {
                        if(savedRow.repairPaid) paidSoFar = parseFloat(savedRow.repairPaid); 
                        if(savedRow.repairStatus) savedRepairStatus = savedRow.repairStatus; 
                        if(savedRow.repairNote) savedNote = savedRow.repairNote;
                        if(savedRow.repairName) savedName = savedRow.repairName;
                    }
                } 
                const diff = share - paidSoFar; let colorClass = diff > 0.01 ? 'text-rose-500' : 'text-emerald-500 dark:text-emerald-400'; 
                
                // Accumulate Totals
                sumShare += share;
                sumPaid += paidSoFar;

                // Color logic for dropdown
                let statusColorClass = 'status-unpaid';
                if(savedRepairStatus === 'paid') statusColorClass = 'status-paid';
                if(savedRepairStatus === 'partial') statusColorClass = 'status-partial';

                let selectClass = `repair-status-select rounded text-xs py-1 px-1 w-full font-bold ${statusColorClass}`; 
                
                tbody.innerHTML += `<tr>
                    <td class="px-3 py-3 font-bold text-slate-700 dark:text-slate-200">${apt.name}</td>
                    <td class="px-3 py-3"><input type="text" class="inp-repair-name w-full bg-transparent text-xs text-slate-700 dark:text-slate-200 font-medium input-modern px-1 rounded" value="${savedName}" onchange="saveData(true)"></td>
                    <td class="px-3 py-3 text-center text-slate-500 dark:text-slate-400">${apt.parts}%</td>
                    <td class="px-3 py-3 text-right">${(share).toFixed(2)} ‚Ç¨</td>
                    <td class="px-3 py-3 text-right"><input type="number" class="inp-repair-paid w-20 text-right bg-slate-50 dark:bg-slate-800 dark:text-white rounded p-1 text-xs input-modern font-bold" value="${(paidSoFar).toFixed(2)}" onchange="saveData(true); refreshRepairsTable()"></td>
                    <td class="px-3 py-3 text-right font-bold ${colorClass}">${(diff).toFixed(2)} ‚Ç¨</td>
                    <td class="px-3 py-3 text-center no-print">
                        <select class="${selectClass}" onchange="updateRepairStatus(this)">
                            <option value="unpaid" ${savedRepairStatus==='unpaid'?'selected':''}>–ù–ï–ü–õ–ê–¢–ï–ù–û</option>
                            <option value="partial" ${savedRepairStatus==='partial'?'selected':''}>–ß–ê–°–¢–ò–ß–ù–û</option>
                            <option value="paid" ${savedRepairStatus==='paid'?'selected':''}>–ü–õ–ê–¢–ï–ù–û</option>
                        </select>
                    </td>
                    <td class="px-3 py-3 no-print"><input type="text" class="inp-repair-note w-full bg-slate-50 dark:bg-slate-800 dark:text-slate-300 rounded px-2 py-1 text-xs input-modern" value="${savedNote}" placeholder="..." onchange="saveData(true)"></td>
                </tr>`; 
            }); 

            // Render Footer Totals
            const sumDiff = sumShare - sumPaid;
            let diffColor = sumDiff > 0.01 ? 'text-rose-600 dark:text-rose-400' : 'text-emerald-600 dark:text-emerald-400';
            
            document.getElementById('rep_sum_due').innerHTML = formatMoney(sumShare);
            document.getElementById('rep_sum_paid').innerHTML = formatMoney(sumPaid);
            document.getElementById('rep_sum_diff').innerHTML = formatMoney(sumDiff);
            document.getElementById('rep_sum_diff').className = `px-3 py-4 text-right font-black ${diffColor}`;
        }

        function updateRepairStatus(sel) { 
            // Update Color immediately
            if(sel.value === 'paid') sel.className = "repair-status-select rounded text-xs py-1 px-1 w-full font-bold status-paid";
            else if(sel.value === 'partial') sel.className = "repair-status-select rounded text-xs py-1 px-1 w-full font-bold status-partial";
            else sel.className = "repair-status-select rounded text-xs py-1 px-1 w-full font-bold status-unpaid";
            
            saveData(true); 
            refreshRepairsTable(); 
        }

        function saveData(silent = false) { 
            const rows = []; 
            document.querySelectorAll('#mainTable tbody tr').forEach(r => { 
                const aptName = r.querySelector('.apt-fixed').value; 
                let repairPaidVal = 0; let repairStatusVal = 'unpaid'; let repairNoteVal = ''; let repairNameVal = '';
                const breakdownRows = document.querySelectorAll('#repairsBreakdownTable tbody tr'); 
                for(let br of breakdownRows) { 
                    if(br.cells[0].innerText.includes(aptName)) { 
                        repairPaidVal = valEl(br.querySelector('.inp-repair-paid')); 
                        repairStatusVal = br.querySelector('select').value; 
                        repairNoteVal = br.querySelector('.inp-repair-note').value;
                        repairNameVal = br.querySelector('.inp-repair-name').value;
                        break; 
                    } 
                } 
                rows.push({ name: aptName, names: r.querySelector('.inp-names').value, people: r.querySelector('.inp-people').value, garageCells: r.querySelector('.inp-garage').value, evCost: valEl(r.querySelector('.inp-ev')), oldDebt: valEl(r.querySelector('.inp-old-debt')), status: r.querySelector('.status-select').value, comment: r.querySelector('.inp-comment').value, repairPaid: repairPaidVal, repairStatus: repairStatusVal, repairNote: repairNoteVal, repairName: repairNameVal }); 
            }); 
            const inputs = {}; currencyInputs.forEach(id => { if(document.getElementById(id)) inputs[id] = val(id); }); 
            const data = { rows, inputs, expenses, info: document.getElementById('persistentInfo').value, billStatus: billStatus }; 
            localStorage.setItem(`condo_${document.getElementById('reportDate').value}`, JSON.stringify(data)); 
            if(!silent) alert('–ó–∞–ø–∞–∑–µ–Ω–æ –ª–æ–∫–∞–ª–Ω–æ!'); 
        }

        function loadData() { 
            const key = `condo_${document.getElementById('reportDate').value}`; const stored = localStorage.getItem(key); if(stored) { const data = JSON.parse(stored); expenses = data.expenses || []; billStatus = data.billStatus || {}; renderTable(data.rows); if(data.inputs) for(let k in data.inputs) if(document.getElementById(k)) document.getElementById(k).value = data.inputs[k]; if(data.info) document.getElementById('persistentInfo').value = data.info; renderExpenses(); const totalRepairExpenses = expenses.filter(e => e.type === 'repair').reduce((sum, e) => sum + e.cost, 0); renderRepairsBreakdown(totalRepairExpenses, data.rows); renderBillStatus(); } else { expenses = []; billStatus = {}; renderTable(null); renderExpenses(); renderRepairsBreakdown(0, null); renderBillStatus(); } calculate(); 
        }

        function generateViberMessage() { calculate(); const dateStr = document.getElementById('reportDate').value; let text = `üè¢ *–ë–ª–æ–∫ 7–î | –û—Ç—á–µ—Ç ${dateStr}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`; let totalUnpaid = 0; document.querySelectorAll('#mainTable tbody tr').forEach(row => { const apt = row.querySelector('.apt-fixed').value; const name = row.querySelector('.inp-names').value.split(' ')[0]; const total = row.querySelector('.res-grand-total-val').value; const isPaid = row.querySelector('.status-select').value === 'paid'; if(!isPaid) totalUnpaid += parseFloat(total); text += `${isPaid ? '‚úÖ' : 'üî¥'} –ê–ø.${apt} (${name}): ${parseFloat(total).toFixed(2)} ‚Ç¨\n`; }); text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ –ó–∞ —Å—ä–±–∏—Ä–∞–Ω–µ: ${totalUnpaid.toFixed(2)} ‚Ç¨\n`; document.getElementById('reportText').value = text; document.getElementById('reportModal').classList.remove('hidden'); }
        
        function generateRepairViberReport() {
            calculate(); 
            const totalRepairCost = expenses.filter(e => e.type === 'repair').reduce((a, b) => a + b.cost, 0);
            let totalParts = 0;
            appConfig.apartments.forEach(a => totalParts += a.parts);

            let txt = `üõ†Ô∏è *–°–ü–†–ê–í–ö–ê –§–û–ù–î –†–ï–ú–û–ù–¢* üõ†Ô∏è\n`;
            txt += `üè¢ –ë–ª–æ–∫ 7–î | ${document.getElementById('reportDate').value}\n`;
            txt += `üìâ –û–±—â —Ä–∞–∑—Ö–æ–¥ –∑–∞ –ø–æ–∫—Ä–∏–≤–∞–Ω–µ: ${totalRepairCost.toFixed(2)} ‚Ç¨\n`;
            txt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

            let sumDue = 0, sumPaid = 0;
            const savedData = JSON.parse(localStorage.getItem(`condo_${document.getElementById('reportDate').value}`) || '{}').rows || [];

            appConfig.apartments.forEach(apt => {
                const share = (totalRepairCost * apt.parts) / totalParts;
                let paid = 0;
                let status = 'unpaid';
                let note = '';
                let name = apt.names;

                const saved = savedData.find(r => r.name === apt.name);
                if(saved) {
                    paid = parseFloat(saved.repairPaid) || 0;
                    status = saved.repairStatus;
                    note = saved.repairNote || '';
                    if(saved.repairName) name = saved.repairName;
                }

                const bal = share - paid;
                sumDue += share;
                sumPaid += paid;

                let icon = 'üî¥';
                if(status === 'paid') icon = '‚úÖ';
                if(status === 'partial') icon = '‚ö†Ô∏è';

                txt += `${icon} *–ê–ø. ${apt.name}* (${name})\n`;
                txt += `   üîπ –î—è–ª: ${share.toFixed(2)} ‚Ç¨\n`;
                txt += `   üíµ –ü–ª–∞—Ç–∏–ª: ${paid.toFixed(2)} ‚Ç¨\n`;
                if(Math.abs(bal) > 0.01) {
                     if(bal > 0) txt += `   ‚ùó –î—ä–ª–∂–∏: ${bal.toFixed(2)} ‚Ç¨\n`;
                     else txt += `   ‚Ü©Ô∏è –ù–∞–¥–≤–Ω–µ—Å—ä–ª: ${Math.abs(bal).toFixed(2)} ‚Ç¨\n`;
                }
                if(note) txt += `   üìù –ë–µ–ª: ${note}\n`;
                txt += `------------------\n`;
            });

            txt += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            txt += `üí∞ *–û–ë–©–û –ó–ê –í–•–û–î–ê*\n`;
            txt += `üì• –¢—Ä—è–±–≤–∞ –¥–∞ —Å–µ —Å—ä–±–µ—Ä–∞—Ç: ${sumDue.toFixed(2)} ‚Ç¨\n`;
            txt += `üì§ –†–µ–∞–ª–Ω–æ —Å—ä–±—Ä–∞–Ω–∏: ${sumPaid.toFixed(2)} ‚Ç¨\n`;
            const diff = sumPaid - sumDue;
            txt += `${diff >= 0 ? 'üü¢' : 'üî¥'} –ë–∞–ª–∞–Ω—Å: ${diff.toFixed(2)} ‚Ç¨\n`;

            document.getElementById('reportText').value = txt;
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function copyReportText() { const el = document.getElementById('reportText'); el.select(); navigator.clipboard.writeText(el.value).then(() => alert('–ö–æ–ø–∏—Ä–∞–Ω–æ!')); }
        function generateReport(aptName) { calculate(); const row = Array.from(document.querySelectorAll('#mainTable tbody tr')).find(r => r.querySelector('.apt-fixed').value === aptName); if(!row) return; const name = row.querySelector('.inp-names').value; const people = parseFloat(row.querySelector('.inp-people').value)||0; const garage = parseFloat(row.querySelector('.inp-garage').value)||0; const parts = parseFloat(row.querySelector('.inp-parts').value)||0; const evCost = parseFloat(row.querySelector('.inp-ev').value)||0; const isPaid = row.querySelector('.status-select').value === 'paid'; const dateStr = document.getElementById('reportDate').value; let totalPeople = 0, totalGarageCells = 0, totalParts = 0; document.querySelectorAll('#mainTable tbody tr').forEach(r => { totalPeople += parseFloat(r.querySelector('.inp-people').value)||0; totalGarageCells += parseFloat(r.querySelector('.inp-garage').value)||0; totalParts += parseFloat(r.querySelector('.inp-parts').value)||0; }); const liftConnMonthly = val('c_lift_conn')/12; const liftTechMonthly = val('c_lift_tech')/12; const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod'); const costGarageTotal = val('c_tok_garaj') + val('c_clean_garaj'); const costMaintenance = val('c_clean_complex') + val('c_mowing') + val('c_septic'); const costRepairs = val('c_repair'); const priceGarage = totalGarageCells>0?costGarageTotal/totalGarageCells:0; const priceCommon = totalPeople>0?costCommon/totalPeople:0; const priceMaint = totalPeople>0?costMaintenance/totalPeople:0; const priceRepair = totalParts>0?costRepairs/totalParts:0; const aptCommon = people * priceCommon; const aptMaint = people * priceMaint; const aptRepair = parts * priceRepair; const aptGarage = garage * priceGarage; const debt = parseFloat(row.querySelector('.inp-old-debt').value)||0; const aptTotal = aptCommon + aptMaint + aptRepair + aptGarage + evCost + debt; const fmt = (val) => `${val.toFixed(2)} ‚Ç¨ (${(val*EUR_RATE).toFixed(2)} –ª–≤.)`; let txt = `üè¢ –ö–ê–°–û–í–ê –ë–ï–õ–ï–ñ–ö–ê - –ë–õ–û–ö 7–î\nüóìÔ∏è –ü–µ—Ä–∏–æ–¥: ${dateStr}\nüë§ –ê–ø. ${aptName} (${name})\n----------------------------------------\n`; const pLabel = people === 1 ? '–∂–∏–≤—É—â' : '–∂–∏–≤—É—â–∏'; if(aptName !== '1.3' && people > 0) { txt += `‚ö° –û–±—â–∏ (–¢–æ–∫/–ê—Å/–ß–∏—Å—Ç): ${people} ${pLabel} x ${priceCommon.toFixed(2)} ‚Ç¨ = ${fmt(aptCommon)}\n`; txt += `üå± –ü–æ–¥–¥—Ä—ä–∂–∫–∞ (–ö–æ—Å–µ–Ω–µ/–Ø–º–∞): ${people} ${pLabel} x ${priceMaint.toFixed(2)} ‚Ç¨ = ${fmt(aptMaint)}\n`; txt += `üõ†Ô∏è –§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç (${parts}%): ${fmt(aptRepair)}\n`; } else if(aptName === '1.3') txt += `‚ÑπÔ∏è –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç 1.3 –µ –æ—Å–≤–æ–±–æ–¥–µ–Ω –æ—Ç —Ç–∞–∫—Å–∏.\n`; if(garage > 0) txt += `üöó –ì–∞—Ä–∞–∂ (–¢–æ–∫/–ü–æ—á): ${garage} –±—Ä. x ${priceGarage.toFixed(2)} ‚Ç¨ = ${fmt(aptGarage)}\n`; if(evCost > 0) txt += `üîå EV: ${fmt(evCost)}\n`; if(debt > 0) txt += `‚ö†Ô∏è –°—Ç–∞—Ä–∏ –∑–∞–¥—ä–ª–∂–µ–Ω–∏—è: ${fmt(debt)}\n`; txt += `----------------------------------------\nüí∞ –û–ë–©–û –ó–ê –ü–õ–ê–©–ê–ù–ï: ${fmt(aptTotal)}\nüìù –°–¢–ê–¢–£–°: ${isPaid ? '‚úÖ –ü–õ–ê–¢–ï–ù–û' : '‚ùå –ù–ï–ü–õ–ê–¢–ï–ù–û'}`; document.getElementById('reportText').value = txt; document.getElementById('reportModal').classList.remove('hidden'); }

        // --- NEW FEATURES: BULK & SETTINGS ---
        function toggleSelectAll() { const all = document.getElementById('selectAllCheckbox').checked; selectedApts.clear(); if(all) appConfig.apartments.forEach(a => selectedApts.add(a.name)); updateBulkUI(); }
        function toggleRow(name) { 
            const cb = document.querySelector(`.row-checkbox[value="${name}"]`);
            if(selectedApts.has(name)) {
                selectedApts.delete(name);
                cb.closest('tr').classList.remove('row-selected');
            } else {
                selectedApts.add(name);
                cb.closest('tr').classList.add('row-selected');
            }
            updateBulkUI(); 
        }
        function updateBulkUI() { 
            const b = document.getElementById('bulkActionBar'); 
            document.getElementById('selectedCount').innerText = selectedApts.size; 
            document.querySelectorAll('.row-checkbox').forEach(c => {
                c.checked = selectedApts.has(c.value);
                const tr = c.closest('tr');
                if(c.checked) tr.classList.add('row-selected');
                else tr.classList.remove('row-selected');
            });
            if(selectedApts.size > 0) { b.classList.remove('hidden'); } else { b.classList.add('hidden'); document.getElementById('selectAllCheckbox').checked = false; } 
        }
        function openBulkPayModal() { document.getElementById('bulkCountDisplay').innerText = selectedApts.size; document.getElementById('bulkPayComment').value = ""; document.getElementById('bulkPayModal').classList.remove('hidden'); }
        function executeBulkPay() {
            const comment = document.getElementById('bulkPayComment').value;
            document.querySelectorAll('#mainTable tbody tr').forEach(row => {
                const name = row.querySelector('.apt-fixed').value;
                if(selectedApts.has(name)) {
                    const select = row.querySelector('.status-select');
                    select.value = 'paid';
                    changeStatus(select);
                    if(comment) row.querySelector('.inp-comment').value = comment;
                }
            });
            saveData(true);
            selectedApts.clear(); document.getElementById('bulkPayModal').classList.add('hidden'); updateBulkUI();
            alert('–£—Å–ø–µ—à–Ω–æ –º–∞—Ä–∫–∏—Ä–∞–Ω–∏!');
        }

        // Settings Modal & Editing
        function openSettings() {
            const tb = document.getElementById('settingsResidentsTable'); tb.innerHTML = '';
            appConfig.apartments.forEach((a, i) => {
                tb.innerHTML += `<tr><td class="p-2 font-bold">${a.name}</td><td class="p-2"><input type="text" value="${a.names}" class="border rounded-lg dark:border-slate-600 dark:bg-slate-700 w-full px-2 py-1 text-xs" onchange="editApt(${i},'names',this.value)"></td><td class="p-2"><input type="number" value="${a.people}" class="border rounded-lg dark:border-slate-600 dark:bg-slate-700 w-12 text-center text-xs p-1" onchange="editApt(${i},'people',this.value)"></td><td class="p-2"><input type="number" value="${a.garage}" class="border rounded-lg dark:border-slate-600 dark:bg-slate-700 w-12 text-center text-xs p-1" onchange="editApt(${i},'garage',this.value)"></td><td class="p-2"><input type="number" value="${a.parts}" class="border rounded-lg dark:border-slate-600 dark:bg-slate-700 w-16 text-center text-xs p-1" onchange="editApt(${i},'parts',this.value)"></td></tr>`;
            });
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        function editApt(i, f, v) { if(f === 'names') appConfig.apartments[i].names = v; else appConfig.apartments[i][f] = parseFloat(v) || 0; }
        function saveSettingsAndReload() {
            localStorage.setItem(CONFIG_KEY, JSON.stringify(appConfig));
            document.getElementById('settingsModal').classList.add('hidden');
            loadData(); // Reload table with new config
            alert("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞!");
        }
    </script>
</body>
</html>

