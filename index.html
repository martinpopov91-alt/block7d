<!DOCTYPE html>
<html lang="bg" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>7D Finance (GitHub Sync)</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' },
                        primary: { DEFAULT: '#2563eb' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f1f5f9; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .sticky-col { position: sticky; left: 0; background: white; z-index: 10; border-right: 1px solid #f1f5f9; }
        input, select { -webkit-appearance: none; appearance: none; }
        
        .badge-paid { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; font-weight: 700; }
        .badge-unpaid { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; font-weight: 700; }
        
        .rep-paid { background: #dcfce7; color: #15803d; }
        .rep-partial { background: #ffedd5; color: #c2410c; }
        .rep-unpaid { background: #fee2e2; color: #b91c1c; }

        .mode-eur input { color: #2563eb; }
        .mode-bgn input { color: #334155; }
        
        /* Spinner */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 antialiased pb-24 lg:pb-10 mode-bgn" id="bodyRoot">

    <nav class="sticky top-0 z-50 glass-panel border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="ri-github-fill text-2xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-slate-900">–ë–ª–æ–∫ 7–î</h1>
                    <p class="text-xs text-slate-500 font-medium">GitHub Edition</p>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="toggleCurrency()" class="flex items-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg font-bold text-xs transition border border-slate-300">
                    <span id="currencyLabel">BGN</span>
                </button>
                <button onclick="document.getElementById('syncModal').classList.remove('hidden')" class="p-2 bg-slate-800 text-white rounded-lg shadow hover:bg-slate-700 transition" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è">
                    <i class="ri-settings-4-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 mt-6 space-y-6">

        <div class="bg-slate-800 rounded-2xl p-4 shadow-lg text-white flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                <span class="text-xs font-bold uppercase tracking-wider text-slate-300">GitHub Sync</span>
            </div>
            <div class="flex gap-2">
                <button id="btn-pull" onclick="pullFromGitHub()" class="bg-slate-700 hover:bg-slate-600 text-xs px-3 py-2 rounded-lg font-bold flex items-center gap-1"><i class="ri-download-cloud-2-fill"></i> –ò–ó–¢–ï–ì–õ–ò</button>
                <button id="btn-push" onclick="pushToGitHub()" class="bg-blue-600 hover:bg-blue-500 text-xs px-3 py-2 rounded-lg font-bold flex items-center gap-1"><i class="ri-upload-cloud-2-fill"></i> –ö–ê–ß–ò</button>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center justify-between">
            <button onclick="changeYear(-1)" class="p-2 bg-slate-50 rounded-full"><i class="ri-arrow-left-s-line"></i></button>
            <div class="text-center">
                <h2 class="text-xl font-extrabold text-slate-800" id="displayYear">2025</h2>
                <input type="month" id="reportDate" class="hidden">
            </div>
            <button onclick="changeYear(1)" class="p-2 bg-slate-50 rounded-full"><i class="ri-arrow-right-s-line"></i></button>
        </div>

        <div class="grid grid-cols-6 gap-2 bg-white p-3 rounded-2xl shadow-sm border border-slate-100" id="monthsGrid"></div>

        <div class="overflow-x-auto -mx-4 px-4 pb-2">
            <div class="flex gap-4 w-max">
                <div class="w-64 bg-white rounded-2xl p-4 border-t-4 border-rose-500 shadow-sm">
                    <div class="flex justify-between mb-2"><span class="text-sm font-bold text-slate-600">–§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç</span><i class="ri-tools-fill text-rose-200"></i></div>
                    <div class="text-2xl font-bold text-slate-800" id="bal_repair_end">0.00</div>
                    <div class="mt-2 pt-2 border-t border-slate-50 flex justify-between text-xs">
                        <div>–ù–∞—á: <input type="number" id="bal_repair_start" value="0" class="w-16 border-b bg-transparent font-bold" onchange="calculate()"></div>
                        <div class="text-right"><div class="text-emerald-600">+<span id="disp_repair_col">0</span></div><div class="text-rose-600">-<span id="disp_repair_spent">0</span></div></div>
                    </div>
                </div>
                <div class="w-64 bg-white rounded-2xl p-4 border-t-4 border-emerald-500 shadow-sm">
                    <div class="flex justify-between mb-2"><span class="text-sm font-bold text-slate-600">–§–æ–Ω–¥ –ö–æ—Å–µ–Ω–µ</span><i class="ri-plant-fill text-emerald-200"></i></div>
                    <div class="text-2xl font-bold text-slate-800" id="bal_mowing_end">0.00</div>
                    <div class="mt-2 pt-2 border-t border-slate-50 flex justify-between text-xs">
                        <div>–ù–∞—á: <input type="number" id="bal_mowing_start" value="0" class="w-16 border-b bg-transparent font-bold" onchange="calculate()"></div>
                        <div class="text-right"><div class="text-emerald-600">+<span id="disp_mowing_col">0</span></div><div class="text-rose-600">-<span id="disp_mowing_spent">0</span></div></div>
                    </div>
                </div>
                 <div class="w-64 bg-white rounded-2xl p-4 border-t-4 border-violet-500 shadow-sm">
                    <div class="flex justify-between mb-2"><span class="text-sm font-bold text-slate-600">–Ø–º–∞</span><i class="ri-drop-fill text-violet-200"></i></div>
                    <div class="text-2xl font-bold text-slate-800" id="bal_septic_end">0.00</div>
                    <div class="mt-2 pt-2 border-t border-slate-50 flex justify-between text-xs">
                        <div>–ù–∞—á: <input type="number" id="bal_septic_start" value="0" class="w-16 border-b bg-transparent font-bold" onchange="calculate()"></div>
                        <div class="text-right"><div class="text-emerald-600">+<span id="disp_septic_col">0</span></div><div class="text-rose-600">-<span id="disp_septic_spent">0</span></div></div>
                    </div>
                </div>
                 <div class="w-64 bg-white rounded-2xl p-4 border-t-4 border-amber-500 shadow-sm">
                    <div class="flex justify-between mb-2"><span class="text-sm font-bold text-slate-600">–ö–æ–º–ø–ª–µ–∫—Å</span><i class="ri-community-fill text-amber-200"></i></div>
                    <div class="text-2xl font-bold text-slate-800" id="bal_complex_end">0.00</div>
                    <div class="mt-2 pt-2 border-t border-slate-50 flex justify-between text-xs">
                        <div>–ù–∞—á: <input type="number" id="bal_complex_start" value="0" class="w-16 border-b bg-transparent font-bold" onchange="calculate()"></div>
                        <div class="text-right"><div class="text-emerald-600">+<span id="disp_complex_col">0</span></div><div class="text-rose-600">-<span id="disp_complex_spent">0</span></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 relative">
            <div class="absolute -top-6 right-0 text-[10px] text-slate-400 font-bold uppercase tracking-wider bg-slate-100 px-2 py-1 rounded" id="inputHint">–í—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏ (BGN)</div>
            
            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm space-y-2">
                <h3 class="text-xs font-bold text-blue-600 uppercase">‚ö° –û–±—â–∏</h3>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–¢–æ–∫ –í—Ö–æ–¥</span><input id="c_tok_vhod" type="number" value="19.21" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–¢–æ–∫ –ê—Å.</span><input id="c_tok_lift" type="number" value="56.89" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–ê–±–æ–Ω–∞—Ç–Ω–∞</span><input id="c_tok_abonatna" type="number" value="101.56" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–ê—Å.–¢–∞–∫—Å–∞</span><input id="c_lift_month" type="number" value="75.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–ß–∏—Å—Ç–∞—á</span><input id="c_clean_vhod" type="number" value="140.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm space-y-2">
                <h3 class="text-xs font-bold text-blue-600 uppercase">üîß –ì–æ–¥–∏—à–Ω–∏</h3>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–ê—Å.–í—Ä—ä–∑–∫–∞</span><input id="c_lift_conn" type="number" value="72.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors" onchange="calculate()"></div>
                <div class="text-right text-[10px] text-blue-400" id="hint_conn"></div>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–ê—Å.–ü—Ä–µ–≥–ª–µ–¥</span><input id="c_lift_tech" type="number" value="90.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors" onchange="calculate()"></div>
                <div class="text-right text-[10px] text-blue-400" id="hint_tech"></div>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm space-y-2">
                <h3 class="text-xs font-bold text-amber-600 uppercase">üöó –ì–∞—Ä–∞–∂</h3>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–¢–æ–∫</span><input id="c_tok_garaj" type="number" value="60.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ</span><input id="c_clean_garaj" type="number" value="175.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm space-y-2">
                <h3 class="text-xs font-bold text-emerald-600 uppercase">üå± –î—Ä—É–≥–∏</h3>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–ö–æ—Å–µ–Ω–µ</span><input id="c_mowing" type="number" value="100.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–Ø–º–∞</span><input id="c_septic" type="number" value="100.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–ö–æ–º–ø–ª–µ–∫—Å</span><input id="c_clean_complex" type="number" value="80.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
                <div class="flex justify-between"><span class="text-xs text-slate-500">–†–µ–º–æ–Ω—Ç</span><input id="c_repair" type="number" value="200.00" class="w-16 text-right bg-slate-50 rounded text-sm font-bold transition-colors"></div>
            </div>
        </div>

        <button onclick="calculate()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition">
            <i class="ri-calculator-fill mr-2"></i> –ò–ó–ß–ò–°–õ–ò (–õ–æ–∫–∞–ª–Ω–æ)
        </button>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="mainTable">
                    <thead class="bg-slate-800 text-white text-xs uppercase font-bold sticky top-0 z-20">
                        <tr>
                            <th class="px-3 py-3 sticky-col text-slate-900 bg-white border-r min-w-[80px]">–ê–ø.</th>
                            <th class="px-3 py-3 min-w-[120px]">–ò–º–µ</th>
                            <th class="px-1 py-3 w-8">–ß</th>
                            <th class="px-1 py-3 w-8">–ì</th>
                            <th class="px-1 py-3 w-12 text-center">EV</th>
                            <th class="px-2 py-3 bg-slate-100 text-slate-600">–°–ú–ï–¢–ö–ê</th>
                            <th class="px-2 py-3 text-rose-300">–°–¢–ê–†</th>
                            <th class="px-2 py-3">–û–ë–©–û</th>
                            <th class="px-3 py-3 min-w-[140px]">–°—Ç–∞—Ç—É—Å</th>
                            <th class="px-3 py-3 min-w-[100px]">–ò–Ω—Ñ–æ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100"></tbody>
                    <tfoot class="bg-slate-50 font-bold text-slate-800 border-t">
                        <tr>
                            <td colspan="7" class="px-4 py-3 text-right">–¢–û–¢–ê–õ <span class="currency-symbol"></span>:</td>
                            <td class="px-2 py-3 text-lg text-blue-600" id="sum-grand">0.00</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
             <button onclick="saveData(false, true)" class="bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-500/30 active:scale-95 transition"><i class="ri-save-3-fill mr-1"></i> –õ–æ–∫–∞–ª–µ–Ω –ó–∞–ø–∏—Å</button>
            <button onclick="generateViberMessage()" class="bg-[#7360f2] text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-500/30 active:scale-95 transition"><i class="ri-chat-3-fill mr-1"></i> Viber</button>
            <button onclick="startNewMonth()" class="col-span-2 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl active:scale-95 transition"><i class="ri-calendar-2-fill mr-1"></i> –ù–æ–≤ –ú–µ—Å–µ—Ü</button>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
            <h3 class="font-bold text-sm mb-3 text-slate-800 uppercase flex items-center gap-2"><i class="ri-list-check-2"></i> –û–ø–∏—Å –Ω–∞ –∏–∑–≤—ä—Ä—à–µ–Ω–∏ –ø–ª–∞—â–∞–Ω–∏—è / —Ä–µ–º–æ–Ω—Ç–∏</h3>
            <div class="flex flex-col gap-2">
                <div class="flex gap-2">
                    <input type="text" id="newExpTitle" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="bg-slate-50 border-slate-200 rounded-lg px-3 py-2 flex-grow text-sm">
                    <input type="number" id="newExpCost" placeholder="–°—É–º–∞" class="bg-slate-50 border-slate-200 rounded-lg px-3 py-2 w-24 text-sm font-bold">
                </div>
                <div class="flex gap-2">
                    <select id="newExpType" class="bg-slate-50 border-slate-200 rounded-lg px-3 py-2 text-sm flex-grow">
                        <option value="repair">–§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç</option>
                        <option value="mowing">–ö–æ—Å–µ–Ω–µ</option>
                        <option value="septic">–Ø–º–∞</option>
                        <option value="complex">–ö–æ–º–ø–ª–µ–∫—Å</option>
                        <option value="other">–î—Ä—É–≥–∏</option>
                    </select>
                    <button onclick="addExpense()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold">OK</button>
                </div>
            </div>
            <table class="w-full text-sm mt-3 border-t border-slate-100" id="expensesTable">
                <tbody class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
            <h3 class="font-bold text-sm mb-3 text-rose-600 uppercase flex items-center gap-2">
                <i class="ri-hammer-line"></i> –°–ü–†–ê–í–ö–ê: –†–ï–ú–û–ù–¢–ò (–ü–æ % –ò–¥. –ß–∞—Å—Ç–∏)
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm" id="repairsBreakdownTable">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                        <tr>
                            <th class="px-2 py-2 text-left">–ê–ø.</th>
                            <th class="px-2 py-2 text-center">% –ò–¥.–ß.</th>
                            <th class="px-2 py-2 text-right">–î—è–ª <span class="currency-symbol"></span></th>
                            <th class="px-2 py-2 text-right">–ü–ª–∞—Ç–∏–ª</th>
                            <th class="px-2 py-2 text-right">–ë–∞–ª–∞–Ω—Å <span class="currency-symbol"></span></th>
                            <th class="px-2 py-2 text-center">–°—Ç–∞—Ç—É—Å</th>
                            <th class="px-2 py-2 text-left">–ë–µ–ª–µ–∂–∫–∞</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">–ë–∞–Ω–∫–æ–≤–∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
            <textarea id="persistentInfo" placeholder="IBAN..." class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm h-32 resize-none"></textarea>
        </div>

    </main>

    <div id="syncModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-slate-800">GitHub Keys</h3>
                <button onclick="document.getElementById('syncModal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
            </div>
            <p class="text-xs text-slate-500 mb-4">–í—ä–≤–µ–¥–µ—Ç–µ –≤–∞—à–∏—Ç–µ GitHub –¥–∞–Ω–Ω–∏, –∑–∞ –¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞—Ç–µ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</p>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">Personal Access Token (PAT)</label>
                    <input id="gh-token" type="password" class="w-full bg-slate-100 p-2 rounded text-sm border focus:border-blue-500 outline-none" placeholder="ghp_...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">Gist ID</label>
                    <input id="gh-gist" type="text" class="w-full bg-slate-100 p-2 rounded text-sm border focus:border-blue-500 outline-none" placeholder="e.g. 8f6d...">
                </div>
                <button onclick="saveGHCreds()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">–ó–∞–ø–∞–∑–∏ –ö–ª—é—á–æ–≤–µ</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">–ö–∞—Å–æ–≤–∞ –ë–µ–ª–µ–∂–∫–∞</h3>
                <button onclick="document.getElementById('reportModal').classList.add('hidden')" class="text-slate-400 text-2xl">&times;</button>
            </div>
            <textarea id="reportText" class="w-full h-80 p-4 bg-slate-50 text-xs font-mono resize-none focus:outline-none leading-relaxed" readonly></textarea>
            <div class="p-4 border-t border-slate-100">
                <button onclick="copyReportText()" class="w-full bg-blue-600 text-white py-2 rounded-xl font-bold">–ö–æ–ø–∏—Ä–∞–π</button>
            </div>
        </div>
    </div>

    <script>
        const fixedApartmentData = [
            { name: "1.1", names: "–°—Ç–µ—Ñ–∞–Ω –î–µ—á–∫–æ–≤", parts: 5.406, people: 2, garage: 1 },
            { name: "1.2", names: "–í–∞–Ω—è –∏ –ò–≤–∞–Ω", parts: 5.248, people: 2, garage: 1 },
            { name: "1.3", names: "", parts: 4.720, people: 0, garage: 1 },
            { name: "1.4", names: "–ì–∞–±—Ä–∏–µ–ª–∞ –∏ –ù–∏–∫–æ–ª–∞", parts: 4.803, people: 2, garage: 1 },
            { name: "2.5", names: "–ê—Ç–∞–Ω–∞—Å –∏ –õ–æ—Ä–∞", parts: 7.228, people: 2, garage: 1 },
            { name: "2.6", names: "", parts: 6.662, people: 1, garage: 1 },
            { name: "2.7", names: "–ò–≤–∞–π–ª–æ –ê–Ω–≥–µ–ª–æ–≤", parts: 6.457, people: 1, garage: 1 },
            { name: "2.8", names: "–Ø–Ω–∞ –∏ –î–µ–π–≤–∏–¥", parts: 6.562, people: 2, garage: 1 },
            { name: "3.9", names: "–õ—é–±–∞ –∏ –ú–∏—Ä–æ—Å–ª–∞–≤–∞", parts: 7.228, people: 2, garage: 0 },
            { name: "3.10", names: "–ê–Ω—Ç–æ–Ω–∏—è –∏ –ú–∞—Ä—Ç–∏–Ω", parts: 6.662, people: 2, garage: 2 },
            { name: "3.11", names: "–¶–≤–µ—Ç–µ–ª–∏–Ω–∞ –°—Ç–æ—è–Ω–æ–≤–∞", parts: 6.457, people: 1, garage: 1 },
            { name: "3.12", names: "–ï–º–∏–ª–∏—è–Ω", parts: 6.562, people: 2, garage: 2 },
            { name: "4.13", names: "–ñ–æ—Ä–æ –î–µ—Å–ø–æ—Ç–æ–≤", parts: 7.510, people: 2, garage: 1 },
            { name: "4.14", names: "–ö—Ä–∏—Å–∏—è–Ω", parts: 4.907, people: 2, garage: 1 },
            { name: "4.15", names: "Yosif Danchev", parts: 10.929, people: 1, garage: 2 },
            { name: "5.16", names: "–ò–≤–∞–π–ª–æ", parts: 2.660, people: 1, garage: 0 }
        ];

        let expenses = [];
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let currentCurrency = 'BGN'; 
        const EUR_RATE = 1.95583;
        const GH_KEY = 'Condo_GH_Creds';

        const currencyInputs = [
            'c_tok_vhod', 'c_tok_lift', 'c_tok_abonatna', 'c_lift_month', 'c_lift_conn', 'c_lift_tech', 'c_clean_vhod',
            'c_tok_garaj', 'c_clean_garaj', 'c_mowing', 'c_septic', 'c_clean_complex', 'c_repair',
            'bal_repair_start', 'bal_mowing_start', 'bal_septic_start', 'bal_complex_start',
            'newExpCost'
        ];

        window.onload = function() {
            updateHiddenInput();
            renderDatePicker();
            
            // Load credentials
            const c = JSON.parse(localStorage.getItem(GH_KEY) || '{}');
            document.getElementById('gh-token').value = c.token || '';
            document.getElementById('gh-gist').value = c.gist || '';

            loadData(); // Load local storage initially
            updateMonthlyHints();
        };

        // --- GITHUB SYNC LOGIC ---
        function saveGHCreds() {
            const token = document.getElementById('gh-token').value;
            const gist = document.getElementById('gh-gist').value;
            localStorage.setItem(GH_KEY, JSON.stringify({token, gist}));
            alert('–ö–ª—é—á–æ–≤–µ—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏ –ª–æ–∫–∞–ª–Ω–æ!');
            document.getElementById('syncModal').classList.add('hidden');
        }

        async function pullFromGitHub() {
            const c = JSON.parse(localStorage.getItem(GH_KEY) || '{}');
            if(!c.token || !c.gist) return alert("–ú–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ Token –∏ Gist ID –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ.");
            
            const btn = document.getElementById('btn-pull');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="loader"></div>`;
            
            try {
                // Fetch Gist
                const req = await fetch(`https://api.github.com/gists/${c.gist}`, {
                    headers: { 'Authorization': `token ${c.token}` }
                });
                if(!req.ok) throw new Error("GitHub Error");
                const json = await req.json();
                
                // We expect a file named "block7d.json"
                const content = json.files['block7d.json'].content;
                const cloudData = JSON.parse(content);
                
                // Save specific month data from cloud to local
                const currentKey = `condo_${document.getElementById('reportDate').value}`;
                localStorage.setItem(currentKey, JSON.stringify(cloudData));
                
                loadData(); // Reload UI
                alert('–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∏–∑—Ç–µ–≥–ª–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ!');
            } catch(e) {
                alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç–µ–≥–ª–µ–Ω–µ: " + e.message);
            } finally {
                btn.innerHTML = originalText;
            }
        }

        async function pushToGitHub() {
            const c = JSON.parse(localStorage.getItem(GH_KEY) || '{}');
            if(!c.token || !c.gist) return alert("–ú–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ Token –∏ Gist ID –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ.");
            
            // Make sure we have latest local data saved
            saveData(true, true); 
            const currentKey = `condo_${document.getElementById('reportDate').value}`;
            const dataToPush = localStorage.getItem(currentKey);

            const btn = document.getElementById('btn-push');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="loader"></div>`;

            try {
                const req = await fetch(`https://api.github.com/gists/${c.gist}`, {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `token ${c.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ files: { "block7d.json": { content: dataToPush } } })
                });
                if(!req.ok) throw new Error("GitHub Error");
                alert('–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∫–∞—á–µ–Ω–∏ –≤ –æ–±–ª–∞–∫–∞!');
            } catch(e) {
                alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–∞—á–≤–∞–Ω–µ: " + e.message);
            } finally {
                btn.innerHTML = originalText;
            }
        }

        // --- CORE APP LOGIC ---
        function toggleCurrency() {
            let valuesBGN = {};
            currencyInputs.forEach(id => { valuesBGN[id] = val(id); });
            
            let tableDebts = [];
            document.querySelectorAll('.inp-old-debt').forEach(el => { let v = parseFloat(el.value) || 0; if(currentCurrency === 'EUR') v = v * EUR_RATE; tableDebts.push(v); });
             let tableEV = [];
            document.querySelectorAll('.inp-ev').forEach(el => { let v = parseFloat(el.value) || 0; if(currentCurrency === 'EUR') v = v * EUR_RATE; tableEV.push(v); });
            let repairPaidList = [];
            document.querySelectorAll('.inp-repair-paid').forEach(el => { let v = parseFloat(el.value) || 0; if(currentCurrency === 'EUR') v = v * EUR_RATE; repairPaidList.push(v); });

            currentCurrency = currentCurrency === 'BGN' ? 'EUR' : 'BGN';
            document.getElementById('currencyLabel').innerText = currentCurrency;
            document.getElementById('inputHint').innerText = `–í—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏ (${currentCurrency})`;
            
            if(currentCurrency === 'EUR') {
                document.getElementById('bodyRoot').classList.remove('mode-bgn');
                document.getElementById('bodyRoot').classList.add('mode-eur');
            } else {
                document.getElementById('bodyRoot').classList.remove('mode-eur');
                document.getElementById('bodyRoot').classList.add('mode-bgn');
            }

            const factor = currentCurrency === 'EUR' ? (1/EUR_RATE) : 1;
            currencyInputs.forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).value = (valuesBGN[id] * factor).toFixed(2);
            });
            document.querySelectorAll('.inp-old-debt').forEach((el, i) => { el.value = (tableDebts[i] * factor).toFixed(2); });
            document.querySelectorAll('.inp-ev').forEach((el, i) => { el.value = (tableEV[i] * factor).toFixed(2); });
            document.querySelectorAll('.inp-repair-paid').forEach((el, i) => { el.value = (repairPaidList[i] * factor).toFixed(2); });
            calculate(); renderExpenses();
        }

        function val(id) { let v = parseFloat(document.getElementById(id).value) || 0; if(currentCurrency === 'EUR') return v * EUR_RATE; return v; }
        function valEl(el) { let v = parseFloat(el.value) || 0; if(currentCurrency === 'EUR') return v * EUR_RATE; return v; }

        function updateMonthlyHints() {
            document.getElementById('hint_conn').innerText = `(${ (val('c_lift_conn')/12).toFixed(2) }/–º)`;
            document.getElementById('hint_tech').innerText = `(${ (val('c_lift_tech')/12).toFixed(2) }/–º)`;
        }

        function renderDatePicker() {
            document.getElementById('displayYear').innerText = currentYear;
            const grid = document.getElementById('monthsGrid');
            grid.innerHTML = '';
            ["–Ø–Ω—É", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–Æ–Ω–∏", "–Æ–ª–∏", "–ê–≤–≥", "–°–µ–ø", "–û–∫—Ç", "–ù–æ–µ", "–î–µ–∫"].forEach((name, index) => {
                const btn = document.createElement('button');
                btn.className = `p-2 rounded-lg text-sm font-bold transition ${index + 1 === currentMonth ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`;
                btn.innerText = name;
                btn.onclick = () => { currentMonth = index + 1; updateHiddenInput(); renderDatePicker(); loadData(); };
                grid.appendChild(btn);
            });
        }
        function changeYear(d) { currentYear += d; updateHiddenInput(); renderDatePicker(); loadData(); }
        function updateHiddenInput() { document.getElementById('reportDate').value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`; }

        function renderTable(savedData) {
            const tbody = document.querySelector('#mainTable tbody');
            tbody.innerHTML = '';
            const factor = currentCurrency === 'EUR' ? (1/EUR_RATE) : 1;
            
            fixedApartmentData.forEach((fixedApt) => {
                let savedApt = savedData ? savedData.find(s => s.name === fixedApt.name) : null;
                const ownerNames = savedApt ? (savedApt.names || fixedApt.names) : fixedApt.names;
                const people = savedApt ? savedApt.people : fixedApt.people;
                const garageCells = savedApt ? savedApt.garageCells : fixedApt.garage;
                const oldDebt = (savedApt ? savedApt.oldDebt : 0) * factor;
                const evCost = (savedApt ? (savedApt.evCost || 0) : 0) * factor;
                const status = savedApt ? savedApt.status : 'unpaid';
                const comment = savedApt ? savedApt.comment : '';

                const tr = document.createElement('tr');
                tr.className = status === 'paid' ? "bg-emerald-50/50" : "";
                tr.innerHTML = `
                    <td class="px-3 py-2 sticky-col bg-white border-r">
                        <button onclick="generateReport('${fixedApt.name}')" class="font-bold text-blue-600 hover:bg-blue-100 bg-blue-50 px-2 py-1 rounded text-xs w-full transition">${fixedApt.name}</button>
                        <input type="hidden" class="apt-fixed" value="${fixedApt.name}">
                    </td>
                    <td class="px-2 py-2"><input type="text" class="inp-names w-full bg-transparent text-xs text-slate-700" value="${ownerNames}"></td>
                    <td class="px-1 py-2"><input type="number" class="apt-fixed-input inp-people w-8 bg-slate-100 rounded text-center text-xs p-1" value="${people}"></td>
                    <td class="px-1 py-2"><input type="number" class="apt-fixed-input inp-garage w-8 bg-slate-100 rounded text-center text-xs p-1" value="${garageCells}"></td>
                    <td class="px-1 py-2"><input type="number" class="inp-ev w-12 bg-blue-50 text-blue-700 font-medium rounded text-center text-xs p-1 border border-blue-100 font-bold" value="${evCost.toFixed(2)}"></td>
                    <input type="hidden" class="inp-parts" value="${fixedApt.parts}">
                    <td class="px-2 py-2 text-center text-xs font-medium text-slate-500 bg-slate-50 res-current">0</td>
                    <td class="px-2 py-2"><input type="number" class="inp-old-debt w-14 text-right text-rose-500 font-bold bg-transparent text-xs" value="${oldDebt.toFixed(2)}"></td>
                    <td class="px-2 py-2 text-center font-black text-blue-700 text-sm res-grand-total">0</td>
                    <td class="px-2 py-2 text-center"><select class="status-select text-xs w-full text-center rounded-lg px-2 py-1 cursor-pointer transition ${status==='paid'?'badge-paid':'badge-unpaid'}" onchange="changeStatus(this)"><option value="unpaid">–ù–ï–ü–õ–ê–¢–ï–ù–û</option><option value="paid" ${status==='paid'?'selected':''}>–ü–õ–ê–¢–ï–ù–û</option></select></td>
                    <td class="px-2 py-2"><input type="text" class="inp-comment w-full bg-transparent text-xs text-slate-400" value="${comment}"></td>
                `;
                tbody.appendChild(tr);
            });
            calculate();
        }

        function changeStatus(sel) {
            const row = sel.closest('tr');
            if(sel.value === 'paid') { row.classList.add('bg-emerald-50/50'); sel.className = "status-select text-xs w-full text-center rounded-lg px-2 py-1 cursor-pointer transition badge-paid"; }
            else { row.classList.remove('bg-emerald-50/50'); sel.className = "status-select text-xs w-full text-center rounded-lg px-2 py-1 cursor-pointer transition badge-unpaid"; }
        }

        function calculate() {
            const factor = currentCurrency === 'EUR' ? (1/EUR_RATE) : 1;
            const symbol = currentCurrency === 'EUR' ? '‚Ç¨' : '';
            document.querySelectorAll('.currency-symbol').forEach(el => el.innerText = symbol);

            const liftConnMonthly = val('c_lift_conn') / 12;
            const liftTechMonthly = val('c_lift_tech') / 12;
            const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod');
            const costGarage = val('c_tok_garaj') + val('c_clean_garaj');
            const costMaintenance = val('c_clean_complex') + val('c_mowing') + val('c_septic');
            const costRepairs = val('c_repair');
            
            let totalPeople = 0, totalGarageCells = 0, totalParts = 0;
            document.querySelectorAll('#mainTable tbody tr').forEach(row => {
                totalPeople += parseFloat(row.querySelector('.inp-people').value)||0;
                totalGarageCells += parseFloat(row.querySelector('.inp-garage').value)||0;
                totalParts += parseFloat(row.querySelector('.inp-parts').value)||0;
            });
            const priceGarageCell = totalGarageCells > 0 ? costGarage / totalGarageCells : 0;
            const pricePerPersonCommon = totalPeople > 0 ? costCommon / totalPeople : 0;
            const pricePerPersonMaint = totalPeople > 0 ? costMaintenance / totalPeople : 0;
            const priceRepairPart = totalParts > 0 ? costRepairs / totalParts : 0;

            let G_Grand = 0;
            document.querySelectorAll('#mainTable tbody tr').forEach(row => {
                const aptName = row.querySelector('.apt-fixed').value;
                const people = parseFloat(row.querySelector('.inp-people').value)||0;
                const garage = parseFloat(row.querySelector('.inp-garage').value)||0;
                const parts = parseFloat(row.querySelector('.inp-parts').value)||0;
                const debtBGN = valEl(row.querySelector('.inp-old-debt'));
                const evCostBGN = valEl(row.querySelector('.inp-ev'));
                const isPaid = row.querySelector('.status-select').value === 'paid';

                let oweBaseBGN = 0;
                if(aptName !== '1.3') oweBaseBGN = (people * pricePerPersonCommon) + (people * pricePerPersonMaint) + (parts * priceRepairPart);
                const oweGarageBGN = garage * priceGarageCell;
                const currentTotalBGN = oweBaseBGN + oweGarageBGN + evCostBGN;
                const grandTotalBGN = currentTotalBGN + debtBGN;

                row.querySelector('.res-current').innerText = (currentTotalBGN * factor).toFixed(2);
                row.querySelector('.res-grand-total').innerText = (grandTotalBGN * factor).toFixed(2);
                G_Grand += grandTotalBGN;

                if (isPaid) {
                     updateFundBalance('repair', (parts * priceRepairPart));
                     updateFundBalance('mowing', (people * (val('c_mowing')/totalPeople)));
                     updateFundBalance('septic', (people * (val('c_septic')/totalPeople)));
                     updateFundBalance('complex', (people * (val('c_clean_complex')/totalPeople)));
                }
            });
            document.getElementById('sum-grand').innerText = (G_Grand * factor).toFixed(2);
        }

        function updateFundBalance(type, collectedRealBGN) {
             const factor = currentCurrency === 'EUR' ? (1/EUR_RATE) : 1;
             const startBGN = val(`bal_${type}_start`);
             const spentBGN = expenses.filter(e => e.type === type).reduce((sum, e) => sum + e.cost, 0);
             const endBGN = startBGN + collectedRealBGN - spentBGN;
             if(document.getElementById(`disp_${type}_col`)) document.getElementById(`disp_${type}_col`).innerText = (collectedRealBGN * factor).toFixed(0);
             if(document.getElementById(`disp_${type}_spent`)) document.getElementById(`disp_${type}_spent`).innerText = (spentBGN * factor).toFixed(0);
             if(document.getElementById(`bal_${type}_end`)) document.getElementById(`bal_${type}_end`).innerText = (endBGN * factor).toFixed(2);
        }

        function addExpense() {
            const title = document.getElementById('newExpTitle').value;
            const cost = val('newExpCost'); 
            const type = document.getElementById('newExpType').value;
            if(!title || isNaN(cost)) return;
            expenses.push({title, cost, type}); 
            document.getElementById('newExpTitle').value = '';
            document.getElementById('newExpCost').value = '';
            renderExpenses(); calculate(); refreshRepairsTable();
        }
        function removeExpense(idx) { expenses.splice(idx,1); renderExpenses(); calculate(); refreshRepairsTable(); }
        
        function renderExpenses() {
             const factor = currentCurrency === 'EUR' ? (1/EUR_RATE) : 1;
             const tb = document.querySelector('#expensesTable tbody'); tb.innerHTML = '';
             expenses.forEach((e,i) => {
                 tb.innerHTML += `<tr class="border-b border-slate-50"><td class="py-2 text-slate-700">${e.title}</td><td class="text-xs text-slate-400">${e.type}</td><td class="text-right font-bold text-slate-800">${(e.cost*factor).toFixed(2)}</td><td class="text-right"><button onclick="removeExpense(${i})" class="text-rose-400">&times;</button></td></tr>`;
             });
        }

        function refreshRepairsTable() {
            const totalRepairExpensesBGN = expenses.filter(e => e.type === 'repair').reduce((sum, e) => sum + e.cost, 0);
            const savedString = localStorage.getItem(`condo_${document.getElementById('reportDate').value}`);
            let savedData = savedString ? JSON.parse(savedString).rows : null;
            renderRepairsBreakdown(totalRepairExpensesBGN, savedData);
        }

        function renderRepairsBreakdown(totalRepairExpensesBGN, savedData) {
            const factor = currentCurrency === 'EUR' ? (1/EUR_RATE) : 1;
            const tbody = document.querySelector('#repairsBreakdownTable tbody');
            tbody.innerHTML = '';
            let totalParts = 0;
            fixedApartmentData.forEach(a => totalParts += a.parts);
            fixedApartmentData.forEach((apt) => {
                const shareBGN = (totalRepairExpensesBGN * apt.parts) / totalParts;
                let paidSoFarBGN = 0; let savedRepairStatus = 'unpaid'; let savedNote = '';
                if(savedData) {
                    const savedRow = savedData.find(r => r.name === apt.name);
                    if(savedRow && savedRow.repairPaid) paidSoFarBGN = parseFloat(savedRow.repairPaid);
                    if(savedRow && savedRow.repairStatus) savedRepairStatus = savedRow.repairStatus;
                    if(savedRow && savedRow.repairNote) savedNote = savedRow.repairNote;
                }
                const diffBGN = shareBGN - paidSoFarBGN;
                let colorClass = diffBGN > 0.01 ? 'text-rose-500' : 'text-emerald-500';
                let selectClass = "repair-status-select rounded text-xs py-1 px-1 w-full font-bold " + (savedRepairStatus==='paid'?'rep-paid':savedRepairStatus==='partial'?'rep-partial':'rep-unpaid');
                tbody.innerHTML += `<tr><td class="px-2 py-2 font-bold text-slate-700">${apt.name}</td><td class="px-2 py-2 text-center text-slate-500">${apt.parts}%</td><td class="px-2 py-2 text-right">${(shareBGN * factor).toFixed(2)}</td><td class="px-2 py-2 text-right"><input type="number" class="inp-repair-paid w-16 text-right bg-slate-50 rounded p-1 text-xs" value="${(paidSoFarBGN * factor).toFixed(2)}" onchange="saveData(true); refreshRepairsTable()"></td><td class="px-2 py-2 text-right font-bold ${colorClass}">${(diffBGN * factor).toFixed(2)}</td><td class="px-2 py-2 text-center"><select class="${selectClass}" onchange="updateRepairStatus(this)"><option value="unpaid">–ù–ï</option><option value="partial" ${savedRepairStatus==='partial'?'selected':''}>–ß–ê–°–¢</option><option value="paid" ${savedRepairStatus==='paid'?'selected':''}>–î–ê</option></select></td><td class="px-2 py-2"><input type="text" class="inp-repair-note w-full bg-slate-50 rounded px-2 py-1 text-xs text-slate-600" value="${savedNote}" placeholder="..." onchange="saveData(true)"></td></tr>`;
            });
        }
        function updateRepairStatus(sel) { saveData(true); refreshRepairsTable(); }

        function saveData(silent = false, allowSync = false) {
            const rows = [];
            document.querySelectorAll('#mainTable tbody tr').forEach(r => {
                const aptName = r.querySelector('.apt-fixed').value;
                let repairPaidVal = 0; let repairStatusVal = 'unpaid'; let repairNoteVal = '';
                const breakdownRows = document.querySelectorAll('#repairsBreakdownTable tbody tr');
                for(let br of breakdownRows) {
                    if(br.cells[0].innerText.includes(aptName)) { 
                        repairPaidVal = valEl(br.querySelector('.inp-repair-paid')); 
                        repairStatusVal = br.querySelector('select').value;
                        repairNoteVal = br.querySelector('.inp-repair-note').value;
                        break; 
                    }
                }
                rows.push({
                    name: aptName,
                    names: r.querySelector('.inp-names').value,
                    people: r.querySelector('.inp-people').value,
                    garageCells: r.querySelector('.inp-garage').value,
                    evCost: valEl(r.querySelector('.inp-ev')),
                    oldDebt: valEl(r.querySelector('.inp-old-debt')),
                    status: r.querySelector('.status-select').value,
                    comment: r.querySelector('.inp-comment').value,
                    repairPaid: repairPaidVal,
                    repairStatus: repairStatusVal,
                    repairNote: repairNoteVal
                });
            });
            const inputs = {};
            currencyInputs.forEach(id => { if(document.getElementById(id)) inputs[id] = val(id); });
            const data = { rows, inputs, expenses, info: document.getElementById('persistentInfo').value };
            localStorage.setItem(`condo_${document.getElementById('reportDate').value}`, JSON.stringify(data));
            if(!silent) alert('–ó–∞–ø–∞–∑–µ–Ω–æ –ª–æ–∫–∞–ª–Ω–æ!');
        }

        function loadData() {
            currentCurrency = 'BGN'; 
            document.getElementById('currencyLabel').innerText = 'BGN';
            document.getElementById('inputHint').innerText = '–í—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏ (BGN)';
            document.getElementById('bodyRoot').classList.remove('mode-eur');
            document.getElementById('bodyRoot').classList.add('mode-bgn');
            const key = `condo_${document.getElementById('reportDate').value}`;
            const stored = localStorage.getItem(key);
            if(stored) {
                const data = JSON.parse(stored);
                expenses = data.expenses || [];
                renderTable(data.rows);
                if(data.inputs) for(let k in data.inputs) if(document.getElementById(k)) document.getElementById(k).value = data.inputs[k];
                if(data.info) document.getElementById('persistentInfo').value = data.info;
                renderExpenses();
                const totalRepairExpenses = expenses.filter(e => e.type === 'repair').reduce((sum, e) => sum + e.cost, 0);
                renderRepairsBreakdown(totalRepairExpenses, data.rows);
            } else {
                expenses = [];
                renderTable(null);
                renderExpenses();
                renderRepairsBreakdown(0, null);
            }
            calculate();
        }

        function generateViberMessage() {
            calculate();
            const dateStr = document.getElementById('reportDate').value;
            let text = `üè¢ *–ë–ª–æ–∫ 7–î | –û—Ç—á–µ—Ç ${dateStr}*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            let totalUnpaid = 0;
            document.querySelectorAll('#mainTable tbody tr').forEach(row => {
                 const apt = row.querySelector('.apt-fixed').value;
                 const name = row.querySelector('.inp-names').value.split(' ')[0];
                 const total = row.querySelector('.res-grand-total').innerText;
                 const isPaid = row.querySelector('.status-select').value === 'paid';
                 if(!isPaid) totalUnpaid += parseFloat(total);
                 text += `${isPaid ? '‚úÖ' : 'üî¥'} –ê–ø.${apt} (${name}): ${total} ${currentCurrency === 'EUR'?'‚Ç¨':'–ª–≤.'}\n`;
            });
            text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ –ó–∞ —Å—ä–±–∏—Ä–∞–Ω–µ: ${totalUnpaid.toFixed(2)} ${currentCurrency === 'EUR'?'‚Ç¨':'–ª–≤.'}\n`;
            document.getElementById('reportText').value = text;
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function copyReportText() { const el = document.getElementById('reportText'); el.select(); navigator.clipboard.writeText(el.value).then(() => alert('–ö–æ–ø–∏—Ä–∞–Ω–æ!')); }
        function startNewMonth() { if(confirm('–ù–æ–≤ –º–µ—Å–µ—Ü?')) { saveData(true); currentMonth==12? (currentMonth=1, currentYear++) : currentMonth++; updateHiddenInput(); renderDatePicker(); loadData(); }}
        
        function generateReport(aptName) { 
            let wasEur = currentCurrency === 'EUR';
            if(wasEur) toggleCurrency(); 
            calculate();
            const row = Array.from(document.querySelectorAll('#mainTable tbody tr')).find(r => r.querySelector('.apt-fixed').value === aptName);
            if(!row) { if(wasEur) toggleCurrency(); return; }
            const name = row.querySelector('.inp-names').value;
            const people = parseFloat(row.querySelector('.inp-people').value)||0;
            const garage = parseFloat(row.querySelector('.inp-garage').value)||0;
            const parts = parseFloat(row.querySelector('.inp-parts').value)||0;
            const evCost = parseFloat(row.querySelector('.inp-ev').value)||0;
            const isPaid = row.querySelector('.status-select').value === 'paid';
            const dateStr = document.getElementById('reportDate').value;
            let totalPeople = 0, totalGarageCells = 0, totalParts = 0;
            document.querySelectorAll('#mainTable tbody tr').forEach(r => {
                totalPeople += parseFloat(r.querySelector('.inp-people').value)||0;
                totalGarageCells += parseFloat(r.querySelector('.inp-garage').value)||0;
                totalParts += parseFloat(r.querySelector('.inp-parts').value)||0;
            });
            const liftConnMonthly = val('c_lift_conn') / 12;
            const liftTechMonthly = val('c_lift_tech') / 12;
            const costCommon = val('c_tok_vhod') + val('c_tok_lift') + val('c_tok_abonatna') + val('c_lift_month') + liftConnMonthly + liftTechMonthly + val('c_clean_vhod');
            const costGarageTotal = val('c_tok_garaj') + val('c_clean_garaj');
            const costMaintenance = val('c_clean_complex') + val('c_mowing') + val('c_septic');
            const costRepairs = val('c_repair');
            const priceGarage = totalGarageCells > 0 ? costGarageTotal / totalGarageCells : 0;
            const priceCommon = totalPeople > 0 ? costCommon / totalPeople : 0;
            const priceMaint = totalPeople > 0 ? costMaintenance / totalPeople : 0;
            const priceRepair = totalParts > 0 ? costRepairs / totalParts : 0;
            const aptCommon = people * priceCommon;
            const aptMaint = people * priceMaint;
            const aptRepair = parts * priceRepair;
            const aptGarage = garage * priceGarage;
            const debt = parseFloat(row.querySelector('.inp-old-debt').value)||0;
            const aptTotalBGN = aptCommon + aptMaint + aptRepair + aptGarage + evCost + debt;
            if(wasEur) toggleCurrency();
            const fmt = (val) => `${val.toFixed(2)} –ª–≤. / ${(val/EUR_RATE).toFixed(2)} ‚Ç¨`;
            let txt = `üè¢ –ö–ê–°–û–í–ê –ë–ï–õ–ï–ñ–ö–ê - –ë–õ–û–ö 7–î\nüóìÔ∏è –ü–µ—Ä–∏–æ–¥: ${dateStr}\nüë§ –ê–ø. ${aptName} (${name})\n----------------------------------------\n`;
            if(aptName !== '1.3' && people > 0) {
                 txt += `‚ö° –û–±—â–∏ (–¢–æ–∫/–ê—Å/–ß–∏—Å—Ç): ${people} x ${priceCommon.toFixed(2)} –ª–≤. = ${fmt(aptCommon)}\n`;
                 txt += `üå± –ü–æ–¥–¥—Ä—ä–∂–∫–∞ (–ö–æ—Å–µ–Ω–µ/–Ø–º–∞): ${people} x ${priceMaint.toFixed(2)} –ª–≤. = ${fmt(aptMaint)}\n`;
                 txt += `üõ†Ô∏è –§–æ–Ω–¥ –†–µ–º–æ–Ω—Ç (${parts}%): ${fmt(aptRepair)}\n`;
            } else if(aptName === '1.3') { txt += `‚ÑπÔ∏è –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç 1.3 –µ –æ—Å–≤–æ–±–æ–¥–µ–Ω –æ—Ç —Ç–∞–∫—Å–∏.\n`; }
            if(garage > 0) txt += `üöó –ì–∞—Ä–∞–∂ (–¢–æ–∫/–ü–æ—á): ${garage} –±—Ä. x ${priceGarage.toFixed(2)} –ª–≤. = ${fmt(aptGarage)}\n`;
            if(evCost > 0) txt += `üîå –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –ï–ª. (EV): ${fmt(evCost)}\n`;
            if(debt > 0) txt += `‚ö†Ô∏è –°—Ç–∞—Ä–∏ –∑–∞–¥—ä–ª–∂–µ–Ω–∏—è: ${fmt(debt)}\n`;
            txt += `----------------------------------------\nüí∞ –û–ë–©–û –ó–ê –ü–õ–ê–©–ê–ù–ï: ${fmt(aptTotalBGN)}\nüìù –°–¢–ê–¢–£–°: ${isPaid ? '‚úÖ –ü–õ–ê–¢–ï–ù–û' : '‚ùå –ù–ï–ü–õ–ê–¢–ï–ù–û'}`;
            document.getElementById('reportText').value = txt;
            document.getElementById('reportModal').classList.remove('hidden');
        }
    </script>
</body>
</html>
